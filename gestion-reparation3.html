<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Watch Repair Plus - Gestion SAV</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- Babel pour JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Styles pour l'impression et scrollbars -->
    <style>
        @media print {
            .no-print { display: none !important; }
            body { background: white; color: black; }
            #root { height: auto; overflow: visible; }
            main { overflow: visible !important; }
        }
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        .dark ::-webkit-scrollbar-thumb { background: #475569; }
        .dark ::-webkit-scrollbar-thumb:hover { background: #64748b; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useContext, createContext } = React;

        // --- ICON SYSTEM (STANDALONE REPLACEMENT FOR LUCIDE-REACT) ---
        // Definition locale des icônes pour éviter les dépendances de build complexes
        
        const IconWrapper = ({ size = 24, className = "", children, ...props }) => (
            <svg 
                xmlns="http://www.w3.org/2000/svg" 
                width={size} 
                height={size} 
                viewBox="0 0 24 24" 
                fill="none" 
                stroke="currentColor" 
                strokeWidth="2" 
                strokeLinecap="round" 
                strokeLinejoin="round" 
                className={className} 
                {...props}
            >
                {children}
            </svg>
        );

        const Icons = {
            Menu: (p) => <IconWrapper {...p}><line x1="4" x2="20" y1="12" y2="12"/><line x1="4" x2="20" y1="6" y2="6"/><line x1="4" x2="20" y1="18" y2="18"/></IconWrapper>,
            X: (p) => <IconWrapper {...p}><path d="M18 6 6 18"/><path d="m6 6 12 12"/></IconWrapper>,
            ChevronRight: (p) => <IconWrapper {...p}><path d="m9 18 6-6-6-6"/></IconWrapper>,
            ChevronLeft: (p) => <IconWrapper {...p}><path d="m15 18-6-6 6-6"/></IconWrapper>,
            Check: (p) => <IconWrapper {...p}><path d="M20 6 9 17l-5-5"/></IconWrapper>,
            AlertTriangle: (p) => <IconWrapper {...p}><path d="m21.73 18-8-14a2 2 0 0 0-3.48 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3Z"/><path d="M12 9v4"/><path d="M12 17h.01"/></IconWrapper>,
            Watch: (p) => <IconWrapper {...p}><circle cx="12" cy="12" r="6"/><polyline points="12 10 12 12 13 13"/><path d="m16.13 7.66-.81-4.05a2 2 0 0 0-2.53-1.46L10.5 2.5"/><path d="m8 16.29.6 3.65a2 2 0 0 0 2.25 1.63L13.5 21"/></IconWrapper>,
            Archive: (p) => <IconWrapper {...p}><rect width="20" height="5" x="2" y="3" rx="1"/><path d="M4 8v11a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8"/><path d="M10 12h4"/></IconWrapper>,
            UserPlus: (p) => <IconWrapper {...p}><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><line x1="19" x2="19" y1="8" y2="14"/><line x1="22" x2="16" y1="11" y2="11"/></IconWrapper>,
            FileSearch: (p) => <IconWrapper {...p}><path d="M14 2v4a2 2 0 0 0 2 2h4"/><path d="M4.268 21a2 2 0 0 0 1.727 1H18a2 2 0 0 0 2-2V7l-5-5H6a2 2 0 0 0-2 2v3"/><path d="m9 18-1.5-1.5"/><circle cx="5" cy="14" r="3"/></IconWrapper>,
            ClipboardCheck: (p) => <IconWrapper {...p}><rect width="8" height="4" x="8" y="2" rx="1" ry="1"/><path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"/><path d="m9 14 2 2 4-4"/></IconWrapper>,
            DollarSign: (p) => <IconWrapper {...p}><line x1="12" x2="12" y1="2" y2="22"/><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/></IconWrapper>,
            Wrench: (p) => <IconWrapper {...p}><path d="M14.7 6.3a1 1 0 0 0 0 1.4l1.6 1.6a1 1 0 0 0 1.4 0l3.77-3.77a6 6 0 0 1-7.94 7.94l-6.91 6.91a2.12 2.12 0 0 1-3-3l6.91-6.91a6 6 0 0 1 7.94-7.94l-3.76 3.76z"/></IconWrapper>,
            Gift: (p) => <IconWrapper {...p}><rect x="3" y="8" width="18" height="4" rx="1"/><path d="M12 8v13"/><path d="M19 12v7a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2v-7"/><path d="M7.5 8a2.5 2.5 0 0 1 0-5A4.8 8 0 0 1 12 8a4.8 8 0 0 1 4.5-5 2.5 2.5 0 0 1 0 5"/></IconWrapper>,
            BookOpen: (p) => <IconWrapper {...p}><path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"/><path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"/></IconWrapper>,
            Printer: (p) => <IconWrapper {...p}><polyline points="6 9 6 2 18 2 18 9"/><path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2"/><rect width="12" height="8" x="6" y="14"/></IconWrapper>,
            Sun: (p) => <IconWrapper {...p}><circle cx="12" cy="12" r="4"/><path d="M12 2v2"/><path d="M12 20v2"/><path d="m4.93 4.93 1.41 1.41"/><path d="m17.66 17.66 1.41 1.41"/><path d="M2 12h2"/><path d="M20 12h2"/><path d="m6.34 17.66-1.41 1.41"/><path d="m19.07 4.93-1.41 1.41"/></IconWrapper>,
            Moon: (p) => <IconWrapper {...p}><path d="M12 3a6 6 0 0 0 9 9 9 9 0 1 1-9-9Z"/></IconWrapper>,
            Plus: (p) => <IconWrapper {...p}><path d="M5 12h14"/><path d="M12 5v14"/></IconWrapper>,
            Trash2: (p) => <IconWrapper {...p}><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/><line x1="10" x2="10" y1="11" y2="17"/><line x1="14" x2="14" y1="11" y2="17"/></IconWrapper>,
            Camera: (p) => <IconWrapper {...p}><path d="M14.5 4h-5L7 7H4a2 2 0 0 0-2 2v9a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2V9a2 2 0 0 0-2-2h-3l-2.5-3z"/><circle cx="12" cy="13" r="3"/></IconWrapper>,
            Search: (p) => <IconWrapper {...p}><circle cx="11" cy="11" r="8"/><path d="m21 21-4.3-4.3"/></IconWrapper>,
            ChevronsRight: (p) => <IconWrapper {...p}><path d="m7 7 5 5-5 5"/><path d="m13 7 5 5-5 5"/></IconWrapper>,
            ArrowRightCircle: (p) => <IconWrapper {...p}><circle cx="12" cy="12" r="10"/><path d="M8 12h8"/><path d="m12 16 4-4-4-4"/></IconWrapper>,
            ArrowLeftCircle: (p) => <IconWrapper {...p}><circle cx="12" cy="12" r="10"/><path d="M16 12H8"/><path d="m12 8-4 4 4 4"/></IconWrapper>,
            ListChecks: (p) => <IconWrapper {...p}><path d="m3 17 2 2 4-4"/><path d="m3 7 2 2 4-4"/><path d="M13 6h8"/><path d="M13 12h8"/><path d="M13 18h8"/></IconWrapper>,
            ShieldCheck: (p) => <IconWrapper {...p}><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10"/><path d="m9 12 2 2 4-4"/></IconWrapper>,
            Factory: (p) => <IconWrapper {...p}><path d="M2 20a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2V8l-7 5V8l-7 5V4a2 2 0 0 0-2-2H4a2 2 0 0 0-2 2Z"/><path d="M17 18h1"/><path d="M12 18h1"/><path d="M7 18h1"/></IconWrapper>,
            CheckSquare: (p) => <IconWrapper {...p}><polyline points="9 11 12 14 22 4"/><path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"/></IconWrapper>,
            Settings: (p) => <IconWrapper {...p}><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.09a2 2 0 0 1-1-1.74v-.47a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.39a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"/><circle cx="12" cy="12" r="3"/></IconWrapper>,
            CheckCircle: (p) => <IconWrapper {...p}><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></IconWrapper>,
            Lightbulb: (p) => <IconWrapper {...p}><path d="M15 14c.2-1 .7-1.7 1.5-2.5 1-1 1.5-2 1.5-3.5 0-3-2.5-5-5-5s-5 2-5 5c0 1.5.5 2.5 1.5 3.5.8.8 1.3 1.5 1.5 2.5"/><path d="M9 18h6"/><path d="M10 22h4"/></IconWrapper>,
            PenTool: (p) => <IconWrapper {...p}><path d="m12 19 7-7 3 3-7 7-3-3z"/><path d="m18 13-1.5-7.5L2 2l3.5 14.5L13 18l5-5z"/><path d="m2 2 7.586 7.586"/><circle cx="11" cy="11" r="2"/></IconWrapper>,
            AlertOctagon: (p) => <IconWrapper {...p}><polygon points="7.86 2 16.14 2 22 7.86 22 16.14 16.14 22 7.86 22 2 16.14 2 7.86 7.86 2"/><line x1="12" x2="12" y1="8" y2="12"/><line x1="12" x2="12.01" y1="16" y2="16"/></IconWrapper>,
            TrendingDown: (p) => <IconWrapper {...p}><polyline points="23 18 13.5 8.5 8.5 13.5 1 6"/><polyline points="17 18 23 18 23 12"/></IconWrapper>,
            ShieldAlert: (p) => <IconWrapper {...p}><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10"/><line x1="12" x2="12" y1="8" y2="12"/><line x1="12" x2="12.01" y1="16" y2="16"/></IconWrapper>,
            Package: (p) => <IconWrapper {...p}><path d="m16.5 9.4-9-5.19"/><path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"/><polyline points="3.27 6.96 12 12.01 20.73 6.96"/><line x1="12" x2="12" y1="22.08" y2="12"/></IconWrapper>,
            FileCheck: (p) => <IconWrapper {...p}><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/><polyline points="14 2 14 8 20 8"/><path d="m9 15 2 2 4-4"/></IconWrapper>,
            Star: (p) => <IconWrapper {...p}><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/></IconWrapper>,
            Clock: (p) => <IconWrapper {...p}><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></IconWrapper>,
            FileText: (p) => <IconWrapper {...p}><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/><polyline points="14 2 14 8 20 8"/><line x1="16" x2="8" y1="13" y2="13"/><line x1="16" x2="8" y1="17" y2="17"/><line x1="10" x2="8" y1="9" y2="9"/></IconWrapper>,
            Save: (p) => <IconWrapper {...p}><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></IconWrapper>,
            Lock: (p) => <IconWrapper {...p}><rect x="3" y="11" width="18" height="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></IconWrapper>,
            Edit3: (p) => <IconWrapper {...p}><path d="M12 20h9"/><path d="M16.5 3.5a2.12 2.12 0 0 1 3 3L7 19l-4 1 1-4Z"/></IconWrapper>,
            ArrowRight: (p) => <IconWrapper {...p}><line x1="5" x2="19" y1="12" y2="12"/><polyline points="12 5 19 12 12 19"/></IconWrapper>,
            BarChart2: (p) => <IconWrapper {...p}><line x1="18" x2="18" y1="20" y2="10"/><line x1="12" x2="12" y1="20" y2="4"/><line x1="6" x2="6" y1="20" y2="14"/></IconWrapper>,
            Calendar: (p) => <IconWrapper {...p}><rect width="18" height="18" x="3" y="4" rx="2" ry="2"/><line x1="16" x2="16" y1="2" y2="6"/><line x1="8" x2="8" y1="2" y2="6"/><line x1="3" x2="21" y1="10" y2="10"/></IconWrapper>,
            Info: (p) => <IconWrapper {...p}><circle cx="12" cy="12" r="10"/><line x1="12" x2="12" y1="16" y2="12"/><line x1="12" x2="12.01" y1="8" y2="8"/></IconWrapper>,
            Calculator: (p) => <IconWrapper {...p}><rect width="16" height="20" x="4" y="2" rx="2"/><line x1="8" x2="16" y1="6" y2="6"/><line x1="16" x2="16" y1="14" y2="18"/><path d="M16 10h.01"/><path d="M12 10h.01"/><path d="M8 10h.01"/><path d="M12 14h.01"/><path d="M8 14h.01"/><path d="M12 18h.01"/><path d="M8 18h.01"/></IconWrapper>,
            HelpCircle: (p) => <IconWrapper {...p}><circle cx="12" cy="12" r="10"/><path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"/><path d="M12 17h.01"/></IconWrapper>,
            MoreHorizontal: (p) => <IconWrapper {...p}><circle cx="12" cy="12" r="1"/><circle cx="19" cy="12" r="1"/><circle cx="5" cy="12" r="1"/></IconWrapper>,
            LogOut: (p) => <IconWrapper {...p}><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" x2="9" y1="12" y2="12"/></IconWrapper>,
            UploadCloud: (p) => <IconWrapper {...p}><polyline points="16 16 12 12 8 16"/><line x1="12" x2="12" y1="12" y2="21"/><path d="M20.39 18.39A5 5 0 0 0 18 9h-1.26A8 8 0 1 0 3 16.3"/><polyline points="16 16 12 12 8 16"/></IconWrapper>,
            MapPin: (p) => <IconWrapper {...p}><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0Z"/><circle cx="12" cy="10" r="3"/></IconWrapper>,
            Timer: (p) => <IconWrapper {...p}><line x1="10" x2="14" y1="2" y2="2"/><line x1="12" x2="15" y1="14" y2="11"/><circle cx="12" cy="14" r="8"/></IconWrapper>,
            PauseCircle: (p) => <IconWrapper {...p}><circle cx="12" cy="12" r="10"/><line x1="10" x2="10" y1="15" y2="9"/><line x1="14" x2="14" y1="15" y2="9"/></IconWrapper>,
            PlayCircle: (p) => <IconWrapper {...p}><circle cx="12" cy="12" r="10"/><polygon points="10 8 16 12 10 16 10 8"/></IconWrapper>,
            CreditCard: (p) => <IconWrapper {...p}><rect width="20" height="14" x="2" y="5" rx="2"/><line x1="2" x2="22" y1="10" y2="10"/></IconWrapper>,
            Briefcase: (p) => <IconWrapper {...p}><rect width="20" height="14" x="2" y="7" rx="2" ry="2"/><path d="M16 21V5a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v16"/></IconWrapper>,
            Layout: (p) => <IconWrapper {...p}><rect width="18" height="18" x="3" y="3" rx="2" ry="2"/><line x1="3" x2="21" y1="9" y2="9"/><line x1="9" x2="9" y1="21" y2="9"/></IconWrapper>,
            GitMerge: (p) => <IconWrapper {...p}><circle cx="18" cy="18" r="3"/><circle cx="6" cy="6" r="3"/><path d="M6 21V9a9 9 0 0 0 9 9"/></IconWrapper>,
            Truck: (p) => <IconWrapper {...p}><path d="M10 17h4V5H2v12h3"/><path d="M20 17h2v-3.34a4 4 0 0 0-1.17-2.83L19 9h-5"/><path d="M14 17h1"/><circle cx="7.5" cy="17.5" r="2.5"/><circle cx="17.5" cy="17.5" r="2.5"/></IconWrapper>,
            Percent: (p) => <IconWrapper {...p}><line x1="19" x2="5" y1="5" y2="19"/><circle cx="6.5" cy="6.5" r="2.5"/><circle cx="17.5" cy="17.5" r="2.5"/></IconWrapper>,
            Hash: (p) => <IconWrapper {...p}><line x1="4" x2="20" y1="9" y2="9"/><line x1="4" x2="20" y1="15" y2="15"/><line x1="10" x2="8" y1="3" y2="21"/><line x1="16" x2="14" y1="3" y2="21"/></IconWrapper>,
            Wifi: (p) => <IconWrapper {...p}><path d="M12.85 14a5 5 0 0 0-5.7 0"/><path d="M16.85 10a9 9 0 0 0-9.7 0"/><path d="M20.85 6a13 13 0 0 0-13.7 0"/><path d="M12 20h.01"/></IconWrapper>,
            WifiOff: (p) => <IconWrapper {...p}><line x1="1" x2="23" y1="1" y2="23"/><path d="M16.85 10a9 9 0 0 0-2.3-1.37"/><path d="M20.85 6a13 13 0 0 0-3.9-2.31"/><path d="M12 20h.01"/><path d="M8.5 16.429a5 5 0 0 1 7 0"/></IconWrapper>,
            Database: (p) => <IconWrapper {...p}><ellipse cx="12" cy="5" rx="9" ry="3"/><path d="M3 5V19A9 3 0 0 0 21 19V5"/><path d="M3 12A9 3 0 0 0 21 12"/></IconWrapper>,
            Book: (p) => <IconWrapper {...p}><path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"/><path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"/></IconWrapper>,
            XCircle: (p) => <IconWrapper {...p}><circle cx="12" cy="12" r="10"/><line x1="15" x2="9" y1="9" y2="15"/><line x1="9" x2="15" y1="9" y2="15"/></IconWrapper>,
            Image: (p) => <IconWrapper {...p}><rect width="18" height="18" x="3" y="3" rx="2" ry="2"/><circle cx="9" cy="9" r="2"/><path d="m21 15-3.086-3.086a2 2 0 0 0-2.828 0L6 21"/></IconWrapper>,
            Download: (p) => <IconWrapper {...p}><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" x2="12" y1="15" y2="3"/></IconWrapper>,
            RefreshCw: (p) => <IconWrapper {...p}><path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8"/><path d="M21 3v5h-5"/><path d="M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16"/><path d="M3 21v-5h5"/></IconWrapper>
        };

        const GenericFallbackIcon = ({ size = 24, className = "", ...props }) => (
            <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={`opacity-50 ${className}`} {...props}>
                <rect x="3" y="3" width="18" height="18" rx="2" ry="2" strokeDasharray="4 2" />
                <text x="12" y="17" textAnchor="middle" fontSize="12" stroke="none" fill="currentColor" fontWeight="bold">?</text>
            </svg>
        );

        const getSafeIcon = (iconName) => {
            return Icons[iconName] || GenericFallbackIcon;
        };

        const SafeIcons = {};
        // Mapping des noms utilisés dans le code original vers notre objet Icons
        const ICON_NAMES = [
            'Clock', 'FileText', 'Settings', 'Search', 'Plus', 'CheckCircle', 'AlertTriangle', 'XCircle', 'Save', 'Printer', 
            'ChevronRight', 'DollarSign', 'Wrench', 'Archive', 'Menu', 'X', 'ClipboardList', 'FileSearch', 'ClipboardCheck', 
            'UserPlus', 'Star', 'Trash2', 'RefreshCw', 'Download', 'CheckSquare', 'Edit3', 'Lock', 'ArrowRight', 'ChevronLeft', 
            'Package', 'BarChart2', 'TrendingDown', 'AlertOctagon', 'Calendar', 'Info', 'Calculator', 'HelpCircle', 
            'MoreHorizontal', 'Sun', 'Moon', 'LogOut', 'Camera', 'Image', 'UploadCloud', 'MapPin', 'BookOpen', 
            'Timer', 'PauseCircle', 'PlayCircle', 'CreditCard', 'Factory', 'Gift', 'PenTool', 'Briefcase', 'Layout', 'GitMerge', 
            'Truck', 'Percent', 'Check', 'Hash', 'ShieldCheck', 'ShieldAlert', 'Lightbulb', 'ListChecks', 'Wifi', 'WifiOff', 
            'Database', 'Book', 'FileCheck', 'ArrowRightCircle', 'ArrowLeftCircle', 'ChevronsRight', 'Watch'
        ];

        ICON_NAMES.forEach(name => {
            const lookupName = name === 'ImageIcon' ? 'Image' : name; 
            SafeIcons[name] = getSafeIcon(lookupName);
        });

        const { 
            Clock, FileText, Settings, Search, Plus, CheckCircle, AlertTriangle, XCircle, Save, Printer, 
            ChevronRight, DollarSign, Wrench, Archive, Menu, X, ClipboardList, FileSearch, ClipboardCheck, 
            UserPlus, Star, Trash2, RefreshCw, Download, CheckSquare, Edit3, Lock, ArrowRight, ChevronLeft, 
            Package, BarChart2, TrendingDown, AlertOctagon, Calendar, Info, Calculator, HelpCircle, 
            MoreHorizontal, Sun, Moon, LogOut, Camera, Image: ImageIcon, UploadCloud, MapPin, BookOpen, 
            Timer, PauseCircle, PlayCircle, CreditCard, Factory, Gift, PenTool, Briefcase, Layout, GitMerge, 
            Truck, Percent, Check, Hash, ShieldCheck, ShieldAlert, Lightbulb, ListChecks, Wifi, WifiOff, 
            Database, Book, FileCheck, ArrowRightCircle, ArrowLeftCircle, ChevronsRight, Watch
        } = SafeIcons;

        // --- THEME CONTEXT ---
        const ThemeContext = createContext();
        const useTheme = () => useContext(ThemeContext);

        const getThemeClasses = (isDark) => ({
            isDark,
            appBg: isDark ? 'bg-slate-950' : 'bg-gray-100',
            panelBg: isDark ? 'bg-slate-800' : 'bg-white',
            panelBorder: isDark ? 'border-slate-700' : 'border-gray-200 shadow-sm',
            headerBg: isDark ? 'bg-slate-900' : 'bg-white',
            headerBorder: isDark ? 'border-slate-800' : 'border-gray-200',
            sidebarBg: isDark ? 'bg-slate-900' : 'bg-white',
            sidebarBorder: isDark ? 'border-slate-800' : 'border-gray-200',
            textMain: isDark ? 'text-white' : 'text-slate-900',
            textSec: isDark ? 'text-slate-400' : 'text-slate-500',
            inputBg: isDark ? 'bg-slate-900' : 'bg-gray-50',
            inputBorder: isDark ? 'border-slate-600' : 'border-gray-300',
            tableHeader: isDark ? 'bg-slate-900/50' : 'bg-gray-100',
            tableRowHover: isDark ? 'hover:bg-slate-700/30' : 'hover:bg-gray-50',
            accentText: isDark ? 'text-amber-500' : 'text-amber-600',
            accentBg: isDark ? 'bg-amber-500' : 'bg-amber-600',
            accentLightBg: isDark ? 'bg-amber-500/10' : 'bg-amber-50',
            bgHighlightBlue: isDark ? 'bg-blue-500/20' : 'bg-blue-100',
            textOnHighlightBlue: isDark ? 'text-blue-400' : 'text-blue-800',
            bgHighlightGreen: isDark ? 'bg-green-500/20' : 'bg-green-100',
            textOnHighlightGreen: isDark ? 'text-green-400' : 'text-green-800',
            bgHighlightAmber: isDark ? 'bg-amber-500/20' : 'bg-amber-100',
            textOnHighlightAmber: isDark ? 'text-amber-400' : 'text-amber-800',
            bgHighlightPurple: isDark ? 'bg-purple-500/20' : 'bg-purple-100',
            textOnHighlightPurple: isDark ? 'text-purple-400' : 'text-purple-800',
            alertDangerBg: isDark ? 'bg-red-900/20' : 'bg-red-50',
            alertDangerBorder: isDark ? 'border-red-900/50' : 'border-red-200',
            alertDangerText: isDark ? 'text-red-300' : 'text-red-800',
            alertWarningBg: isDark ? 'bg-amber-900/20' : 'bg-amber-50',
            alertWarningBorder: isDark ? 'border-amber-900/50' : 'border-amber-200',
            alertWarningText: isDark ? 'text-amber-300' : 'text-amber-800',
            divider: isDark ? 'divide-slate-700' : 'divide-gray-200',
            menuItemHover: isDark ? 'hover:bg-slate-800' : 'hover:bg-gray-100',
            accentLightBorder: isDark ? 'border-amber-500/30' : 'border-amber-200',
        });

        // --- CONSTANTS & DATA ---
        const VAT_RATE = 0.081; 
        const STATUS_STEPS = ["Demande enregistrée", "Pièce réceptionnée", "Diagnostic terminé", "Devis réalisé", "Accord client", "En réparation", "Contrôle & livraison", "Rapport généré", "Dossier clôturé"];
        const COVERAGE_TYPES = [
            { id: 'paid', label: 'Payant (Hors garantie)', icon: DollarSign, color: 'text-slate-600' },
            { id: 'warranty_sales', label: 'Sous garantie de vente', icon: ShieldCheck, color: 'text-green-600' },
            { id: 'warranty_repair', label: 'Garantie de réparation', icon: ShieldCheck, color: 'text-blue-600' },
            { id: 'goodwill', label: 'Geste commercial (Goodwill)', icon: ShieldAlert, color: 'text-amber-600' }
        ];
        const CHECKLIST_ITEMS = {
            visual: ['Carrure', 'Lunette', 'Fond', 'Cadran', 'Aiguilles', 'Couronne', 'Bracelet'],
            functional: ['Réglage', 'Étanchéité', 'État des joints', 'Vis de bracelet', 'Armage / mise à l\'heure', 'Magnétisme']
        };
        const FINAL_CONTROL_ITEMS = {
            identity: ["Contrôler les documents remis par le client (Certificat, facture…)", "Contrôler la référence montre et conformité des composants"],
            aesthetic: ["Contrôler l'esthétique (lunette, carrure, fond, cornes, fermoir)", "Contrôler vis de fond / orientation / olivette", "Contrôler la propreté emboîtage (poils, poussières…)", "Contrôler aiguilles / cadran / index / appliques", "Contrôler guichet / disque / décalque"],
            technical: ["Contrôler l’étanchéité", "Contrôler la marche (précision)", "Contrôler le placage de la couronne", "Contrôler le passage des fonctions et tenue de la tige", "Contrôler la friction en mise à l’heure", "Contrôler le stop seconde", "Contrôler le saut de date (minuit +/- tolérance)", "Contrôler l'alignement des aiguilles (12h, 6h...)", "Contrôler le parallélisme des aiguilles", "Contrôler le correcteur rapide de quantième", "Contrôler le centrage de la date", "Contrôler le remontage manuel (couronne)", "Contrôler le remontage automatique (masse)", "Contrôler la liberté de rotation de la masse"]
        };
        const MEASURE_POSITIONS = [
            { id: 'ch', label: 'Cadran haut (CH)' },
            { id: 'cb', label: 'Cadran bas (CB)' },
            { id: '3h', label: 'Couronne haut (3H)' },
            { id: '9h', label: 'Couronne bas (9H)' },
            { id: '12h', label: 'Couronne gauche (12H)' },
            { id: '6h', label: 'Couronne droite (6H)' }
        ];

        const PRICING_DB = [
            { id: 'srv_complet', name: 'Service complet', priceHT: 650.00, type: 'package' },
            { id: 'srv_partiel', name: 'Service partiel', priceHT: 150.00, type: 'labor' },
            { id: 'srv_ctrl', name: 'Contrôle', priceHT: 50.00, type: 'labor' },
            { id: 'srv_rev_mvt', name: 'Révision du mouvement', priceHT: 350.00, type: 'labor' },
            { id: 'srv_reglage', name: 'Réglage de la marche', priceHT: 80.00, type: 'labor' },
            { id: 'srv_demag', name: 'Démagnétisation', priceHT: 30.00, type: 'labor' },
            { id: 'srv_etanche', name: 'Test d’étanchéité', priceHT: 40.00, type: 'labor' },
            { id: 'srv_restau', name: 'Restauration horlogère (montres anciennes / vintage)', priceHT: 1200.00, type: 'labor' },
            { id: 'srv_pile', name: 'Remplacement de pile', priceHT: 25.00, type: 'labor' },
            { id: 'srv_ctrl_elec', name: 'Contrôle électronique', priceHT: 35.00, type: 'labor' },
            { id: 'srv_pol_boite', name: 'Polissage du boîtier', priceHT: 180.00, type: 'labor' },
            { id: 'srv_pol_brac', name: 'Polissage du bracelet', priceHT: 120.00, type: 'labor' },
            { id: 'srv_rhab_est', name: 'Rhabillage esthétique', priceHT: 250.00, type: 'labor' },
            { id: 'srv_net_boite', name: 'Nettoyage du boîtier', priceHT: 60.00, type: 'labor' },
            { id: 'srv_ajust_brac', name: 'Ajustement du bracelet', priceHT: 30.00, type: 'labor' },
            { id: 'srv_rep_brac', name: 'Réparation de bracelet', priceHT: 90.00, type: 'labor' },
            { id: 'srv_remp_boucle', name: 'Remplacement de boucle / fermoir', priceHT: 20.00, type: 'labor' },
            { id: 'srv_net_brac', name: 'Nettoyage de bracelet', priceHT: 40.00, type: 'labor' },
            { id: 'pm_mouvement', name: 'Mouvement complet', priceHT: 350.00, type: 'part' },
            { id: 'pm_masse', name: 'Masse', priceHT: 85.00, type: 'part' },
            { id: 'pm_balancier', name: 'Balancier', priceHT: 120.00, type: 'part' },
            { id: 'pm_pont', name: 'Pont', priceHT: 150.00, type: 'part' },
            { id: 'pm_barillet', name: 'Barillet', priceHT: 45.00, type: 'part' },
            { id: 'pm_platine', name: 'Platine', priceHT: 200.00, type: 'part' },
            { id: 'pm_autre1', name: 'Autre fourniture mouvement', priceHT: 0.00, type: 'part' },
            { id: 'ph_boite_comp', name: 'Boîte complète', priceHT: 1200.00, type: 'part' },
            { id: 'ph_fond', name: 'Fond', priceHT: 80.00, type: 'part' },
            { id: 'ph_lunette', name: 'Lunette', priceHT: 120.00, type: 'part' },
            { id: 'ph_carrure', name: 'Carrure', priceHT: 350.00, type: 'part' },
            { id: 'ph_cadran', name: 'Cadran', priceHT: 250.00, type: 'part' },
            { id: 'ph_cadran_pieds', name: 'Cadran avec pieds', priceHT: 300.00, type: 'part' },
            { id: 'ph_cadran_sans', name: 'Cadran sans pied', priceHT: 300.00, type: 'part' },
            { id: 'ph_cadran_cart', name: 'Cartouche', priceHT: 250.00, type: 'part' },
            { id: 'ph_bracelet', name: 'Changement du bracelet', priceHT: 400.00, type: 'part' },
            { id: 'ph_disque', name: 'Disque', priceHT: 80.00, type: 'part' },
            { id: 'ph_aiguille_jeu', name: 'Aiguilles (jeu)', priceHT: 111.40, type: 'part' },
            { id: 'ph_glace_sus', name: 'Glace sus', priceHT: 120.00, type: 'part' },
            { id: 'ph_glace_sous', name: 'Glace sous', priceHT: 120.00, type: 'part' },
            { id: 'ph_couronne', name: 'Couronne', priceHT: 140.00, type: 'part' },
            { id: 'ph_tube', name: 'Tube de couronne', priceHT: 40.00, type: 'part' },
            { id: 'ph_poussoir_corr', name: 'Poussoir correcteur', priceHT: 60.00, type: 'part' },
            { id: 'ph_poussoir_chrono', name: 'Poussoir chrono', priceHT: 350.00, type: 'part' },
            { id: 'ph_boucle_ard', name: 'Boucle ardillon', priceHT: 60.00, type: 'part' },
            { id: 'ph_boucle_dep', name: 'Boucle déployante', priceHT: 250.00, type: 'part' },
            { id: 'ph_maillon', name: 'Maillon', priceHT: 50.00, type: 'part' },
            { id: 'ph_fermoir', name: 'Fermoir de sécurité', priceHT: 100.00, type: 'part' },
            { id: 'ph_coiffe', name: 'Coiffe', priceHT: 40.00, type: 'part' },
            { id: 'ph_vis', name: 'Vis maillons', priceHT: 10.00, type: 'part' },
            { id: 'ph_barrette', name: 'Barrette', priceHT: 5.00, type: 'part' },
            { id: 'ph_attache', name: 'Attache cuir', priceHT: 150.00, type: 'part' },
            { id: 'ph_entrecornes', name: 'Entre-cornes', priceHT: 50.00, type: 'part' },
            { id: 'ph_joints', name: 'Joints', priceHT: 15.00, type: 'part' },
            { id: 'srv_restau_compl', name: 'Restauration complète (Patrimoine)', priceHT: 15000.00, type: 'labor' },
            { id: 'fab_cadran', name: 'Fabrication cadran neuf (identique)', priceHT: 8500.00, type: 'part' },
            { id: 'srv_etanche_na', name: 'Contrôle étanchéité', priceHT: 0.00, type: 'labor' },
            { id: 'srv_restau_master', name: 'Restauration Grande Complication', priceHT: 45000.00, type: 'labor' },
            { id: 'fab_boitier', name: 'Reconstruction Boîtier Or Rose', priceHT: 25000.00, type: 'part' },
            { id: 'fab_cadran_email', name: 'Fabrication Cadran Émail', priceHT: 5000.00, type: 'part' },
            { id: 'srv_restau_hab', name: 'Restauration Habillage & Orfèvrerie', priceHT: 12000.00, type: 'labor' },
            { id: 'fab_bracelet_or', name: 'Fabrication Bracelet Or Intégré', priceHT: 18000.00, type: 'part' },
            { id: 'srv_rev_mvt_compl', name: 'Révision Mouvement QP Chrono', priceHT: 3500.00, type: 'labor' },
            { id: 'srv_restau_mvt', name: 'Restauration Mouvement Compliqué', priceHT: 8000.00, type: 'labor' },
            { id: 'fab_pieces', name: 'Fabrication Pièces (Came, Ressort)', priceHT: 4500.00, type: 'part' },
            { id: 'srv_restau_sonnerie', name: 'Restauration Répétition Minutes', priceHT: 9500.00, type: 'labor' },
            { id: 'srv_redressage', name: 'Redressage Gongs & Accordage', priceHT: 2500.00, type: 'labor' }
        ];

        // --- UTILS ---
        const formatCurrency = (amount) => {
            if (amount === undefined || amount === null) return '0.00 CHF';
            return new Intl.NumberFormat('fr-CH', { style: 'currency', currency: 'CHF' }).format(amount);
        };
        const roundMoney = (amount) => (Math.round((amount || 0) * 20) / 20).toFixed(2);

        // --- COMPOSANT DE GESTION PHOTO ---
        const PhotoManager = ({ title, category, photos, updatePhotos }) => {
            const { panelBg, panelBorder, textMain, textSec, inputBorder } = useTheme();
            
            const handleUpload = (e) => {
                if (e.target.files && e.target.files[0]) {
                    const file = e.target.files[0];
                    const newPhoto = { id: Date.now(), url: URL.createObjectURL(file), name: file.name, category };
                    updatePhotos([...photos, newPhoto]);
                }
            };

            const removePhoto = (id) => updatePhotos(photos.filter(p => p.id !== id));
            const currentPhotos = (photos || []).filter(p => p.category === category);

            return (
                <div className={`${panelBg} p-4 rounded-lg border ${panelBorder} mb-4`}>
                    <h5 className={`font-bold text-xs uppercase ${textSec} mb-3 flex items-center gap-2`}>
                        <Camera size={14}/> {title}
                    </h5>
                    <div className="grid grid-cols-3 md:grid-cols-5 gap-3">
                        {currentPhotos.map(photo => (
                            <div key={photo.id} className="relative group aspect-square rounded-lg overflow-hidden border border-slate-600 bg-black">
                                <img src={photo.url} alt={title} className="w-full h-full object-cover" />
                                <button onClick={() => removePhoto(photo.id)} className="absolute top-1 right-1 bg-red-600 text-white p-1 rounded-full opacity-0 group-hover:opacity-100 transition-opacity"><X size={12} /></button>
                            </div>
                        ))}
                        <label className={`flex flex-col items-center justify-center aspect-square border-2 border-dashed ${inputBorder} rounded-lg cursor-pointer hover:bg-slate-50 dark:hover:bg-slate-800 transition-colors`}>
                            <input type="file" className="hidden" accept="image/*" onChange={handleUpload} />
                            <Plus size={20} className={textSec} />
                            <span className={`text-[10px] mt-1 ${textSec}`}>Ajouter</span>
                        </label>
                    </div>
                </div>
            );
        };

        // --- SUB-COMPONENT: MEASURE TABLE ---
        const MeasureTable = ({ title, measures, updateMeasure, readOnly = false }) => {
            const { panelBg, panelBorder, textMain, inputBg, inputBorder } = useTheme();
            return (
                <div className={`${panelBg} rounded-lg border ${panelBorder} overflow-hidden mb-6`}>
                    {title && (
                        <div className="bg-slate-100 dark:bg-slate-700 p-3 border-b dark:border-slate-600">
                            <h4 className="font-bold text-xs uppercase text-slate-500 tracking-widest">{title}</h4>
                        </div>
                    )}
                    <table className="w-full text-sm">
                        <thead>
                            <tr className="border-b dark:border-slate-700">
                                <th className="p-3 text-left font-medium text-slate-500 w-1/3">Position</th>
                                <th className="p-3 text-center font-medium text-slate-500">Marche (s/j)</th>
                                <th className="p-3 text-center font-medium text-slate-500">Amplitude (°)</th>
                            </tr>
                        </thead>
                        <tbody className="divide-y dark:divide-slate-700">
                            {MEASURE_POSITIONS.map(pos => {
                                const m = measures?.[pos.id] || { rate: '', amp: '' };
                                return (
                                    <tr key={pos.id} className={readOnly ? '' : 'hover:bg-slate-50 dark:hover:bg-slate-700/50'}>
                                        <td className={`p-3 font-medium ${textMain}`}>{pos.label}</td>
                                        <td className="p-2">
                                            {readOnly ? (
                                                <div className="text-center font-mono">{m.rate || '-'}</div>
                                            ) : (
                                                <input 
                                                    type="number" 
                                                    className={`w-full text-center p-1 rounded ${inputBg} border ${inputBorder} outline-none focus:border-amber-500`}
                                                    value={m.rate}
                                                    onChange={(e) => updateMeasure(pos.id, 'rate', e.target.value)}
                                                />
                                            )}
                                        </td>
                                        <td className="p-2">
                                            {readOnly ? (
                                                <div className="text-center font-mono">{m.amp || '-'}</div>
                                            ) : (
                                                <input 
                                                    type="number" 
                                                    className={`w-full text-center p-1 rounded ${inputBg} border ${inputBorder} outline-none focus:border-amber-500`}
                                                    value={m.amp}
                                                    onChange={(e) => updateMeasure(pos.id, 'amp', e.target.value)}
                                                />
                                            )}
                                        </td>
                                    </tr>
                                );
                            })}
                        </tbody>
                    </table>
                </div>
            );
        };

        // --- LOGO ROBUSTE (SVG Inline) ---
        const FallbackLogo = () => (
            <div className="relative flex items-center justify-center w-10 h-10 bg-amber-500 rounded-lg text-slate-900 shadow-sm overflow-hidden">
            <Watch size={24} strokeWidth={2} className="print:w-5 print:h-5"/>
            <div className="absolute -bottom-1 -right-1 bg-white rounded-full p-0.5 print:p-0">
                <Plus size={10} className="text-amber-600" strokeWidth={4}/>
            </div>
            </div>
        );

        const BrandLogo = ({ className = "", src = null }) => {
            const [imageError, setImageError] = useState(false);

            return (
                <div className={`flex items-center gap-3 ${className}`}>
                <div className="flex-shrink-0">
                    {src && !imageError ? (
                    <img 
                        src={src} 
                        alt="Logo Watch Repair Plus" 
                        className="w-10 h-10 object-contain rounded-lg bg-white" 
                        onError={(e) => {
                            console.warn("Erreur chargement logo distant, passage au logo vectoriel local.");
                            setImageError(true);
                            e.target.onerror = null; 
                        }} 
                    />
                    ) : (
                    <FallbackLogo />
                    )}
                </div>
                
                <div className="leading-none">
                    <h1 className="font-bold text-lg tracking-wider uppercase text-slate-900 print:text-base">Watch</h1>
                    <h1 className="font-bold text-xs tracking-widest uppercase text-amber-600 print:text-[10px]">Repair Plus</h1>
                </div>
                </div>
            );
        };

        // --- NAVIGATION ---
        const Sidebar = ({ activeTab, setActiveTab, isOpen, toggleSidebar, currentRepair }) => {
            const { sidebarBg, sidebarBorder, textMain, textSec, accentText, accentLightBg, accentLightBorder, menuItemHover } = useTheme();
            
            const menuItems = [
                { id: 'dashboard', label: 'TABLEAU DE BORD', icon: Archive },
                { id: 'client_request', label: '1. Demande client', icon: UserPlus }, 
                { id: 'inspection', label: '2. Réception & état', icon: FileSearch }, 
                { id: 'internal_quote', label: '3. Fiche devis interne', icon: ClipboardCheck }, 
                { id: 'quote', label: '4. Devis', icon: DollarSign }, 
                { id: 'workshop', label: '5. Fiche atelier', icon: Wrench }, 
                { id: 'delivery', label: '6. Livraison', icon: Gift }, 
                { id: 'report', label: '7. Rapport de réparation', icon: BookOpen },
                { id: 'invoice', label: '8. Facturation', icon: Printer }, 
            ];

            const getRecommendedPage = (statusStep) => {
                switch (statusStep) {
                    case 0: return 'client_request';
                    case 1: return 'inspection';
                    case 2: return 'internal_quote';
                    case 3: return 'quote';
                    case 4: return 'workshop'; 
                    case 5: return 'workshop'; 
                    case 6: return 'delivery'; 
                    case 7: return 'report'; 
                    case 8: return 'invoice'; 
                    default: return 'dashboard';
                }
            };

            const recommendedPage = currentRepair ? getRecommendedPage(currentRepair.statusStep) : null;

            return (
                <>
                <div className={`fixed inset-0 bg-black/50 z-20 md:hidden transition-opacity ${isOpen ? 'opacity-100' : 'opacity-0 pointer-events-none'}`} onClick={toggleSidebar} />
                <div className={`fixed md:static inset-y-0 left-0 z-30 w-64 ${sidebarBg} ${textMain} border-r ${sidebarBorder} transform transition-transform md:transform-none ${isOpen ? 'translate-x-0' : '-translate-x-full'} transition-colors duration-300 flex flex-col no-print`}>
                    <div className={`p-6 border-b ${sidebarBorder} flex items-center gap-3 shrink-0`}>
                    <BrandLogo />
                    </div>
                    
                    <nav className="px-4 space-y-1 flex-1 overflow-y-auto mt-4">
                    {menuItems.map((item) => (
                        <button 
                            key={item.id} 
                            onClick={() => { setActiveTab(item.id); toggleSidebar(); }} 
                            className={`w-full flex items-center px-4 py-3 rounded-lg transition-colors text-left group gap-3 ${activeTab === item.id ? `${accentLightBg} ${accentText} border ${accentLightBorder}` : `${textSec} ${menuItemHover}`}`}
                        >
                        {item.id === recommendedPage && item.id !== 'dashboard' ? (
                            <ChevronsRight size={16} className="text-amber-500 animate-pulse shrink-0" />
                        ) : (
                            <div className="w-4 shrink-0"></div>
                        )}
                        
                        <item.icon size={18} className="shrink-0" />
                        <span className="font-medium text-sm truncate">{item.label}</span>
                        </button>
                    ))}
                    </nav>
                </div>
                </>
            );
        };

        // --- PAGES ---

        const Dashboard = ({ repairs, selectRepair, createNewRepair }) => {
            const { textMain, textSec, panelBg, panelBorder, inputBg, inputBorder, tableHeader, tableRowHover, divider, bgHighlightBlue, textOnHighlightBlue, bgHighlightAmber, textOnHighlightAmber, bgHighlightPurple, textOnHighlightPurple, bgHighlightGreen, textOnHighlightGreen, alertDangerBg, alertDangerBorder, alertDangerText, alertWarningBg, alertWarningBorder, alertWarningText } = useTheme();
            const [searchTerm, setSearchTerm] = useState('');
            const filtered = repairs.filter(r => (r.client || '').toLowerCase().includes(searchTerm.toLowerCase()) || (r.id || '').toLowerCase().includes(searchTerm.toLowerCase()));
            const lateRepairs = repairs.filter(r => r.statusStep > 0 && r.statusStep < 7).slice(0, 2);
            const getCoverageDisplay = (type) => COVERAGE_TYPES.find(c => c.id === (type || 'paid')) || COVERAGE_TYPES[0];

            // Calculer les statistiques par statut
            const statusStats = repairs.reduce((acc, curr) => {
                const status = STATUS_STEPS[curr.statusStep];
                acc[status] = (acc[status] || 0) + 1;
                return acc;
            }, {});

            return (
                <div className="p-6 max-w-7xl mx-auto animate-in fade-in duration-500">
                <div className="flex justify-between items-center mb-8">
                    <div><h2 className={`text-2xl font-bold ${textMain} mb-2 uppercase tracking-widest`}>TABLEAU DE BORD</h2><p className={textSec}>Aperçu global des dossiers</p></div>
                    <button onClick={createNewRepair} className="bg-amber-500 hover:bg-amber-600 text-slate-900 px-4 py-2 rounded-lg font-bold flex items-center gap-2 shadow-md"><Plus size={18} /> Nouveau dossier</button>
                </div>
                <div className="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
                    <div className={`${panelBg} border ${panelBorder} rounded-xl p-5 shadow-sm`}>
                        <h3 className={`text-sm font-bold uppercase mb-4 ${textSec} flex items-center gap-2`}><AlertOctagon size={16} className="text-red-500"/> Alertes retards</h3>
                        <div className="space-y-3">
                            {lateRepairs.map((r, i) => (
                                <div key={i} className={`${alertDangerBg} border ${alertDangerBorder} p-3 rounded-lg flex justify-between items-center`}>
                                    <div className="flex items-center gap-3"><span className={`text-xs font-bold ${alertDangerText} font-mono`}>{r.id}</span><span className={`text-xs ${alertDangerText} opacity-80`}>{r.model}</span></div><span className={`text-xs font-bold ${alertDangerText}`}>+5j</span>
                                </div>
                            ))}
                        </div>
                    </div>
                    <div className={`${panelBg} border ${panelBorder} rounded-xl p-5 shadow-sm`}>
                        <h3 className={`text-sm font-bold uppercase mb-4 ${textSec} flex items-center gap-2`}><TrendingDown size={16} className="text-blue-500"/> Charge atelier</h3>
                        <div className="space-y-3 mt-4">
                            {Object.entries(statusStats).slice(0, 5).map(([status, count]) => (
                            <div key={status} className="flex justify-between items-center text-sm border-b border-gray-100 dark:border-gray-800 pb-2 last:border-0">
                                <span className={textMain}>{status}</span>
                                <span className={`font-bold px-2 py-0.5 rounded-full ${bgHighlightBlue} ${textOnHighlightBlue}`}>{count}</span>
                            </div>
                            ))}
                        </div>
                    </div>
                </div>
                <div className={`${panelBg} rounded-xl border ${panelBorder} overflow-hidden shadow-sm`}>
                    <div className={`p-4 border-b ${panelBorder} flex justify-between items-center`}>
                    <h3 className={`font-bold ${textMain}`}>Dossiers récents</h3>
                    <div className="relative"><Search className={`absolute left-3 top-1/2 -translate-y-1/2 ${textSec}`} size={16} /><input type="text" placeholder="Chercher client, numéro..." value={searchTerm} onChange={(e) => setSearchTerm(e.target.value)} className={`${inputBg} border ${inputBorder} ${textMain} pl-10 pr-4 py-1.5 rounded-lg text-sm outline-none w-64`} /></div>
                    </div>
                    <div className="overflow-x-auto">
                    <table className={`w-full text-left text-sm ${textSec}`}>
                        <thead className={`${tableHeader} uppercase text-[10px] font-bold tracking-wider`}><tr><th className="p-4">N° SAV</th><th className="p-4">Client</th><th className="p-4">Modèle</th><th className="p-4">Prise en charge</th><th className="p-4">Statut</th><th className="p-4 text-right">Action</th></tr></thead>
                        <tbody className={`divide-y ${divider}`}>
                        {filtered.map((r) => {
                            const coverage = getCoverageDisplay(r.coverageType);
                            const CoverageIcon = coverage.icon;
                            return (
                            <tr key={r.id} className={`${tableRowHover} transition-colors cursor-pointer`} onClick={() => selectRepair(r)}>
                                <td className={`p-4 font-mono font-bold ${textMain}`}>{r.id}</td><td className="p-4 font-medium">{r.client || 'Client Inconnu'}</td><td className="p-4">{r.model || 'N/A'}</td>
                                <td className="p-4"><div className={`flex items-center gap-2 text-xs font-bold ${coverage.color}`}><CoverageIcon size={14} /><span className="truncate max-w-[150px]">{coverage.label}</span></div></td>
                                <td className="p-4"><span className={`px-2 py-0.5 rounded text-[10px] font-bold uppercase tracking-wider ${r.statusStep >= 7 ? `${bgHighlightGreen} ${textOnHighlightGreen}` : `${bgHighlightBlue} ${textOnHighlightBlue}`}`}>{STATUS_STEPS[r.statusStep]}</span></td>
                                <td className="p-4 text-right"><button className="p-2 rounded-full hover:bg-amber-500/10 text-amber-500"><ChevronRight size={18} /></button></td>
                            </tr>
                            );
                        })}
                        </tbody>
                    </table>
                    </div>
                </div>
                </div>
            );
        };

        const ClientRequestForm = ({ data, updateData, onValidateStep }) => {
            const { panelBg, panelBorder, textMain, textSec, inputBg, inputBorder, accentText } = useTheme();
            return (
                <div className="p-6 max-w-5xl mx-auto space-y-6 pb-24 animate-in fade-in duration-500">
                <div className={`${panelBg} p-6 rounded-xl border ${panelBorder}`}>
                    <h3 className={`text-lg font-bold ${accentText} mb-6 flex items-center gap-2`}><UserPlus size={20} /> Demande client & identification</h3>
                    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-6">
                    <div><label className={`block text-[10px] uppercase font-bold ${textSec} mb-1 flex items-center`}>N° Client</label><input type="text" value={data.clientId || ''} onChange={e => updateData({...data, clientId: e.target.value})} className={`w-full ${inputBg} border ${inputBorder} rounded p-2 text-sm outline-none focus:border-amber-500`} placeholder="ex: CL-8890" /></div>
                    <div className="lg:col-span-2"><label className={`block text-[10px] uppercase font-bold ${textSec} mb-1`}>Nom du client</label><input type="text" value={data.client || ''} onChange={e => updateData({...data, client: e.target.value})} className={`w-full ${inputBg} border ${inputBorder} rounded p-2 text-sm outline-none focus:border-amber-500`} /></div>
                    
                    <div className="lg:col-span-3 grid grid-cols-3 gap-4">
                        <div><label className={`block text-[10px] uppercase font-bold ${textSec} mb-1`}>Adresse</label><input type="text" value={data.clientAddress || ''} onChange={e => updateData({...data, clientAddress: e.target.value})} className={`w-full ${inputBg} border ${inputBorder} rounded p-2 text-sm outline-none focus:border-amber-500`} /></div>
                        <div><label className={`block text-[10px] uppercase font-bold ${textSec} mb-1`}>NPA</label><input type="text" value={data.clientZip || ''} onChange={e => updateData({...data, clientZip: e.target.value})} className={`w-full ${inputBg} border ${inputBorder} rounded p-2 text-sm outline-none focus:border-amber-500`} /></div>
                        <div><label className={`block text-[10px] uppercase font-bold ${textSec} mb-1`}>Ville</label><input type="text" value={data.clientCity || ''} onChange={e => updateData({...data, clientCity: e.target.value})} className={`w-full ${inputBg} border ${inputBorder} rounded p-2 text-sm outline-none focus:border-amber-500`} /></div>
                    </div>
                    
                    <div><label className={`block text-[10px] uppercase font-bold ${textSec} mb-1`}>Modèle / Référence</label><input type="text" value={data.model || ''} onChange={e => updateData({...data, model: e.target.value})} className={`w-full ${inputBg} border ${inputBorder} rounded p-2 text-sm outline-none focus:border-amber-500`} /></div>
                    <div><label className={`block text-[10px] uppercase font-bold ${textSec} mb-1`}>N° de série</label><input type="text" value={data.serial || ''} onChange={e => updateData({...data, serial: e.target.value})} className={`w-full ${inputBg} border ${inputBorder} rounded p-2 text-sm outline-none focus:border-amber-500`} /></div>
                    </div>
                    <div className={`p-5 rounded-lg border ${panelBorder} bg-slate-50 dark:bg-slate-900/30 mb-6 shadow-inner`}>
                    <h4 className="text-xs font-bold uppercase mb-4 flex items-center gap-2 text-slate-400 font-mono">CHRONOLOGIE DU DOSSIER</h4>
                    <div className="grid grid-cols-1 md:grid-cols-3 gap-6 text-sm">
                        <div><label className="block text-[10px] font-bold mb-1 opacity-70">DATE DE VENTE</label><input type="date" value={data.saleDate || ''} onChange={e => updateData({...data, saleDate: e.target.value})} className={`w-full p-2 rounded border ${inputBorder} ${inputBg} text-xs`} /></div>
                        <div><label className="block text-[10px] font-bold mb-1 opacity-70">DATE DERNIÈRE RÉPARATION</label><input type="date" value={data.lastRepairDate || ''} onChange={e => updateData({...data, lastRepairDate: e.target.value})} className={`w-full p-2 rounded border ${inputBorder} ${inputBg} text-xs`} /></div>
                        <div><label className={`block text-[10px] font-bold mb-1 ${accentText}`}>DATE DE RETOUR SAV</label><input type="date" value={data.depositDate || ''} onChange={e => updateData({...data, depositDate: e.target.value})} className="w-full p-2 rounded border border-amber-500 bg-amber-500/5 text-xs font-bold" /></div>
                    </div>
                    </div>
                    <div className="space-y-4">
                    <div><label className="block text-[10px] font-bold uppercase mb-1 opacity-70">Demande client</label><textarea rows={3} value={data.customerRequestText || ''} onChange={e => updateData({...data, customerRequestText: e.target.value})} className={`w-full ${inputBg} border ${inputBorder} rounded p-3 text-sm outline-none focus:border-amber-500`} placeholder="Demande précise du client..." /></div>
                    <div><label className="block text-[10px] font-bold uppercase mb-1 opacity-70">Problème remonté par le client</label><textarea rows={3} value={data.issue || ''} onChange={e => updateData({...data, issue: e.target.value})} className={`w-full ${inputBg} border ${inputBorder} rounded p-3 text-sm outline-none focus:border-amber-500`} placeholder="Adapte le contenu en te limitant à une reformulation des mot du client qui explique le problème tel qu'il le vit." /></div>
                    </div>
                </div>
                <div className={`fixed bottom-0 left-0 right-0 ${panelBg} border-t ${panelBorder} p-4 flex justify-end gap-4 z-30 md:pl-64 shadow-2xl`}><button onClick={onValidateStep} className="bg-green-600 hover:bg-green-700 text-white px-6 py-3 rounded-lg font-bold flex items-center gap-2 shadow-lg hover:scale-105 transition-transform"><CheckCircle size={18}/> Valider & Suivant</button></div>
                </div>
            );
        };

        const InspectionForm = ({ data, updateData, onValidateStep }) => {
            const { panelBg, panelBorder, textMain, accentText, inputBg, inputBorder, textSec, bgHighlightAmber } = useTheme();
            const setRating = (k, v) => updateData({ ...data, checklists: { ...data.checklists, visual: { ...(data.checklists?.visual || {}), [k]: v } } });
            
            const handleItemToggle = (key) => {
                updateData({ ...data, receivedItems: { ...(data.receivedItems || {}), [key]: !data.receivedItems?.[key] } });
            };
            
            const updateInspectionMeasure = (posId, field, value) => {
                const current = data.inspectionMeasures || {};
                const posData = current[posId] || {};
                updateData({
                    ...data,
                    inspectionMeasures: {
                        ...current,
                        [posId]: { ...posData, [field]: value }
                    }
                });
            };

            return (
                <div className="p-6 max-w-5xl mx-auto space-y-6 pb-24 animate-in fade-in duration-500">
                
                <div className={`${panelBg} p-6 rounded-xl border ${panelBorder} shadow-sm`}>
                    <h3 className={`text-lg font-bold ${accentText} mb-4 flex items-center gap-2`}><Package size={20}/> Éléments remis par le client</h3>
                    
                    <div className="grid grid-cols-2 md:grid-cols-3 gap-6 mb-6">
                        <label className="flex items-center gap-2 cursor-pointer font-medium hover:text-amber-500 transition-colors">
                            <input type="checkbox" checked={!!data.receivedItems?.hasBox} onChange={() => handleItemToggle('hasBox')} className="w-5 h-5 accent-amber-500" /> 
                            Boîte
                        </label>
                        <label className="flex items-center gap-2 cursor-pointer font-medium hover:text-amber-500 transition-colors">
                            <input type="checkbox" checked={!!data.receivedItems?.hasEcrin} onChange={() => handleItemToggle('hasEcrin')} className="w-5 h-5 accent-amber-500" /> 
                            Ecrin
                        </label>
                        <label className="flex items-center gap-2 cursor-pointer font-medium hover:text-amber-500 transition-colors">
                            <input type="checkbox" checked={!!data.receivedItems?.hasCertAuth} onChange={() => handleItemToggle('hasCertAuth')} className="w-5 h-5 accent-amber-500" /> 
                            Certificat d'authenticité
                        </label>
                        <label className="flex items-center gap-2 cursor-pointer font-medium hover:text-amber-500 transition-colors">
                            <input type="checkbox" checked={!!data.receivedItems?.hasInvoice} onChange={() => handleItemToggle('hasInvoice')} className="w-5 h-5 accent-amber-500" /> 
                            Facture d'achat
                        </label>
                        <label className="flex items-center gap-2 cursor-pointer font-medium hover:text-amber-500 transition-colors">
                            <input type="checkbox" checked={!!data.receivedItems?.hasWarrantyCard} onChange={() => handleItemToggle('hasWarrantyCard')} className="w-5 h-5 accent-amber-500" /> 
                            Carte de garantie
                        </label>
                    </div>

                    <div className={`p-4 rounded-lg border ${bgHighlightAmber} border-amber-200`}>
                        <div className="flex items-start gap-3">
                        <div className="p-2 bg-amber-100 rounded-full text-amber-600"><FileCheck size={20}/></div>
                        <div>
                            <h4 className="text-sm font-bold text-amber-800 uppercase mb-1">Procédure de vérification documentaire</h4>
                            <p className="text-xs text-amber-700 leading-relaxed mb-3">
                                Le personnel du SAV doit examiner soigneusement les documents fournis (certificats, factures, cartes) pour vérifier l'authenticité de la montre et déterminer avec précision le statut de la garantie (validité, couverture géographique).
                            </p>
                            <label className="flex items-center gap-2 cursor-pointer text-xs font-bold text-amber-900">
                                <input type="checkbox" checked={!!data.receivedItems?.docsVerified} onChange={() => handleItemToggle('docsVerified')} className="w-4 h-4 accent-amber-600" />
                                J'atteste avoir vérifié l'authenticité et la validité des documents.
                            </label>
                        </div>
                        </div>
                    </div>
                </div>
                
                <PhotoManager title="Photos de réception / diagnostic" category="receipt" photos={data.photos || []} updatePhotos={p => updateData({...data, photos: p})} />

                <div className={`${panelBg} p-6 rounded-xl border ${panelBorder} mb-6`}>
                    <h4 className="font-bold border-b pb-2 mb-4 text-xs uppercase tracking-widest text-slate-400">Observations initiales (Avant ouverture)</h4>
                    <textarea 
                        rows={4} 
                        value={data.initialObservations || ''} 
                        onChange={e => updateData({...data, initialObservations: e.target.value})} 
                        className={`w-full ${inputBg} border ${inputBorder} rounded p-3 text-sm outline-none focus:border-amber-500 mb-4`} 
                        placeholder="Noter ici l'état général, les rayures visibles, l'oxydation, etc..." 
                    />
                </div>

                <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div className={`${panelBg} p-6 rounded-xl border ${panelBorder}`}><h4 className="font-bold border-b pb-2 mb-4 text-xs uppercase tracking-widest text-slate-400">État esthétique (0-5)</h4><div className="space-y-4">{CHECKLIST_ITEMS.visual.map(item => (<div key={item} className="flex items-center justify-between"><span className="text-sm">{item}</span><div className="flex gap-1">{[0,1,2,3,4,5].map(v => (<button key={v} onClick={() => setRating(item,v)} className={`w-8 h-8 rounded text-xs font-bold transition-colors ${data.checklists?.visual?.[item] === v ? 'bg-amber-500 text-white' : 'bg-slate-100 hover:bg-slate-200'}`}>{v}</button>))}</div></div>))}</div></div>
                    
                    <div>
                        <MeasureTable 
                            title="Mesures initiales (Chronométrie)" 
                            measures={data.inspectionMeasures} 
                            updateMeasure={updateInspectionMeasure} 
                        />
                    </div>
                </div>
                <div className={`fixed bottom-0 left-0 right-0 ${panelBg} border-t ${panelBorder} p-4 flex justify-end z-30 md:pl-64 shadow-xl`}><button onClick={onValidateStep} className="bg-green-600 text-white px-6 py-3 rounded-lg font-bold flex items-center gap-2"><CheckCircle size={18}/> Valider état & suivant</button></div>
                </div>
            );
        };

        const WorkshopSheet = ({ data, updateData, onValidateStep }) => {
            const { panelBg, panelBorder, accentText, inputBg, inputBorder, textMain } = useTheme();
            
            const toggleFinalControl = (category, item) => {
                const currentCategory = data.finalControls?.[category] || [];
                const newCategory = currentCategory.includes(item) ? currentCategory.filter(i => i !== item) : [...currentCategory, item];
                updateData({ ...data, finalControls: { ...data.finalControls, [category]: newCategory } });
            };

            const totalItems = FINAL_CONTROL_ITEMS.identity.length + FINAL_CONTROL_ITEMS.aesthetic.length + FINAL_CONTROL_ITEMS.technical.length;
            const checkedItems = (data.finalControls?.identity?.length || 0) + (data.finalControls?.aesthetic?.length || 0) + (data.finalControls?.technical?.length || 0);
            const progress = Math.round((checkedItems / totalItems) * 100);
            
            const updateFinalMeasure = (posId, field, value) => {
                const current = data.finalMeasures || {};
                const posData = current[posId] || {};
                updateData({
                    ...data,
                    finalMeasures: {
                        ...current,
                        [posId]: { ...posData, [field]: value }
                    }
                });
            };

            const [selectedGamme, setSelectedGamme] = useState('');
            const [selectedPartToAdd, setSelectedPartToAdd] = useState('');
            const [newOpData, setNewOpData] = useState({ description: '', department: 'Atelier Technique', stdTime: '0.50' });
            const [editingPartId, setEditingPartId] = useState(null);
            
            const GAMMES_OPERATOIRES = {
                'service_complet_meca': { label: 'Service Complet (Méc/Auto)', ops: [ { desc: 'Démontage complet', time: '0.75' }, { desc: 'Lavage', time: '0.50' }, { desc: 'Remontage & Huilage', time: '1.00' }, { desc: 'Réglage', time: '0.25' } ] },
                'service_quartz': { label: 'Service Quartz', ops: [ { desc: 'Contrôle circuit', time: '0.30' }, { desc: 'Remplacement pile', time: '0.15' } ] },
                'polissage': { label: 'Polissage', ops: [ { desc: 'Préparation', time: '0.50' }, { desc: 'Polissage', time: '1.00' }, { desc: 'Lavage', time: '0.20' } ] }
            };

            const operations = data.operations || (data.quote?.mandatory || []).map((item, index) => ({
                id: item.uuid, opNumber: (index + 1) * 10, department: 'Atelier Horlogerie', description: item.name, stdTime: '1.00', status: 'À réaliser'
            }));

            const partsToReplace = (data.quote?.mandatory || []).filter(item => item.type === 'part');
            const availablePartsToAdd = PRICING_DB.filter(p => p.type === 'part' && !partsToReplace.some(existing => existing.id === p.id));

            const launchGamme = (key) => {
                const gamme = GAMMES_OPERATOIRES[key];
                if (!gamme) return;
                const currentMax = operations.length > 0 ? Math.max(...operations.map(o => o.opNumber)) : 0;
                const newOps = gamme.ops.map((op, idx) => ({
                    id: Date.now() + idx, opNumber: currentMax + ((idx + 1) * 10), department: 'Atelier', description: op.desc, stdTime: op.time, status: 'À réaliser', isGamme: true
                }));
                updateData({ ...data, operations: [...operations, ...newOps] });
                setSelectedGamme('');
            };

            const addManualOperation = () => {
                if (!newOpData.description) return;
                const maxOpNum = operations.length > 0 ? Math.max(...operations.map(o => o.opNumber)) : 0;
                const manualOp = {
                id: `manual-${Date.now()}`,
                opNumber: maxOpNum + 10,
                department: newOpData.department,
                description: newOpData.description,
                stdTime: newOpData.stdTime,
                status: 'À réaliser',
                isGamme: false, isManual: true
                };
                updateData({ ...data, operations: [...operations, manualOp] });
                setNewOpData({ description: '', department: 'Atelier Technique', stdTime: '0.50' });
            };

            const updateOperation = (id, field, value) => {
                const updatedOps = operations.map(op => 
                op.id === id ? { ...op, [field]: value } : op
                );
                updateData({ ...data, operations: updatedOps });
            };

            const deleteOperation = (id) => {
                const updatedOps = operations.filter(op => op.id !== id);
                updateData({ ...data, operations: updatedOps });
            };
            
            const toggleOpStatus = (opId) => {
                const newOps = operations.map(op => {
                    if (op.id === opId) return { ...op, status: op.status === 'Terminé' ? 'À réaliser' : 'Terminé' };
                    return op;
                });
                updateData({ ...data, operations: newOps });
            };

            const addPartToReplace = () => {
                const partToAdd = PRICING_DB.find(p => p.id === selectedPartToAdd);
                if (partToAdd) {
                    const newPartItem = { ...partToAdd, uuid: `workshop-added-${Date.now()}`, priceHT: partToAdd.priceHT, isMatrix: false, type: 'part' };
                    const newMandatory = [...(data.quote?.mandatory || []), newPartItem];
                    updateData({ ...data, quote: { ...data.quote, mandatory: newMandatory } });
                    setSelectedPartToAdd('');
                }
            };

            const updatePartPrice = (uuid, newPrice) => {
                const newMandatory = (data.quote?.mandatory || []).map(item => {
                    if (item.uuid === uuid) return { ...item, priceHT: parseFloat(newPrice) || 0 };
                    return item;
                });
                updateData({ ...data, quote: { ...data.quote, mandatory: newMandatory } });
            };
            
            const updatePartName = (uuid, newName) => {
                const newMandatory = (data.quote?.mandatory || []).map(item => {
                    if (item.uuid === uuid) return { ...item, name: newName };
                    return item;
                });
                updateData({ ...data, quote: { ...data.quote, mandatory: newMandatory } });
            };

            const removePartToReplace = (uuid) => {
                const newMandatory = (data.quote?.mandatory || []).filter(item => item.uuid !== uuid);
                updateData({ ...data, quote: { ...data.quote, mandatory: newMandatory } });
            };

            const togglePartStatus = (partUuid) => {
                const isCompleted = data.completedTasks?.includes(partUuid);
                let newCompleted = data.completedTasks || [];
                if (isCompleted) newCompleted = newCompleted.filter(id => id !== partUuid);
                else newCompleted = [...newCompleted, partUuid];
                updateData({ ...data, completedTasks: newCompleted });
            };

            return (
                <div className="p-6 max-w-5xl mx-auto space-y-6 pb-24 animate-in slide-in-from-bottom duration-500">
                <div className={`${panelBg} p-8 rounded-xl border ${panelBorder} shadow-lg`} id="workshop-print">
                    <div className="flex justify-between items-center mb-8 border-b pb-4">
                    <h2 className="text-2xl font-bold flex items-center gap-3 uppercase tracking-tighter"><Factory size={24} className="text-amber-500"/> Fiche atelier & contrôles</h2>
                    <div className="flex items-center gap-4">
                        <div className="text-right text-xs font-mono font-bold text-slate-400 uppercase tracking-widest mr-4">ORDRE: {data.id}</div>
                    </div>
                    </div>

                    <div className={`mb-8 p-5 rounded-lg border ${panelBorder} bg-slate-50 dark:bg-slate-900/30`}>
                    <div className="flex justify-between items-center border-b border-gray-200 dark:border-gray-700 pb-3 mb-4">
                        <h4 className={`text-sm font-bold ${accentText} uppercase flex items-center gap-2`}><Package size={16} /> Composants à remplacer</h4>
                        <div className="flex items-center gap-2 no-print">
                            <select value={selectedPartToAdd} onChange={(e) => setSelectedPartToAdd(e.target.value)} className={`text-xs p-2 rounded border ${inputBorder} ${inputBg} ${textMain} outline-none w-48`}><option value="">+ Ajouter un composant...</option>{availablePartsToAdd.map(part => (<option key={part.id} value={part.id}>{part.name} ({part.priceHT} CHF)</option>))}</select>
                            <button onClick={addPartToReplace} disabled={!selectedPartToAdd} className={`p-2 rounded transition-colors ${selectedPartToAdd ? 'bg-blue-600 text-white hover:bg-blue-500' : 'bg-slate-700 text-slate-500 cursor-not-allowed'}`}><Plus size={14} /></button>
                        </div>
                    </div>
                    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                        {partsToReplace.map(part => {
                            const isReplaced = data.completedTasks?.includes(part.uuid);
                            
                            return (
                                <div key={part.uuid} className={`flex items-center gap-3 p-3 rounded border transition-all ${isReplaced ? 'bg-green-500/10 border-green-500/30' : `${panelBg} ${inputBorder} hover:border-amber-500`}`}>
                                <div onClick={() => togglePartStatus(part.uuid)} className={`cursor-pointer w-5 h-5 rounded border flex items-center justify-center shrink-0 transition-colors ${isReplaced ? 'bg-green-500 border-green-500 text-white' : 'border-gray-400'}`}>{isReplaced && <CheckSquare size={12} />}</div>
                                
                                <div className="flex-1 min-w-0">
                                    <input 
                                        type="text" 
                                        value={part.name} 
                                        onChange={(e) => updatePartName(part.uuid, e.target.value)}
                                        className={`w-full text-xs p-1 border rounded ${inputBorder} bg-white dark:bg-black`}
                                    />
                                    
                                    <div className="flex items-center mt-1">
                                            <input 
                                                type="number" 
                                                value={part.priceHT} 
                                                onChange={(e) => updatePartPrice(part.uuid, e.target.value)}
                                                className={`w-20 text-xs p-1 border rounded ${inputBorder} bg-white dark:bg-black`}
                                            />
                                            <span className="text-[10px] ml-1">CHF</span>
                                    </div>
                                </div>
                                
                                <button onClick={() => removePartToReplace(part.uuid)} className="text-slate-400 hover:text-red-500 transition-colors p-1"><Trash2 size={14}/></button>
                                </div>
                            );
                        })}
                    </div>
                    </div>

                    <div className={`mb-8 p-4 rounded-lg border border-dashed ${panelBorder} bg-slate-50 dark:bg-slate-900/50 no-print`}>
                    <h4 className={`text-sm font-bold ${accentText} uppercase mb-3 flex items-center gap-2`}><Settings size={14} /> Gammes opératoires (Générer l'OF)</h4>
                    <p className="text-xs text-slate-400 mb-2">Sélectionnez une gamme standard pour pré-remplir l'ordre de fabrication.</p>
                    <div className="flex gap-4">
                        <select value={selectedGamme} onChange={(e) => setSelectedGamme(e.target.value)} className={`flex-1 ${inputBg} border ${inputBorder} rounded p-2 text-sm outline-none`}><option value="">-- Choisir une gamme --</option>{Object.entries(GAMMES_OPERATOIRES).map(([k, v]) => (<option key={k} value={k}>{v.label}</option>))}</select>
                        <button onClick={() => launchGamme(selectedGamme)} disabled={!selectedGamme} className="bg-amber-500 text-white px-4 py-2 rounded font-bold text-sm">Générer OF</button>
                    </div>
                    </div>

                    <div className="mb-8 overflow-hidden rounded-lg border border-gray-200">
                    <table className="w-full text-sm text-left">
                        <thead className="bg-gray-100 text-xs uppercase font-bold text-gray-500"><tr><th className="p-3 text-center">Op N°</th><th className="p-3">Description (Editable)</th><th className="p-3 w-32">Département</th><th className="p-3 w-20 text-right">Temps</th><th className="p-3 text-center w-24 no-print">Action</th></tr></thead>
                        <tbody className="divide-y divide-gray-100">
                            {operations.map(op => {
                            const isDone = op.status === 'Terminé';
                            return (
                                <tr key={op.id} className={isDone ? 'bg-green-50' : ''}>
                                <td className="p-3 text-center font-mono text-xs">{op.opNumber}</td>
                                <td className="p-3">
                                    <input 
                                    type="text" 
                                    value={op.description} 
                                    onChange={(e) => updateOperation(op.id, 'description', e.target.value)}
                                    className={`bg-transparent w-full outline-none border-b border-transparent hover:border-gray-300 focus:border-amber-500 ${isDone ? 'text-slate-500 font-medium' : 'font-medium'}`} 
                                    />
                                </td>
                                <td className="p-3">
                                    <select 
                                    value={op.department} 
                                    onChange={(e) => updateOperation(op.id, 'department', e.target.value)}
                                    className="bg-transparent text-xs w-full outline-none"
                                    >
                                        <option value="Atelier Technique">Atelier Technique</option>
                                        <option value="Atelier Habillage">Atelier Habillage</option>
                                        <option value="Atelier Polissage">Atelier Polissage</option>
                                        <option value="Atelier Lavage">Atelier Lavage</option>
                                        <option value="Contrôle Qualité">Contrôle Qualité</option>
                                        <option value="Sous-traitant">Sous-traitant</option>
                                    </select>
                                </td>
                                <td className="p-3 text-right">
                                    <input 
                                    type="number" 
                                    step="0.1" 
                                    value={op.stdTime} 
                                    onChange={(e) => updateOperation(op.id, 'stdTime', e.target.value)}
                                    className="w-12 text-right bg-transparent border-b border-transparent hover:border-gray-300 focus:border-amber-500 outline-none"
                                    />
                                </td>
                                <td className="p-3 flex items-center justify-center gap-2 no-print">
                                    <button onClick={() => toggleOpStatus(op.id)} className={`w-6 h-6 rounded flex items-center justify-center border ${isDone ? 'bg-green-500 border-green-500 text-white' : 'border-gray-300 text-gray-300 hover:border-green-500 hover:text-green-500'}`}><Check size={14}/></button>
                                    <button onClick={() => deleteOperation(op.id)} className="text-red-400 hover:text-red-600"><Trash2 size={16}/></button>
                                </td>
                                </tr>
                            )})}
                            
                            <tr className="bg-slate-50 border-t-2 border-slate-100 no-print">
                                <td className="p-3 text-center font-bold text-slate-400">+</td>
                                <td className="p-3"><input type="text" placeholder="Ajouter une opération manuelle..." value={newOpData.description} onChange={(e) => setNewOpData({...newOpData, description: e.target.value})} className="w-full bg-transparent border-b border-slate-300 focus:border-amber-500 outline-none" /></td>
                                <td className="p-3">
                                <select value={newOpData.department} onChange={(e) => setNewOpData({...newOpData, department: e.target.value})} className="bg-transparent text-xs outline-none">
                                    <option value="Atelier Technique">Atelier Technique</option>
                                    <option value="Atelier Habillage">Atelier Habillage</option>
                                    <option value="Atelier Polissage">Atelier Polissage</option>
                                    <option value="Sous-traitant">Sous-traitant</option>
                                </select>
                                </td>
                                <td className="p-3 text-right"><input type="number" step="0.1" value={newOpData.stdTime} onChange={(e) => setNewOpData({...newOpData, stdTime: e.target.value})} className="w-12 text-right bg-transparent border-b border-slate-300 outline-none" /></td>
                                <td className="p-3 text-center"><button onClick={addManualOperation} disabled={!newOpData.description} className="bg-blue-600 text-white rounded-full p-1 hover:bg-blue-700 disabled:opacity-50"><Plus size={16}/></button></td>
                            </tr>
                        </tbody>
                    </table>
                    </div>

                    <PhotoManager title="Photos composants défectueux / remplacés" category="parts" photos={data.photos || []} updatePhotos={p => updateData({...data, photos: p})} />

                    <div className="mb-8">
                    <div className="flex justify-between items-end mb-4 border-b pb-2">
                        <h4 className={`text-sm font-bold ${accentText} uppercase flex items-center gap-2`}><ListChecks size={18}/> Contrôles & tests finaux</h4>
                        <div className="text-xs font-bold text-slate-400">Avancement : {progress}%</div>
                    </div>
                    
                    <div className="w-full bg-slate-100 rounded-full h-2 mb-6 overflow-hidden">
                        <div className="bg-green-500 h-2 rounded-full transition-all duration-500" style={{width: `${progress}%`}}></div>
                    </div>

                    <div className="grid grid-cols-1 gap-6">
                        
                        <div className={`${panelBg} border ${panelBorder} rounded-lg p-4`}>
                            <h5 className="font-bold text-xs uppercase text-slate-500 mb-3 border-b border-slate-100 pb-2">1. Identité & conformité</h5>
                            <div className="space-y-2">
                            {FINAL_CONTROL_ITEMS.identity.map(item => {
                                const checked = (data.finalControls?.identity || []).includes(item);
                                return (
                                <div key={item} onClick={() => toggleFinalControl('identity', item)} className={`flex items-center gap-3 p-2 rounded cursor-pointer hover:bg-slate-50 dark:hover:bg-slate-700 transition-colors`}>
                                    <div className={`w-5 h-5 rounded border flex items-center justify-center shrink-0 ${checked ? 'bg-blue-600 border-blue-600 text-white' : 'border-gray-300'}`}>{checked && <Check size={12}/>}</div>
                                    <span className={`text-sm ${checked ? 'text-slate-900 dark:text-white font-medium' : 'text-slate-500'}`}>{item}</span>
                                </div>
                                );
                            })}
                            </div>
                        </div>

                        <div className={`${panelBg} border ${panelBorder} rounded-lg p-4`}>
                            <h5 className="font-bold text-xs uppercase text-slate-500 mb-3 border-b border-slate-100 pb-2">2. Esthétique</h5>
                            <div className="space-y-2">
                            {FINAL_CONTROL_ITEMS.aesthetic.map(item => {
                                const checked = (data.finalControls?.aesthetic || []).includes(item);
                                return (
                                <div key={item} onClick={() => toggleFinalControl('aesthetic', item)} className={`flex items-center gap-3 p-2 rounded cursor-pointer hover:bg-slate-50 dark:hover:bg-slate-700 transition-colors`}>
                                    <div className={`w-5 h-5 rounded border flex items-center justify-center shrink-0 ${checked ? 'bg-amber-500 border-amber-500 text-white' : 'border-gray-300'}`}>{checked && <Check size={12}/>}</div>
                                    <span className={`text-sm ${checked ? 'text-slate-900 dark:text-white font-medium' : 'text-slate-500'}`}>{item}</span>
                                </div>
                                );
                            })}
                            </div>
                        </div>

                        <div className={`${panelBg} border ${panelBorder} rounded-lg p-4`}>
                            <h5 className="font-bold text-xs uppercase text-slate-500 mb-3 border-b border-slate-100 pb-2">3. Technique & fonctionnel</h5>
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-x-4 gap-y-2">
                            {FINAL_CONTROL_ITEMS.technical.map(item => {
                                const checked = (data.finalControls?.technical || []).includes(item);
                                return (
                                <div key={item} onClick={() => toggleFinalControl('technical', item)} className={`flex items-center gap-3 p-2 rounded cursor-pointer hover:bg-slate-50 dark:hover:bg-slate-700 transition-colors`}>
                                    <div className={`w-5 h-5 rounded border flex items-center justify-center shrink-0 ${checked ? 'bg-green-600 border-green-600 text-white' : 'border-gray-300'}`}>{checked && <Check size={12}/>}</div>
                                    <span className={`text-sm ${checked ? 'text-slate-900 dark:text-white font-medium' : 'text-slate-500'}`}>{item}</span>
                                </div>
                                );
                            })}
                            </div>
                        </div>
                    </div>
                    </div>

                    <div className="mb-6">
                        <div className="flex justify-between items-center mb-2">
                            <h4 className="font-bold text-xs uppercase text-slate-500 tracking-widest">Mesures finales (Chronométrie)</h4>
                            <div className="flex items-center gap-2">
                                <label className={`text-xs font-bold ${textMain}`}>Réserve de marche (h) :</label>
                                <input 
                                    type="number" 
                                    value={data.powerReserve || ''}
                                    onChange={(e) => updateData({ ...data, powerReserve: e.target.value })}
                                    className={`w-20 p-1 text-center rounded border ${inputBorder} ${inputBg} outline-none focus:border-amber-500 font-mono text-sm`}
                                    placeholder="ex: 48"
                                />
                            </div>
                        </div>
                        <MeasureTable 
                            title="" 
                            measures={data.finalMeasures} 
                            updateMeasure={updateFinalMeasure} 
                        />
                    </div>

                    <div><label className="text-[10px] font-bold uppercase text-slate-400 mb-2 block tracking-widest">Observations techniques de l'horloger</label><textarea rows={4} value={data.workshopNotes || ''} onChange={e => updateData({...data, workshopNotes: e.target.value})} className={`w-full p-4 rounded-lg border ${inputBorder} ${inputBg} text-sm focus:border-amber-500 outline-none shadow-inner`} placeholder="Saisir les notes..." /></div>
                </div>
                <div className={`fixed bottom-0 left-0 right-0 ${panelBg} border-t ${panelBorder} p-4 flex justify-between items-center z-30 md:pl-64 shadow-xl`}>
                    {/* SUPPRESSION BOUTON IMPRIMER */}
                    <button onClick={onValidateStep} className="bg-green-600 text-white px-6 py-3 rounded-lg font-bold flex items-center gap-2 shadow-lg"><CheckCircle size={18}/> Finir Réparation & Suivant</button>
                </div>
                </div>
            );
        };

        const DeliverySheet = ({ data, updateData, onValidateStep }) => {
            const { panelBg, panelBorder, accentText } = useTheme();
            
            const entryItems = [
                { key: 'hasEcrin', label: 'Ecrin' },
                { key: 'hasCertAuth', label: 'Certificat d\'authenticité' },
                { key: 'hasInvoice', label: 'Facture d\'achat' },
                { key: 'hasWarrantyCard', label: 'Carte de garantie' }
            ];

            const toggleReturnCheck = (key) => {
                updateData({ 
                    ...data, 
                    deliveryReturnChecks: { 
                        ...(data.deliveryReturnChecks || {}), 
                        [key]: !data.deliveryReturnChecks?.[key] 
                    } 
                });
            };

            return (
                <div className="p-6 max-w-5xl mx-auto space-y-6 pb-24">
                <div className={`${panelBg} p-10 rounded-xl border ${panelBorder} shadow-lg`}>
                    <h2 className={`text-2xl font-bold ${accentText} mb-8 flex items-center gap-3 uppercase tracking-tighter`}><Gift size={24}/> Livraison client</h2>
                    
                    {/* PHOTO MANAGER POUR LA MONTRE FINIE */}
                    <PhotoManager title="Photos montre terminée (Esthétique finale)" category="final" photos={data.photos || []} updatePhotos={p => updateData({...data, photos: p})} />

                    <div className="grid grid-cols-1 md:grid-cols-2 gap-10 mt-8">
                    <div className="space-y-4">
                        <h4 className="font-bold text-xs uppercase text-slate-400 border-b pb-2 tracking-widest">Contrôle sortie</h4>
                        <div className="space-y-3">{['Nettoyage final effectué', 'Mise à l\'heure & calendrier', 'Documents de garantie signés'].map(i => (<div key={i} className="flex items-center gap-3 text-sm font-medium"><CheckCircle size={18} className="text-green-500 shadow-sm"/>{i}</div>))}</div>
                    </div>
                    
                    <div className="space-y-4">
                        <h4 className="font-bold text-xs uppercase text-slate-400 border-b pb-2 tracking-widest">Éléments à restituer (Vérification entrée)</h4>
                        <div className="space-y-2">
                            {entryItems.map(item => {
                                const wasReceived = data.receivedItems?.[item.key];
                                if (!wasReceived) return null;
                                
                                const isChecked = data.deliveryReturnChecks?.[item.key];

                                return (
                                    <label key={item.key} className={`flex items-center gap-3 p-3 rounded border cursor-pointer transition-all ${isChecked ? 'bg-green-50 border-green-200 text-green-800' : 'bg-white border-gray-200 text-gray-600'}`}>
                                        <input 
                                            type="checkbox" 
                                            checked={!!isChecked} 
                                            onChange={() => toggleReturnCheck(item.key)}
                                            className="w-5 h-5 accent-green-600" 
                                        />
                                        <span className="text-sm font-medium">{item.label}</span>
                                        <span className="text-[10px] uppercase bg-amber-100 text-amber-700 px-2 py-0.5 rounded ml-auto">Reçu</span>
                                    </label>
                                );
                            })}
                            {!Object.values(data.receivedItems || {}).some(v => v === true) && <p className="text-xs text-slate-400 italic">Aucun élément spécifique noté à l'entrée.</p>}
                        </div>
                    </div>

                    <div className="space-y-4 md:col-span-2">
                        <h4 className="font-bold text-xs uppercase text-slate-400 border-b pb-2 tracking-widest">Signature réceptionnaire</h4>
                        <div className="w-full h-32 border-2 border-dashed border-slate-200 rounded-2xl bg-slate-50 flex flex-col items-center justify-center text-slate-300 text-xs italic shadow-inner"><PenTool size={40} className="mb-2 opacity-10"/><p>Signature numérique</p></div>
                    </div>
                    </div>
                </div>
                <div className={`fixed bottom-0 left-0 right-0 ${panelBg} border-t ${panelBorder} p-4 flex justify-end z-30 md:pl-64 shadow-xl`}><button onClick={onValidateStep} className="bg-green-600 text-white px-6 py-3 rounded-lg font-bold flex items-center gap-2 shadow-lg"><CheckCircle size={18}/> Valider livraison & générer rapport</button></div>
                </div>
            );
        };

        const QuoteBuilder = ({ data, updateData, onValidateStep }) => {
            const { panelBg, panelBorder, textMain, accentText, textSec } = useTheme();

            const mandatory = data.quote?.mandatory || [];
            const optional = data.quote?.optional || [];
            const totalMandatory = mandatory.reduce((sum, item) => sum + (item.priceHT || 0), 0);
            const totalOptional = optional.reduce((sum, item) => sum + (item.priceHT || 0), 0);

            const handleAccept = () => {
                updateData({ ...data, statusStep: 4, quoteAcceptedDate: new Date().toISOString() });
                onValidateStep();
            };

            return (
                <div className="p-6 max-w-5xl mx-auto space-y-6 pb-24">
                <div className={`${panelBg} p-8 rounded-xl border ${panelBorder} shadow-lg`} id="quote-print">
                    <div className="flex justify-between items-start mb-8 border-b pb-6">
                    <div>
                        <h1 className="text-2xl font-bold uppercase tracking-widest mb-1 text-slate-900 dark:text-white">Devis de Réparation</h1>
                        <p className="text-sm text-slate-500 font-mono">RÉF: {data.id} / DATE: {new Date().toLocaleDateString()}</p>
                    </div>
                    <div className="text-right">
                        <h2 className="font-bold text-lg">{data.client}</h2>
                        <p className="text-sm text-slate-500">{data.model} - {data.serial}</p>
                    </div>
                    </div>

                    <div className="space-y-8">
                    <div>
                        <h3 className="font-bold text-sm uppercase text-amber-600 mb-3 border-b border-amber-200 pb-1">Travaux Indispensables (Obligatoires)</h3>
                        <p className="text-xs text-slate-500 mb-3 italic">Ces interventions sont nécessaires pour garantir le bon fonctionnement de votre garde-temps.</p>
                        <table className="w-full text-sm">
                            <tbody className="divide-y divide-gray-100">
                                {mandatory.length > 0 ? mandatory.map((item, idx) => (
                                <tr key={idx}>
                                    <td className="py-2">{item.name}</td>
                                    <td className="py-2 text-right font-mono">{item.priceHT === 0 ? 'Inclus/Gar.' : `${item.priceHT.toFixed(2)} CHF`}</td>
                                </tr>
                                )) : <tr><td colSpan="2" className="py-2 text-slate-400 italic">Aucun travaux obligatoire spécifique.</td></tr>}
                            </tbody>
                            <tfoot className="font-bold border-t border-gray-200">
                                <tr>
                                <td className="pt-3 text-right uppercase text-xs">Sous-total Obligatoire HT</td>
                                <td className="pt-3 text-right">{totalMandatory.toFixed(2)} CHF</td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>

                    {optional.length > 0 && (
                        <div>
                            <h3 className="font-bold text-sm uppercase text-blue-600 mb-3 border-b border-blue-200 pb-1">Travaux Esthétiques (Optionnels)</h3>
                            <p className="text-xs text-slate-500 mb-3 italic">Ces interventions sont recommandées pour redonner l'éclat d'origine mais ne sont pas techniques.</p>
                            <table className="w-full text-sm">
                            <tbody className="divide-y divide-gray-100">
                                {optional.map((item, idx) => (
                                    <tr key={idx}>
                                        <td className="py-2 flex items-center gap-2">
                                        <input type="checkbox" className="accent-blue-600" defaultChecked />
                                        {item.name}
                                        </td>
                                        <td className="py-2 text-right font-mono">{item.priceHT === 0 ? 'Offert' : `${item.priceHT.toFixed(2)} CHF`}</td>
                                    </tr>
                                ))}
                            </tbody>
                            </table>
                        </div>
                    )}

                    <div className="bg-slate-50 dark:bg-slate-900 p-4 rounded-lg flex justify-between items-center mt-6">
                        <div className="text-xs text-slate-500 max-w-md">
                            * Les prix sont indiqués en CHF Hors Taxes. La TVA de 8.1% sera ajoutée à la facturation finale. Garantie de 2 ans sur l'intervention.
                        </div>
                        <div className="text-right">
                            <div className="text-sm uppercase text-slate-500 font-bold">Total Estimé HT</div>
                            <div className="text-2xl font-bold text-amber-600">{(totalMandatory + totalOptional).toFixed(2)} CHF</div>
                        </div>
                    </div>
                    </div>
                </div>

                <div className={`fixed bottom-0 left-0 right-0 ${panelBg} border-t ${panelBorder} p-4 flex justify-between z-30 md:pl-64 shadow-xl`}>
                    <button className="text-red-500 font-bold text-sm px-4 py-2 hover:bg-red-50 rounded">Refuser le devis</button>
                    <div className="flex gap-4">
                        {/* SUPPRESSION BOUTON IMPRIMER */}
                        <button onClick={handleAccept} className="bg-green-600 text-white px-6 py-2 rounded-lg font-bold flex items-center gap-2 shadow-lg hover:scale-105 transition-transform"><CheckCircle size={18}/> Accepter & Lancer réparation</button>
                    </div>
                </div>
                </div>
            );
        };

        const FinalReportSheet = ({ data, onValidateStep }) => {
            const { panelBg, panelBorder, accentText } = useTheme();
            
            const receiptPhotos = (data.photos || []).filter(p => p.category === 'receipt');
            const partsPhotos = (data.photos || []).filter(p => p.category === 'parts');
            const finalPhotos = (data.photos || []).filter(p => p.category === 'final');

            const operationsPerformed = (data.operations || []).filter(op => op.status === 'Terminé' || !op.status); 

            const calculateAverages = () => {
                if (!data.finalMeasures) return null;
                let totalRate = 0, totalAmp = 0, count = 0;
                let minRate = Infinity, maxRate = -Infinity;

                Object.values(data.finalMeasures).forEach(m => {
                    if (m.rate && m.rate !== '') {
                        const r = parseFloat(m.rate);
                        totalRate += r;
                        if (r < minRate) minRate = r;
                        if (r > maxRate) maxRate = r;
                        count++;
                    }
                    if (m.amp && m.amp !== '') totalAmp += parseFloat(m.amp);
                });

                if (count === 0) return null;
                return {
                    avgRate: (totalRate / count).toFixed(1),
                    avgAmp: (totalAmp / count).toFixed(0),
                    delta: (maxRate - minRate).toFixed(1)
                };
            };

            const averages = calculateAverages();

            return (
                <div className="p-6 max-w-5xl mx-auto space-y-8 pb-24 animate-in fade-in duration-700">
                <div className="bg-white text-slate-900 shadow-2xl p-12 min-h-[1000px] flex flex-col font-serif rounded-sm border relative" id="report-print">
                    
                    <div className="text-center border-b-4 border-double border-slate-900 pb-8 mb-12">
                    <h1 className="text-4xl font-bold tracking-[0.2em] uppercase text-slate-900 mb-2">Rapport de réparation</h1>
                    <p className="text-sm font-sans uppercase tracking-widest text-slate-500">Watch Repair Plus - Atelier d'horlogerie</p>
                    </div>

                    <div className="flex justify-between items-start mb-12 font-sans">
                    <div>
                        <p className="text-xs font-bold text-slate-400 uppercase tracking-widest mb-1">Client</p>
                        <p className="font-bold text-lg">{data.client}</p>
                        <p className="text-sm text-slate-600">Dossier: {data.id}</p>
                    </div>
                    <div className="text-right">
                        <p className="text-xs font-bold text-slate-400 uppercase tracking-widest mb-1">La montre</p>
                        <p className="font-bold text-lg">{data.model}</p>
                        <p className="text-sm font-mono">{data.serial}</p>
                    </div>
                    </div>

                    {/* SECTION 1: ÉTAT INITIAL */}
                    <div className="mb-10">
                    <h3 className="font-sans font-bold text-sm uppercase tracking-widest border-b border-slate-200 pb-2 mb-4 text-amber-700">1. État à réception & diagnostic</h3>
                    
                    <div className="mb-4">
                            <h4 className="font-bold text-xs uppercase text-slate-500 mb-1">Demande client</h4>
                            <p className="text-sm text-slate-700 italic">"{data.customerRequestText || 'Pas de demande spécifique notée'}"</p>
                    </div>
                    
                    <div className="mb-4">
                            <h4 className="font-bold text-xs uppercase text-slate-500 mb-1">Problème remonté</h4>
                            <p className="text-sm text-slate-700">"{data.issue || 'Aucun problème particulier signalé'}"</p>
                    </div>

                    {receiptPhotos.length > 0 ? (
                        <div className="grid grid-cols-4 gap-4">
                            {receiptPhotos.map(p => (
                            <div key={p.id} className="aspect-square bg-slate-100 rounded overflow-hidden border"><img src={p.url} className="w-full h-full object-cover"/></div>
                            ))}
                        </div>
                    ) : <p className="text-xs text-slate-400">Aucune photo à réception.</p>}
                    </div>

                    {/* SECTION 2: INTERVENTION */}
                    <div className="mb-10">
                    <h3 className="font-sans font-bold text-sm uppercase tracking-widest border-b border-slate-200 pb-2 mb-4 text-amber-700">2. Intervention technique</h3>
                    <div className="grid grid-cols-2 gap-8">
                        <div>
                            <h4 className="font-bold text-xs uppercase mb-2">Opérations réalisées</h4>
                            <ul className="list-disc list-inside text-sm text-slate-700 space-y-1">
                                {operationsPerformed.length > 0 ? operationsPerformed.map(op => (
                                    <li key={op.id}>{op.description}</li>
                                )) : <li>Service complet standard</li>}
                            </ul>
                        </div>
                        <div>
                            <h4 className="font-bold text-xs uppercase mb-2">Composants remplacés</h4>
                            {partsPhotos.length > 0 ? (
                            <div className="grid grid-cols-3 gap-2 mb-2">
                                {partsPhotos.map(p => (
                                    <div key={p.id} className="aspect-square bg-slate-100 rounded overflow-hidden border"><img src={p.url} className="w-full h-full object-cover"/></div>
                                ))}
                            </div>
                            ) : <p className="text-xs text-slate-400 mb-2">Aucune photo de composant.</p>}
                            <p className="text-xs text-slate-500 italic">Toutes les pièces remplacées sont d'origine certifiée.</p>
                        </div>
                    </div>
                    </div>

                    {/* SECTION 3: RÉSULTAT FINAL */}
                    <div className="mb-10">
                    <h3 className="font-sans font-bold text-sm uppercase tracking-widest border-b border-slate-200 pb-2 mb-4 text-amber-700">3. Résultat final & Chronométrie</h3>
                    <div className="flex gap-4 items-center bg-slate-50 p-4 rounded mb-4">
                        <div className="flex-1">
                            <p className="text-sm font-bold text-green-700 flex items-center gap-2"><CheckCircle size={16}/> Contrôle qualité validé</p>
                            <p className="text-xs text-slate-500 mt-1">Étanchéité, Marche, Réserve de marche, Esthétique.</p>
                        </div>
                        <div className="text-right">
                            <p className="text-xs font-bold uppercase text-slate-400">Date de fin</p>
                            <p className="font-mono">{new Date().toLocaleDateString()}</p>
                        </div>
                    </div>
                    
                    <div className="grid grid-cols-2 gap-8 mb-6">
                            <div>
                                <h4 className="font-bold text-xs uppercase text-slate-500 mb-2">Synthèse des Performances</h4>
                                <table className="w-full text-sm border-collapse border border-slate-200">
                                    <tbody>
                                        <tr className="border-b border-slate-100">
                                            <td className="p-2 font-medium bg-slate-50">Marche Moyenne</td>
                                            <td className="p-2 text-right font-mono font-bold text-slate-700">{averages ? `${averages.avgRate} s/j` : '-'}</td>
                                        </tr>
                                        <tr className="border-b border-slate-100">
                                            <td className="p-2 font-medium bg-slate-50">Amplitude Moyenne</td>
                                            <td className="p-2 text-right font-mono text-slate-700">{averages ? `${averages.avgAmp}°` : '-'}</td>
                                        </tr>
                                        <tr className="border-b border-slate-100">
                                            <td className="p-2 font-medium bg-slate-50">Delta (Max-Min)</td>
                                            <td className="p-2 text-right font-mono text-slate-700">{averages ? `${averages.delta} s` : '-'}</td>
                                        </tr>
                                        <tr className="border-b border-slate-100">
                                            <td className="p-2 font-bold bg-amber-50 text-amber-900">Réserve de Marche</td>
                                            <td className="p-2 text-right font-mono font-bold text-amber-700">{data.powerReserve ? `${data.powerReserve} Heures` : '-'}</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                            <div>
                                <h4 className="font-bold text-xs uppercase text-slate-500 mb-2">Détail par position</h4>
                                <div className="grid grid-cols-2 gap-2 text-[10px]">
                                    {data.finalMeasures && Object.entries(data.finalMeasures).map(([key, val]) => (
                                        <div key={key} className="bg-slate-50 p-1 border rounded flex justify-between items-center">
                                            <span className="font-bold uppercase text-slate-400">{key}</span>
                                            <span className="font-mono">{val.rate ? `${val.rate}s` : '-'} / {val.amp ? `${val.amp}°` : '-'}</span>
                                        </div>
                                    ))}
                                </div>
                            </div>
                    </div>

                    {finalPhotos.length > 0 ? (
                        <div className="grid grid-cols-2 gap-4">
                            {finalPhotos.map(p => (
                            <div key={p.id} className="aspect-video bg-slate-100 rounded overflow-hidden border shadow-sm"><img src={p.url} className="w-full h-full object-cover"/></div>
                            ))}
                        </div>
                    ) : <p className="text-xs text-slate-400">Aucune photo finale.</p>}
                    </div>

                    <div className="mt-auto pt-8 border-t border-slate-200 text-center">
                    <div className="mt-8 flex justify-center gap-10 text-[10px] uppercase font-bold tracking-widest text-slate-500">
                        <div>Signature de l'horloger</div>
                        <div>Cachet de l'atelier</div>
                    </div>
                    </div>

                </div>
                <div className={`fixed bottom-0 left-0 right-0 ${panelBg} border-t ${panelBorder} p-4 flex justify-between z-30 md:pl-64 shadow-xl`}>
                    {/* SUPPRESSION BOUTON IMPRIMER */}
                    <button onClick={onValidateStep} className="bg-green-600 text-white px-6 py-3 rounded-lg font-bold flex items-center gap-2 shadow-lg"><CheckCircle size={18}/> Aller à la facturation</button>
                </div>
                </div>
            );
        };

        const InvoiceSheet = ({ data, updateData, onValidateStep }) => {
            const { panelBg, panelBorder, textMain, accentText } = useTheme();

            const mandatory = data.quote?.mandatory || [];
            const optional = data.quote?.optional || []; 
            const totalHT = [...mandatory, ...optional].reduce((sum, i) => sum + (i.priceHT || 0), 0);
            const tva = totalHT * VAT_RATE;
            const shipping = data.invoiceShipping || 0;
            const discount = data.invoiceDiscount || 0;
            const totalTTC = totalHT + tva + shipping - discount;

            return (
                <div className="p-6 max-w-5xl mx-auto space-y-6 pb-24 animate-in fade-in">
                <div className="bg-white text-slate-900 shadow-2xl p-10 min-h-[800px] flex flex-col font-sans rounded-sm border relative" id="invoice-print">
                    
                    <div className="flex justify-between items-start mb-12">
                        <div>
                        <h1 className="text-4xl font-bold tracking-tighter uppercase mb-2 text-slate-900">Facture</h1>
                        <p className="text-slate-500 font-medium text-sm">Watch Repair Plus SA</p>
                        <p className="text-slate-500 text-xs">Rue du Rhône 100, 1204 Genève</p>
                        <p className="text-slate-500 text-xs">TVA: CHE-123.456.789</p>
                        </div>
                        <div className="text-right">
                        <div className="mb-4">
                            <h2 className="font-bold text-xl">{data.client}</h2>
                            <p className="text-sm">{data.clientAddress}</p>
                            <p className="text-sm">{data.clientZip} {data.clientCity}</p>
                        </div>
                        <div className="text-sm text-slate-500">
                            <span className="font-bold uppercase mr-2">N° Facture:</span> {data.id.replace('RO', 'FAC')}
                        </div>
                        <div className="text-sm text-slate-500">
                            <span className="font-bold uppercase mr-2">Date:</span> {new Date().toLocaleDateString()}
                        </div>
                        </div>
                    </div>

                    <table className="w-full text-sm mb-8">
                        <thead className="border-b-2 border-slate-900 uppercase text-xs font-bold tracking-widest text-slate-500">
                        <tr>
                            <th className="py-3 text-left">Description</th>
                            <th className="py-3 text-right">Montant HT</th>
                        </tr>
                        </thead>
                        <tbody className="divide-y divide-gray-100">
                        {[...mandatory, ...optional].map((item, i) => (
                            <tr key={i}>
                                <td className="py-3">{item.name}</td>
                                <td className="py-3 text-right font-mono">{item.priceHT === 0 ? '0.00' : item.priceHT.toFixed(2)}</td>
                            </tr>
                        ))}
                        <tr>
                            <td className="py-3 text-slate-500 italic">Frais de port et emballage sécurisé</td>
                            <td className="py-3 text-right font-mono">{shipping.toFixed(2)}</td>
                        </tr>
                        {discount > 0 && (
                            <tr>
                                <td className="py-3 text-green-600 italic">Remise commerciale</td>
                                <td className="py-3 text-right font-mono text-green-600">-{discount.toFixed(2)}</td>
                            </tr>
                        )}
                        </tbody>
                    </table>

                    <div className="flex justify-end mb-12">
                        <div className="w-64">
                        <div className="flex justify-between py-1 text-sm">
                            <span className="text-slate-500">Total HT</span>
                            <span className="font-mono">{(totalHT + shipping - discount).toFixed(2)}</span>
                        </div>
                        <div className="flex justify-between py-1 text-sm">
                            <span className="text-slate-500">TVA (8.1%)</span>
                            <span className="font-mono">{tva.toFixed(2)}</span>
                        </div>
                        <div className="flex justify-between py-3 border-t-2 border-slate-900 mt-2 text-lg font-bold">
                            <span>Total TTC</span>
                            <span>{totalTTC.toFixed(2)} CHF</span>
                        </div>
                        </div>
                    </div>

                    <div className="mt-auto text-center text-xs text-slate-400">
                        <p className="mb-2">Garantie de 24 mois sur les travaux effectués.</p>
                        <p>Merci de votre confiance. Paiement à 30 jours net.</p>
                        <p className="font-mono mt-4">IBAN: CH50 0900 0000 1234 5678 9</p>
                    </div>
                </div>
                
                <div className={`fixed bottom-0 left-0 right-0 ${panelBg} border-t ${panelBorder} p-4 flex justify-between z-30 md:pl-64 shadow-xl`}>
                    <button onClick={onValidateStep} className="bg-green-600 text-white px-6 py-3 rounded-lg font-bold flex items-center gap-2 shadow-lg"><CheckCircle size={18}/> Clôturer le dossier</button>
                </div>
                </div>
            );
        };

        const InternalQuoteSheet = ({ data, updateData, onValidateStep }) => {
            const { panelBg, panelBorder, tableRowHover, textMain, inputBg, inputBorder, textSec, accentText } = useTheme();
            const [suggestedCoverage, setSuggestedCoverage] = useState(null);

            useEffect(() => {
                if (!data.depositDate) return;
                const deposit = new Date(data.depositDate);
                
                if (data.saleDate) {
                const sale = new Date(data.saleDate);
                const diffTime = deposit - sale;
                const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)); 
                if (diffDays >= 0 && diffDays <= 730) {
                    setSuggestedCoverage({ type: 'warranty_sales', reason: `< 2 ans d'achat (${diffDays} jours)` });
                    return;
                }
                }

                if (data.lastRepairDate) {
                const repair = new Date(data.lastRepairDate);
                const diffTime = deposit - repair;
                const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                if (diffDays >= 0 && diffDays <= 365) {
                    setSuggestedCoverage({ type: 'warranty_repair', reason: `< 1 an dernière réparation (${diffDays} jours)` });
                    return;
                }
                }

                setSuggestedCoverage({ type: 'paid', reason: 'Hors délais de garantie' });
            }, [data.saleDate, data.lastRepairDate, data.depositDate]);

            const applySuggestion = () => {
                if (suggestedCoverage) {
                updateData({ ...data, coverageType: suggestedCoverage.type });
                }
            };

            const handlePriceChange = (rowId, newPrice) => {
                const matrix = data.internalQuoteMatrix || {};
                const row = matrix[rowId] || { oblig: false, opt: false, payant: true, gratuit: false, customPrice: '' };
                
                const updatedRow = { ...row, customPrice: newPrice };
                const newMatrix = { ...matrix, [rowId]: updatedRow };
                
                const def = PRICING_DB.find(p => p.id === rowId);
                if (def && (updatedRow.oblig || updatedRow.opt)) {
                    const q = { ...data.quote } || { mandatory: [], optional: [] };
                    
                    q.mandatory = (q.mandatory || []).filter(i => i.id !== rowId);
                    q.optional = (q.optional || []).filter(i => i.id !== rowId);
                    
                    const finalPrice = updatedRow.gratuit ? 0 : (newPrice !== '' ? parseFloat(newPrice) : def.priceHT);
                    
                    const item = { ...def, uuid: `matrix-${rowId}`, priceHT: finalPrice };
                    
                    if (updatedRow.oblig) q.mandatory.push(item);
                    else q.optional.push(item);
                    
                    updateData({ ...data, internalQuoteMatrix: newMatrix, quote: q });
                } else {
                    updateData({ ...data, internalQuoteMatrix: newMatrix });
                }
            };

            const handleToggle = (rowId, field, val) => {
                const matrix = data.internalQuoteMatrix || {};
                const row = matrix[rowId] || { oblig: false, opt: false, payant: true, gratuit: false, customPrice: '' };
                const updated = { ...row, [field]: val };
                
                if (field === 'oblig' && val) updated.opt = false;
                if (field === 'opt' && val) updated.oblig = false;
                if (field === 'payant' && val) updated.gratuit = false;
                if (field === 'gratuit' && val) updated.payant = false;

                const newMatrix = { ...matrix, [rowId]: updated };
                const def = PRICING_DB.find(p => p.id === rowId);
                
                if (def) {
                const q = { ...data.quote } || { mandatory: [], optional: [] };
                q.mandatory = (q.mandatory || []).filter(i => i.id !== rowId);
                q.optional = (q.optional || []).filter(i => i.id !== rowId);
                
                if (updated.oblig || updated.opt) {
                    const priceToUse = (updated.customPrice !== '' && updated.customPrice !== undefined) ? parseFloat(updated.customPrice) : def.priceHT;
                    const finalPrice = updated.gratuit ? 0 : priceToUse;
                    
                    const item = { ...def, uuid: `matrix-${rowId}`, priceHT: finalPrice };
                    if (updated.oblig) q.mandatory.push(item);
                    else q.optional.push(item);
                }
                updateData({ ...data, internalQuoteMatrix: newMatrix, quote: q });
                } else {
                updateData({ ...data, internalQuoteMatrix: newMatrix });
                }
            };

            const handleCoverageChange = (e) => {
                updateData({ ...data, coverageType: e.target.value });
            };

            useEffect(() => {
                if ((!data.internalQuoteMatrix || Object.keys(data.internalQuoteMatrix).length === 0) && data.quote?.mandatory?.length > 0) {
                    const newMatrix = { ...data.internalQuoteMatrix };
                    data.quote.mandatory.forEach(item => {
                        if (item.id) {
                            const isFree = data.coverageType !== 'paid' && !!data.coverageType;
                            newMatrix[item.id] = { 
                                oblig: true, 
                                opt: false, 
                                payant: !isFree, 
                                gratuit: isFree,
                                customPrice: item.priceHT
                            };
                        }
                    });
                    if (JSON.stringify(newMatrix) !== JSON.stringify(data.internalQuoteMatrix)) {
                        updateData({ ...data, internalQuoteMatrix: newMatrix });
                    }
                }
            }, [data.id]); 

            const renderRow = (label, id) => {
                const row = data.internalQuoteMatrix?.[id] || {};
                const def = PRICING_DB.find(p => p.id === id);
                const displayPrice = row.customPrice !== undefined && row.customPrice !== '' ? row.customPrice : (def ? def.priceHT : 0);

                return (
                <tr key={id} className={`border-b ${panelBorder} ${tableRowHover}`}>
                    <td className="p-3 text-sm font-medium">{label}</td>
                    
                    <td className="p-2 text-center">
                        <div className="flex items-center justify-center">
                            <input 
                                type="number" 
                                step="0.01" 
                                className={`w-20 text-right text-xs p-1 border rounded ${inputBorder} ${inputBg} ${textMain}`}
                                value={displayPrice}
                                onChange={(e) => handlePriceChange(id, e.target.value)}
                            />
                            <span className={`text-[10px] ml-1 ${textSec}`}>CHF</span>
                        </div>
                    </td>

                    <td className="p-2 text-center"><input type="checkbox" checked={!!row.oblig} onChange={e => handleToggle(id, 'oblig', e.target.checked)} className="w-4 h-4 accent-red-500" /></td>
                    <td className="p-2 text-center"><input type="checkbox" checked={!!row.opt} onChange={e => handleToggle(id, 'opt', e.target.checked)} className="w-4 h-4 accent-blue-500" /></td>
                    <td className="p-2 text-center"><input type="checkbox" checked={!!row.payant} onChange={e => handleToggle(id, 'payant', e.target.checked)} className="w-4 h-4 accent-green-500" /></td>
                    <td className="p-2 text-center"><input type="checkbox" checked={!!row.gratuit} onChange={e => handleToggle(id, 'gratuit', e.target.checked)} className="w-4 h-4 accent-slate-500" /></td>
                </tr>
                );
            };

            return (
                <div className="p-6 max-w-5xl mx-auto space-y-6 pb-24">
                {/* SECTION TYPE DE PRISE EN CHARGE */}
                <div className={`${panelBg} p-6 rounded-xl border ${panelBorder} mb-6 shadow-sm animate-in fade-in slide-in-from-top-4 duration-500`}>
                    <div className="flex justify-between items-center mb-4">
                        <h3 className={`text-lg font-bold ${accentText} flex items-center gap-2`}>
                            <ShieldCheck size={20} /> Type de prise en charge
                        </h3>
                        {suggestedCoverage && suggestedCoverage.type !== data.coverageType && (
                        <div className="flex items-center gap-2 bg-blue-50 dark:bg-blue-900/30 text-blue-600 dark:text-blue-300 px-3 py-1.5 rounded-lg border border-blue-100 dark:border-blue-800 text-xs animate-pulse">
                            <Lightbulb size={14} className="text-yellow-500"/>
                            <span className="font-bold">Suggestion : {COVERAGE_TYPES.find(c => c.id === suggestedCoverage.type)?.label}</span>
                            <span className="opacity-75 italic">({suggestedCoverage.reason})</span>
                            <button onClick={applySuggestion} className="ml-2 bg-blue-600 hover:bg-blue-700 text-white px-2 py-0.5 rounded text-[10px] font-bold uppercase transition-colors">Appliquer</button>
                        </div>
                        )}
                    </div>
                    
                    <div className="flex flex-col md:flex-row gap-4 items-start md:items-center">
                        <select 
                            value={data.coverageType || 'paid'} 
                            onChange={handleCoverageChange}
                            className={`flex-1 p-3 rounded-lg border ${inputBorder} ${inputBg} ${textMain} outline-none font-medium shadow-sm w-full md:w-auto`}
                        >
                            {COVERAGE_TYPES.map(type => (
                                <option key={type.id} value={type.id}>{type.label}</option>
                            ))}
                        </select>
                        <div className={`p-3 rounded-lg border ${inputBorder} ${inputBg} text-sm flex-1 w-full`}>
                            {data.coverageType === 'warranty_sales' && <span className="text-green-600 flex items-center gap-2 font-bold"><CheckCircle size={16}/> Les pièces et la main d'œuvre devraient être gratuits.</span>}
                            {data.coverageType === 'warranty_repair' && <span className="text-blue-600 flex items-center gap-2 font-bold"><CheckCircle size={16}/> Garantie SAV précédente appliquée.</span>}
                            {data.coverageType === 'goodwill' && <span className="text-amber-600 flex items-center gap-2 font-bold"><Star size={16}/> Geste commercial total ou partiel.</span>}
                            {(!data.coverageType || data.coverageType === 'paid') && <span className="text-slate-500 flex items-center gap-2"><DollarSign size={16}/> Facturation standard au client.</span>}
                        </div>
                    </div>
                </div>

                <div className={`${panelBg} border ${panelBorder} rounded-xl overflow-hidden shadow-lg animate-in slide-in-from-bottom-4 duration-500`}>
                    <table className="w-full text-left border-collapse">
                    <thead className="bg-slate-100 dark:bg-slate-700 text-[10px] font-bold uppercase tracking-widest text-slate-500">
                        <tr>
                            <th className="p-4">Prestations & travaux</th>
                            <th className="p-2 text-center w-24">Prix unitaire</th>
                            <th className="p-2 text-center">Oblig.</th>
                            <th className="p-2 text-center">Opt.</th>
                            <th className="p-2 text-center">Payant</th>
                            <th className="p-2 text-center">Gratuit</th>
                        </tr>
                    </thead>
                    <tbody className={textMain}>
                        <tr className="bg-slate-50 dark:bg-slate-900/50 font-bold"><td colSpan="6" className="p-3 text-amber-600 text-[10px] uppercase tracking-widest">1. Services techniques principaux</td></tr>
                        {renderRow("Service complet", "srv_complet")}
                        {renderRow("Service partiel", "srv_partiel")}
                        {renderRow("Révision du mouvement", "srv_rev_mvt")}
                        {renderRow("Contrôle", "srv_ctrl")}
                        {renderRow("Réglage de la marche", "srv_reglage")}
                        {renderRow("Démagnétisation", "srv_demag")}
                        {renderRow("Test d’étanchéité", "srv_etanche")}
                        {renderRow("Restauration horlogère", "srv_restau")}

                        {/* NOUVELLE SECTION SPECIALISEE */}
                        <tr className="bg-slate-50 dark:bg-slate-900/50 font-bold"><td colSpan="6" className="p-3 text-amber-600 text-[10px] uppercase tracking-widest mt-4">1bis. Services spécialisés / Restauration avancée</td></tr>
                        {renderRow("Restauration complète (Patrimoine)", "srv_restau_compl")}
                        {renderRow("Restauration Grande Complication", "srv_restau_master")}
                        {renderRow("Restauration Habillage & Orfèvrerie", "srv_restau_hab")}
                        {renderRow("Restauration Mouvement Compliqué", "srv_restau_mvt")}
                        {renderRow("Restauration Répétition Minutes", "srv_restau_sonnerie")}
                        {renderRow("Redressage Gongs & Accordage", "srv_redressage")}
                        {renderRow("Contrôle étanchéité", "srv_etanche_na")}

                        <tr className="bg-slate-50 dark:bg-slate-900/50 font-bold"><td colSpan="6" className="p-3 text-amber-600 text-[10px] uppercase tracking-widest mt-4">2. Services quartz</td></tr>
                        {renderRow("Remplacement de pile", "srv_pile")}
                        {renderRow("Contrôle électronique", "srv_ctrl_elec")}

                        <tr className="bg-slate-50 dark:bg-slate-900/50 font-bold"><td colSpan="6" className="p-3 text-amber-600 text-[10px] uppercase tracking-widest mt-4">3. Services esthétiques</td></tr>
                        {renderRow("Polissage du boîtier", "srv_pol_boite")}
                        {renderRow("Polissage du bracelet", "srv_pol_brac")}
                        {renderRow("Rhabillage esthétique", "srv_rhab_est")}
                        {renderRow("Nettoyage du boîtier", "srv_net_boite")}

                        <tr className="bg-slate-50 dark:bg-slate-900/50 font-bold"><td colSpan="6" className="p-3 text-amber-600 text-[10px] uppercase tracking-widest mt-4">4. Services bracelet</td></tr>
                        {renderRow("Ajustement du bracelet", "srv_ajust_brac")}
                        {renderRow("Réparation de bracelet", "srv_rep_brac")}
                        {renderRow("Remplacement de boucle / fermoir", "srv_remp_boucle")}
                        {renderRow("Nettoyage de bracelet", "srv_net_brac")}

                        <tr className="bg-slate-50 dark:bg-slate-900/50 font-bold"><td colSpan="6" className="p-3 text-blue-600 text-[10px] uppercase tracking-widest mt-4">PIÈCES MOUVEMENT</td></tr>
                        {renderRow("Mouvement complet", "pm_mouvement")}
                        {renderRow("Masse", "pm_masse")}
                        {renderRow("Balancier", "pm_balancier")}
                        {renderRow("Pont", "pm_pont")}
                        {renderRow("Barillet", "pm_barillet")}
                        {renderRow("Platine", "pm_platine")}
                        {renderRow("Autre fourniture mouvement", "pm_autre1")}

                        <tr className="bg-slate-50 dark:bg-slate-900/50 font-bold"><td colSpan="6" className="p-3 text-blue-600 text-[10px] uppercase tracking-widest mt-4">PIÈCES HABILLEMENT</td></tr>
                        {renderRow("Boîte complète", "ph_boite_comp")}
                        {renderRow("Fond", "ph_fond")}
                        {renderRow("Lunette", "ph_lunette")}
                        {renderRow("Carrure", "ph_carrure")}
                        {renderRow("Cadran avec pieds", "ph_cadran_pieds")}
                        {renderRow("Cadran sans pied", "ph_cadran_sans")}
                        {renderRow("Cartouche", "ph_cadran_cart")}
                        {renderRow("Changement du bracelet", "ph_bracelet")}
                        {renderRow("Disque", "ph_disque")}
                        {renderRow("Aiguilles (jeu)", "ph_aiguille_jeu")}
                        {renderRow("Glace sus", "ph_glace_sus")}
                        {renderRow("Glace sous", "ph_glace_sous")}
                        {renderRow("Couronne", "ph_couronne")}
                        {renderRow("Tube de couronne", "ph_tube")}
                        {renderRow("Poussoir correcteur", "ph_poussoir_corr")}
                        {renderRow("Poussoir chrono", "ph_poussoir_chrono")}
                        {renderRow("Boucle ardillon", "ph_boucle_ard")}
                        {renderRow("Boucle déployante", "ph_boucle_dep")}
                        {renderRow("Maillon", "ph_maillon")}
                        {renderRow("Fermoir de sécurité", "ph_fermoir")}
                        {renderRow("Coiffe", "ph_coiffe")}
                        {renderRow("Vis maillons", "ph_vis")}
                        {renderRow("Barrette", "ph_barrette")}
                        {renderRow("Attache cuir", "ph_attache")}
                        {renderRow("Entre-cornes", "ph_entrecornes")}
                        {renderRow("Joints", "ph_joints")}
                        
                        {/* NOUVELLES PIECES SPECIALES */}
                        <tr className="bg-slate-50 dark:bg-slate-900/50 font-bold"><td colSpan="6" className="p-3 text-blue-600 text-[10px] uppercase tracking-widest mt-4">PIÈCES SPÉCIALES (REFABRICATION)</td></tr>
                        {renderRow("Fabrication cadran neuf (identique)", "fab_cadran")}
                        {renderRow("Reconstruction Boîtier Or Rose", "fab_boitier")}
                        {renderRow("Fabrication Cadran Émail", "fab_cadran_email")}
                        {renderRow("Fabrication Bracelet Or Intégré", "fab_bracelet_or")}
                        {renderRow("Fabrication Pièces (Came, Ressort)", "fab_pieces")}
                    </tbody>
                    </table>
                </div>
                <div className={`fixed bottom-0 left-0 right-0 ${panelBg} border-t ${panelBorder} p-4 flex justify-end z-30 md:pl-64 shadow-xl`}><button onClick={onValidateStep} className="bg-green-600 text-white px-6 py-3 rounded-lg font-bold flex items-center gap-2 shadow-lg"><CheckCircle size={18}/> Valider le diagnostic & suivant</button></div>
                </div>
            );
        };

        // --- CORE APP ---

        const App = () => {
            const [activeTab, setActiveTab] = useState('dashboard');
            const [isSidebarOpen, setSidebarOpen] = useState(false);
            const [isDark, setIsDark] = useState(false);
            
            // Initial Repairs - Expanded List for Testing
           const initialRepairs = [
  // =========================================================
  // ===================== TES 3 CAS INITIAUX =================
  // =========================================================

  // --- CAS 1 : VACHERON CONSTANTIN "CORNES DE VACHE" 1956 ---
  { 
    id: 'RO-VC-1956', 
    client: 'Famille du Propriétaire (via Phillips)', 
    model: 'VC Chronographe Ref. 6087 « Cornes de Vache »', 
    serial: 'VC-489000', 
    statusStep: 8, // Dossier Clôturé
    depositDate: '2018-09-10', 
    saleDate: '1957-11-05', 
    productionDate: '1956-03-10',
    coverageType: 'paid',
    clientAddress: 'Genève, Suisse', 
    clientZip: '1204', 
    clientCity: 'Genève',
    customerRequestText: "Restauration complète en vue d'une vente aux enchères. Remise en état de marche impérative tout en préservant l'authenticité historique (ne pas polir, garder la patine).",
    issue: "Montre 'dans son jus', jamais restaurée. Poussoirs grippés. Mouvement complet mais huiles figées, encrassement général. Boîtier or jaune oxydé mais sans chocs majeurs.",
    workshopNotes: "Démontage intégral et nettoyage. Mouvement recalibré. Nettoyage ultrasons. Aucun rhabillage du boîtier pour conserver les arêtes d'origine.",
    quote: { 
      mandatory: [
        { id: 'srv_restau_compl', name: 'Restauration complète (Patrimoine)', priceHT: 15000.00, uuid: 'q1-1', type: 'labor' },
        { id: 'fab_cadran', name: 'Fabrication cadran neuf (identique)', priceHT: 8500.00, uuid: 'q1-2', type: 'part' },
        { id: 'srv_etanche_na', name: 'Contrôle étanchéité', priceHT: 0.00, uuid: 'q1-3', type: 'labor' }
      ], 
      optional: [] 
    },
    internalQuoteMatrix: { srv_restau_compl: { oblig: true, customPrice: 15000.00 } },
    checklists: { visual: { 'Carrure': 3, 'Cadran': 2, 'Aiguilles': 2 }, functional: { 'Sonnerie': 0, 'Réglage': 0 } },
    receivedItems: { hasEcrin: false, hasCertAuth: true, docsVerified: true }, 
    finalControls: { identity: FINAL_CONTROL_ITEMS.identity, aesthetic: FINAL_CONTROL_ITEMS.aesthetic, technical: FINAL_CONTROL_ITEMS.technical },
    invoiceDiscount: 0, invoiceShipping: 500,
    powerReserve: 34,
    inspectionMeasures: {
      ch: { rate: 12, amp: 230 },
      cb: { rate: 9, amp: 225 },
      '3h': { rate: 18, amp: 195 },
      '9h': { rate: 10, amp: 185 },
      '12h': { rate: 22, amp: 178 },
      '6h': { rate: 14, amp: 190 }
    },
    finalMeasures: {
      ch: { rate: 2, amp: 295 },
      cb: { rate: 1, amp: 288 },
      '3h': { rate: 0, amp: 255 },
      '9h': { rate: 3, amp: 248 },
      '12h': { rate: 4, amp: 242 },
      '6h': { rate: 1, amp: 250 }
    },
    operations: [
      { id: 'op1', opNumber: 10, department: 'Atelier Technique', description: 'Démontage complet & décontamination Radium', stdTime: '4.00', status: 'Terminé' },
      { id: 'op2', opNumber: 20, department: 'Atelier Technique', description: 'Nettoyage & rhabillage mouvement', stdTime: '8.00', status: 'Terminé' },
      { id: 'op3', opNumber: 30, department: 'Atelier Habillage', description: 'Fabrication cadran copie conforme', stdTime: '12.00', status: 'Terminé' },
      { id: 'op4', opNumber: 40, department: 'Atelier Technique', description: 'Réglage chronographe', stdTime: '6.00', status: 'Terminé' }
    ]
  },

  // --- CAS 2 : AUDEMARS PIGUET QP 1957 ---
  { 
    id: 'RO-AP-1957', 
    client: 'Collection Privée (M. Goldberger)', 
    model: 'AP Ref. 5516 Quantième Perpétuel', 
    serial: 'AP-5516-009', 
    statusStep: 7, // Rapport généré
    depositDate: '2012-03-15', 
    saleDate: '1957-02-15', 
    productionDate: '1955-06-20',
    coverageType: 'paid', // Projet spécial
    clientAddress: 'Via Montenapoleone 12', 
    clientZip: '20121', 
    clientCity: 'Milano',
    customerRequestText: "Restauration complète. Le mécanisme de calendrier perpétuel bloque au passage de l'année bissextile. Le boîtier nécessite un rafraîchissement respectueux.",
    issue: "Boîtier avec oxydation. Cadran légèrement piqué. Mécanisme de sauts de quantième dur. Huiles figées.",
    workshopNotes: "Restauration complète du calibre. Ajustement des cames de QP. Nettoyage boîtier sans polissage agressif.",
    quote: { 
      mandatory: [
        { id: 'srv_restau_master', name: 'Restauration Grande Complication (26f)', priceHT: 45000.00, uuid: 'q2-1', type: 'labor' },
        { id: 'fab_boitier', name: 'Fabrication Boîtier Or Rose (Conforme)', priceHT: 25000.00, uuid: 'q2-2', type: 'part' },
        { id: 'fab_cadran_email', name: 'Fabrication Cadran Émail Historique', priceHT: 5000.00, uuid: 'q2-3', type: 'part' },
        { id: 'fab_pieces', name: 'Refabrication composants (Pivots, Ressorts)', priceHT: 4500.00, uuid: 'q2-4', type: 'part' }
      ], 
      optional: [] 
    },
    internalQuoteMatrix: { srv_restau_master: { oblig: true, customPrice: 45000.00 } },
    checklists: { visual: { 'Carrure': 5, 'Cadran': 5 }, functional: { 'Sonnerie': 1, 'Réglage': 1 } }, 
    receivedItems: { hasEcrin: false, docsVerified: true }, 
    finalControls: { 
      identity: FINAL_CONTROL_ITEMS.identity, 
      aesthetic: FINAL_CONTROL_ITEMS.aesthetic, 
      technical: FINAL_CONTROL_ITEMS.technical 
    },
    powerReserve: 42,
    inspectionMeasures: {
      ch: { rate: -145, amp: 160 },
      cb: { rate: -158, amp: 155 },
      '3h': { rate: -190, amp: 140 },
      '9h': { rate: -185, amp: 142 },
      '12h': { rate: -210, amp: 135 },
      '6h': { rate: -175, amp: 145 }
    },
    finalMeasures: {
      ch: { rate: 6, amp: 275 },
      cb: { rate: 4, amp: 268 },
      '3h': { rate: 1, amp: 235 },
      '9h': { rate: 8, amp: 228 },
      '12h': { rate: 10, amp: 220 },
      '6h': { rate: 3, amp: 230 }
    },
    operations: [
      { id: 'op21', opNumber: 10, department: 'Atelier Technique', description: 'Étude archives & plans 1899', stdTime: '20.00', status: 'Terminé' },
      { id: 'op22', opNumber: 20, department: 'Atelier Habillage', description: 'Usinage & décoration boîtier Or Rose', stdTime: '50.00', status: 'Terminé' },
      { id: 'op23', opNumber: 30, department: 'Atelier Technique', description: 'Restauration Grande Sonnerie & Chrono', stdTime: '40.00', status: 'Terminé' }
    ]
  },

  // --- CAS 3 : PATEK PHILIPPE 2499/101J ---
  { 
    id: 'RO-PP-2499', 
    client: 'M. Tony Kavak', 
    model: 'Patek Philippe 2499/101J', 
    serial: 'PP-Unique-Integrated', 
    statusStep: 6, // En livraison
    depositDate: '2015-06-20', 
    saleDate: '1955-01-01', 
    productionDate: '1954-01-01',
    coverageType: 'paid',
    clientAddress: 'Bahnhofstrasse 30', 
    clientZip: '8001', 
    clientCity: 'Zürich',
    customerRequestText: "Restauration de la configuration d'origine. Le bracelet intégré a été coupé par un ancien propriétaire et des cornes ont été soudées. Demande de suppression des cornes et recréation du bracelet or 'grains de riz'.",
    issue: "Cornes ajoutées visibles (brasures). Carrure légèrement polie. Mouvement CH 27-70 Q en bon état mais huiles vieillissantes. Risque majeur sur poinçons lors de la désoudure.",
    workshopNotes: "Chauffe contrôlée pour retrait cornes. Laser pour effacer traces brasure sans toucher les poinçons. Fabrication maillon par maillon du bracelet or intégré. Révision mouvement standard.",
    quote: { 
      mandatory: [
        { id: 'fab_bracelet_or', name: 'Fabrication Bracelet Or Intégré (Grains de riz)', priceHT: 18000.00, uuid: 'q3-1', type: 'part' },
        { id: 'srv_restau_hab', name: 'Restauration Carrure (Suppression cornes)', priceHT: 12000.00, uuid: 'q3-2', type: 'labor' },
        { id: 'srv_rev_mvt_compl', name: 'Révision Mouvement QP Chrono', priceHT: 3500.00, uuid: 'q3-3', type: 'labor' }
      ], 
      optional: [
        { id: 'srv_pol_boite', name: 'Léger avivage final', priceHT: 180.00, uuid: 'q3-opt-1', type: 'labor' }
      ] 
    },
    internalQuoteMatrix: { fab_bracelet_or: { oblig: true, customPrice: 18000.00 } },
    checklists: { visual: { 'Carrure': 1, 'Bracelet': 0 }, functional: { 'Réglage': 3, 'Étanchéité': 2 } },
    receivedItems: { hasEcrin: true, hasCertAuth: true, docsVerified: true },
    finalControls: { 
      identity: FINAL_CONTROL_ITEMS.identity, 
      aesthetic: FINAL_CONTROL_ITEMS.aesthetic, 
      technical: FINAL_CONTROL_ITEMS.technical 
    },
    deliveryReturnChecks: { hasEcrin: true, hasCertAuth: true },
    powerReserve: 58,
    inspectionMeasures: {
      ch: { rate: 3, amp: 285 },
      cb: { rate: 2, amp: 278 },
      '3h': { rate: 6, amp: 235 },
      '9h': { rate: 8, amp: 225 },
      '12h': { rate: 10, amp: 220 },
      '6h': { rate: 5, amp: 228 }
    },
    finalMeasures: {
      ch: { rate: 1, amp: 300 },
      cb: { rate: 2, amp: 292 },
      '3h': { rate: -1, amp: 260 },
      '9h': { rate: 3, amp: 252 },
      '12h': { rate: 4, amp: 248 },
      '6h': { rate: 0, amp: 255 }
    },
    operations: [
      { id: 'op31', opNumber: 10, department: 'Atelier Polissage', description: 'Désoudure cornes & reprise laser', stdTime: '15.00', status: 'Terminé' },
      { id: 'op32', opNumber: 20, department: 'Atelier Habillage', description: 'Fabrication & assemblage bracelet', stdTime: '30.00', status: 'Terminé' },
      { id: 'op33', opNumber: 30, department: 'Atelier Technique', description: 'Rhabillage mouvement QP', stdTime: '6.00', status: 'Terminé' }
    ]
  },

  // =========================================================
  // ================= 10 DOSSIERS DE RESTAURATION =============
  // =========================================================

  // --- CAS 4 : ROLEX SUBMARINER 5513 (1967) ---
  {
    id: 'RO-RX-5513-1967',
    client: 'Succession familiale (Notaire - Lausanne)',
    model: 'Rolex Submariner Ref. 5513 (Meters First)',
    serial: 'RX-1.68M-5513',
    statusStep: 7, // Rapport généré
    depositDate: '2023-02-06',
    saleDate: '1968-04-12',
    productionDate: '1967-10-18',
    coverageType: 'paid',
    clientAddress: 'Avenue d’Ouchy 18',
    clientZip: '1006',
    clientCity: 'Lausanne',
    customerRequestText: "Remise en état de marche fiable pour transmission. Conserver cadran et aiguilles d’origine (patine tritium), éviter polissage. Étanchéité minimale souhaitée (usage quotidien prudent).",
    issue: "Montre arrêtée depuis des années. Traces d’humidité anciennes au fond. Couronne/tube fatigués. Amplitude très faible, huiles sèches, marche instable. Lunette dure. Plexi rayé.",
    workshopNotes: "Service complet calibre. Désoxydation contrôlée. Remplacement tube + couronne OEM. Conservation cadran/aiguilles (pas de relume). Changement joints + test étanchéité (usage limité). Plexi remplacé (pièce service), plexi d’origine conservé en sachet.",
    quote: {
      mandatory: [
        { id: 'srv_full_service_auto', name: 'Révision complète mouvement automatique', priceHT: 1200.00, uuid: 'q4-1', type: 'labor' },
        { id: 'rep_crown_tube', name: 'Remplacement couronne + tube (OEM)', priceHT: 420.00, uuid: 'q4-2', type: 'part' },
        { id: 'rep_crystal', name: 'Remplacement plexi + conservation ancien', priceHT: 180.00, uuid: 'q4-3', type: 'part' },
        { id: 'srv_pressure_test', name: 'Test étanchéité + joints', priceHT: 120.00, uuid: 'q4-4', type: 'labor' }
      ],
      optional: [
        { id: 'opt_bracelet_service', name: 'Nettoyage bracelet + micro-ajustements', priceHT: 160.00, uuid: 'q4-opt-1', type: 'labor' }
      ]
    },
    internalQuoteMatrix: { srv_full_service_auto: { oblig: true, customPrice: 1200.00 } },
    checklists: { visual: { 'Carrure': 2, 'Cadran': 1, 'Aiguilles': 1, 'Bracelet': 2 }, functional: { 'Réglage': 1, 'Étanchéité': 2 } },
    receivedItems: { hasEcrin: false, hasCertAuth: false, docsVerified: true },
    finalControls: { identity: FINAL_CONTROL_ITEMS.identity, aesthetic: FINAL_CONTROL_ITEMS.aesthetic, technical: FINAL_CONTROL_ITEMS.technical },
    invoiceDiscount: 0,
    invoiceShipping: 80,
    powerReserve: 44,
    inspectionMeasures: {
      ch: { rate: -85, amp: 165 },
      cb: { rate: -92, amp: 160 },
      '3h': { rate: -120, amp: 150 },
      '9h': { rate: -115, amp: 148 },
      '12h': { rate: -130, amp: 145 },
      '6h': { rate: -105, amp: 152 }
    },
    finalMeasures: {
      ch: { rate: 4, amp: 285 },
      cb: { rate: 2, amp: 278 },
      '3h': { rate: 3, amp: 248 },
      '9h': { rate: 5, amp: 242 },
      '12h': { rate: 6, amp: 238 },
      '6h': { rate: 2, amp: 252 }
    },
    operations: [
      { id: 'op41', opNumber: 10, department: 'Atelier Technique', description: 'Diagnostic + démontage + nettoyage ultrasons', stdTime: '3.50', status: 'Terminé' },
      { id: 'op42', opNumber: 20, department: 'Atelier Technique', description: 'Révision complète + remplacement pièces d’usure', stdTime: '4.50', status: 'Terminé' },
      { id: 'op43', opNumber: 30, department: 'Atelier Habillage', description: 'Remplacement tube/couronne + joints + test étanchéité', stdTime: '1.80', status: 'Terminé' },
      { id: 'op44', opNumber: 40, department: 'Contrôle Qualité', description: 'Réglage final + contrôle marche multi-positions', stdTime: '1.20', status: 'Terminé' }
    ]
  },

  // --- CAS 5 : OMEGA SPEEDMASTER 105.012 (1966) ---
  {
    id: 'RO-OM-105012-1966',
    client: 'Collection Privée (Paris - dépôt boutique)',
    model: 'Omega Speedmaster 105.012-66 “Professional”',
    serial: 'OM-24.32M-105012',
    statusStep: 6, // En livraison
    depositDate: '2022-11-21',
    saleDate: '1967-03-08',
    productionDate: '1966-07-14',
    coverageType: 'paid',
    clientAddress: 'Rue de la Paix 9',
    clientZip: '75002',
    clientCity: 'Paris',
    customerRequestText: "Restauration fonctionnelle en conservant l’aspect d’origine. Chronographe doit repartir (aiguilles et remise à zéro). Ne pas toucher au cadran tritium. Remplacer seulement ce qui est nécessaire.",
    issue: "Chronographe ne démarre plus. Remise à zéro aléatoire. Poussoirs durs, friction anormale. Hésalite fendu. Traces de poussière dans le mouvement. Réserve de marche faible.",
    workshopNotes: "Service complet calibre chrono manuel. Remplacement poussoirs + joints. Remplacement hésalite (ancien conservé). Réglage chrono (embrayage / marteaux). Contrôle amplitude et stabilité.",
    quote: {
      mandatory: [
        { id: 'srv_rev_chrono', name: 'Révision chronographe manuel (calibre vintage)', priceHT: 1450.00, uuid: 'q5-1', type: 'labor' },
        { id: 'rep_pushers', name: 'Remplacement poussoirs + joints', priceHT: 260.00, uuid: 'q5-2', type: 'part' },
        { id: 'rep_hesalite', name: 'Remplacement verre hésalite (OEM)', priceHT: 140.00, uuid: 'q5-3', type: 'part' }
      ],
      optional: [
        { id: 'opt_bracelet_refit', name: 'Nettoyage + remise en forme bracelet', priceHT: 220.00, uuid: 'q5-opt-1', type: 'labor' }
      ]
    },
    internalQuoteMatrix: { srv_rev_chrono: { oblig: true, customPrice: 1450.00 } },
    checklists: { visual: { 'Carrure': 2, 'Cadran': 1, 'Aiguilles': 1, 'Bracelet': 2 }, functional: { 'Réglage': 2, 'Chronographe': 0, 'Étanchéité': 3 } },
    receivedItems: { hasEcrin: false, hasCertAuth: false, docsVerified: true },
    finalControls: { identity: FINAL_CONTROL_ITEMS.identity, aesthetic: FINAL_CONTROL_ITEMS.aesthetic, technical: FINAL_CONTROL_ITEMS.technical },
    invoiceDiscount: 50,
    invoiceShipping: 100,
    powerReserve: 48,
    inspectionMeasures: {
      ch: { rate: -35, amp: 190 },
      cb: { rate: -42, amp: 185 },
      '3h': { rate: -60, amp: 175 },
      '9h': { rate: -55, amp: 172 },
      '12h': { rate: -65, amp: 168 },
      '6h': { rate: -50, amp: 178 }
    },
    finalMeasures: {
      ch: { rate: 3, amp: 285 },
      cb: { rate: 2, amp: 280 },
      '3h': { rate: 4, amp: 250 },
      '9h': { rate: 5, amp: 248 },
      '12h': { rate: 6, amp: 242 },
      '6h': { rate: 3, amp: 255 }
    },
    operations: [
      { id: 'op51', opNumber: 10, department: 'Atelier Technique', description: 'Démontage chrono + contrôle organes de commande', stdTime: '3.00', status: 'Terminé' },
      { id: 'op52', opNumber: 20, department: 'Atelier Technique', description: 'Nettoyage + rhabillage + lubrification', stdTime: '5.00', status: 'Terminé' },
      { id: 'op53', opNumber: 30, department: 'Atelier Habillage', description: 'Remplacement verre + poussoirs + joints', stdTime: '1.20', status: 'Terminé' },
      { id: 'op54', opNumber: 40, department: 'Contrôle Qualité', description: 'Réglage chrono + tests 24h + contrôle remise à zéro', stdTime: '1.50', status: 'Terminé' }
    ]
  },

  // --- CAS 6 : JAEGER-LECOULTRE MEMOVOX POLARIS (1968) ---
  {
    id: 'RO-JLC-POLARIS-1968',
    client: 'M. R. (Genève)',
    model: 'Jaeger-LeCoultre Memovox Polaris E859',
    serial: 'JLC-E859-0112',
    statusStep: 5, // Contrôle final
    depositDate: '2024-03-18',
    saleDate: '1969-01-22',
    productionDate: '1968-05-09',
    coverageType: 'paid',
    clientAddress: 'Quai du Mont-Blanc 7',
    clientZip: '1201',
    clientCity: 'Genève',
    customerRequestText: "Remise en état complète du réveil + révision. Conserver cadran d’origine, pas de polissage. Étanchéité de base après joints (pas plongée).",
    issue: "Réveil ne sonne plus. Couronnes dures. Mouvement encrassé. Traces d’oxydation légères sous fond. Lunette interne grippée. Joint fond cuit.",
    workshopNotes: "Révision complète + restauration module Memovox. Dégrippage lunette interne. Remplacement joints + test pression faible. Conservation esthétique.",
    quote: {
      mandatory: [
        { id: 'srv_rev_alarm', name: 'Révision complète + module réveil Memovox', priceHT: 1650.00, uuid: 'q6-1', type: 'labor' },
        { id: 'rep_seals_set', name: 'Kit joints (fond/couronnes/verre) + contrôle', priceHT: 180.00, uuid: 'q6-2', type: 'part' }
      ],
      optional: [
        { id: 'opt_crown_replace', name: 'Remplacement couronne (si non conforme)', priceHT: 220.00, uuid: 'q6-opt-1', type: 'part' }
      ]
    },
    internalQuoteMatrix: { srv_rev_alarm: { oblig: true, customPrice: 1650.00 } },
    checklists: { visual: { 'Carrure': 2, 'Cadran': 1, 'Aiguilles': 1 }, functional: { 'Réglage': 2, 'Sonnerie': 0, 'Étanchéité': 3 } },
    receivedItems: { hasEcrin: false, hasCertAuth: false, docsVerified: true },
    finalControls: { identity: FINAL_CONTROL_ITEMS.identity, aesthetic: FINAL_CONTROL_ITEMS.aesthetic, technical: FINAL_CONTROL_ITEMS.technical },
    invoiceDiscount: 0,
    invoiceShipping: 0,
    powerReserve: 42,
    inspectionMeasures: {
      ch: { rate: -70, amp: 175 },
      cb: { rate: -78, amp: 170 },
      '3h': { rate: -85, amp: 165 },
      '9h': { rate: -80, amp: 163 },
      '12h': { rate: -95, amp: 158 },
      '6h': { rate: -82, amp: 162 }
    },
    finalMeasures: {
      ch: { rate: 4, amp: 275 },
      cb: { rate: 3, amp: 268 },
      '3h': { rate: 5, amp: 240 },
      '9h': { rate: 6, amp: 238 },
      '12h': { rate: 7, amp: 232 },
      '6h': { rate: 3, amp: 245 }
    },
    operations: [
      { id: 'op61', opNumber: 10, department: 'Atelier Technique', description: 'Diagnostic + démontage + nettoyage', stdTime: '3.20', status: 'Terminé' },
      { id: 'op62', opNumber: 20, department: 'Atelier Technique', description: 'Rhabillage + réglage module Memovox', stdTime: '4.80', status: 'Terminé' },
      { id: 'op63', opNumber: 30, department: 'Atelier Habillage', description: 'Dégrippage lunette interne + joints', stdTime: '1.30', status: 'Terminé' },
      { id: 'op64', opNumber: 40, department: 'Contrôle Qualité', description: 'Test réveil + contrôle marche multi-positions', stdTime: '1.40', status: 'En cours' }
    ]
  },

  // --- CAS 7 : CARTIER TANK CINTRÉE (1928) ---
  {
    id: 'RO-CAR-TANK-1928',
    client: 'Galerie / Antiquaire (Bruxelles)',
    model: 'Cartier Tank Cintrée (art déco) - or jaune',
    serial: 'CAR-TC-1928-044',
    statusStep: 4, // En atelier
    depositDate: '2021-05-03',
    saleDate: '1929-02-14',
    productionDate: '1928-09-22',
    coverageType: 'paid',
    clientAddress: 'Rue du Grand Sablon 48',
    clientZip: '1000',
    clientCity: 'Bruxelles',
    customerRequestText: "Restauration patrimoniale pour vente de galerie. Stabiliser le cadran (micro-fissures) et fiabiliser le mouvement. Ne pas polir. Remettre une couronne conforme avec cabochon.",
    issue: "Cadran présente craquelures + pertes de matière localisées. Mouvement fragile, huiles figées, échappement sec. Couronne non d’origine, tige usée. Verre rayé.",
    workshopNotes: "Service complet manuel. Stabilisation cadran (consolidation, pas de repeinture invasive). Fabrication/pose couronne conforme + cabochon. Remplacement verre. Réglage fin faible couple.",
    quote: {
      mandatory: [
        { id: 'srv_restau_vintage_manual', name: 'Restauration mouvement manuel (patrimoine)', priceHT: 2200.00, uuid: 'q7-1', type: 'labor' },
        { id: 'srv_cadran_stab', name: 'Stabilisation cadran ancien (conservation)', priceHT: 950.00, uuid: 'q7-2', type: 'labor' },
        { id: 'fab_crown_cab', name: 'Fabrication couronne conforme + cabochon', priceHT: 680.00, uuid: 'q7-3', type: 'part' },
        { id: 'rep_glass', name: 'Remplacement verre (forme spécifique)', priceHT: 240.00, uuid: 'q7-4', type: 'part' }
      ],
      optional: []
    },
    internalQuoteMatrix: { srv_restau_vintage_manual: { oblig: true, customPrice: 2200.00 } },
    checklists: { visual: { 'Carrure': 2, 'Cadran': 0, 'Aiguilles': 2 }, functional: { 'Réglage': 1 } },
    receivedItems: { hasEcrin: false, hasCertAuth: false, docsVerified: true },
    finalControls: { identity: FINAL_CONTROL_ITEMS.identity, aesthetic: FINAL_CONTROL_ITEMS.aesthetic, technical: FINAL_CONTROL_ITEMS.technical },
    invoiceDiscount: 0,
    invoiceShipping: 150,
    powerReserve: 33,
    inspectionMeasures: {
      ch: { rate: -180, amp: 140 },
      cb: { rate: -195, amp: 135 },
      '3h': { rate: -220, amp: 128 },
      '9h': { rate: -210, amp: 130 },
      '12h': { rate: -235, amp: 125 },
      '6h': { rate: -205, amp: 132 }
    },
    finalMeasures: {
      ch: { rate: 8, amp: 255 },
      cb: { rate: 6, amp: 248 },
      '3h': { rate: 10, amp: 220 },
      '9h': { rate: 9, amp: 218 },
      '12h': { rate: 12, amp: 212 },
      '6h': { rate: 7, amp: 225 }
    },
    operations: [
      { id: 'op71', opNumber: 10, department: 'Atelier Technique', description: 'Démontage + nettoyage + contrôle usures', stdTime: '4.00', status: 'Terminé' },
      { id: 'op72', opNumber: 20, department: 'Atelier Cadran', description: 'Consolidation cadran (micro-fissures) + retouches conservatoires', stdTime: '6.00', status: 'En cours' },
      { id: 'op73', opNumber: 30, department: 'Atelier Habillage', description: 'Couronne conforme + cabochon + remplacement verre', stdTime: '2.50', status: 'À faire' },
      { id: 'op74', opNumber: 40, department: 'Contrôle Qualité', description: 'Réglage + contrôle marche 48h', stdTime: '1.50', status: 'À faire' }
    ]
  },

  // --- CAS 8 : IWC PORTUGIESER (1939) ---
  {
    id: 'RO-IWC-PORT-1939',
    client: 'M. K. (Zürich) - héritage',
    model: 'IWC Portugieser Réf. 325 (calibre 74)',
    serial: 'IWC-74-1939-602',
    statusStep: 3, // Devis validé
    depositDate: '2024-10-07',
    saleDate: '1940-03-05',
    productionDate: '1939-11-19',
    coverageType: 'paid',
    clientAddress: 'Rennweg 22',
    clientZip: '8001',
    clientCity: 'Zürich',
    customerRequestText: "Restauration complète pour porter occasionnellement. Conserver le cadran (patine), pas de polissage agressif. Remplacer uniquement les pièces mécaniques nécessaires.",
    issue: "Marche très irrégulière, arrêt aléatoire. Axe de balancier suspect (chocs anciens). Pivots usés, jeu important. Couronne d’époque très fatiguée. Cadran patiné mais stable.",
    workshopNotes: "Service complet. Remplacement axe balancier si confirmé. Reprise pivotage sur platine si nécessaire. Couronne remplacée par pièce conforme. Contrôle de précision raisonnable pour calibre ancien.",
    quote: {
      mandatory: [
        { id: 'srv_restau_pocket_cal', name: 'Restauration calibre ancien type poche (IWC 74)', priceHT: 2800.00, uuid: 'q8-1', type: 'labor' },
        { id: 'rep_balance_staff', name: 'Refabrication axe de balancier (si nécessaire)', priceHT: 520.00, uuid: 'q8-2', type: 'part' },
        { id: 'rep_crown_vintage', name: 'Couronne conforme + étanchéité minimale', priceHT: 260.00, uuid: 'q8-3', type: 'part' }
      ],
      optional: [
        { id: 'opt_hands_refinish', name: 'Nettoyage/aiguille (oxydation légère) sans remplacement', priceHT: 180.00, uuid: 'q8-opt-1', type: 'labor' }
      ]
    },
    internalQuoteMatrix: { srv_restau_pocket_cal: { oblig: true, customPrice: 2800.00 } },
    checklists: { visual: { 'Carrure': 3, 'Cadran': 1, 'Aiguilles': 2 }, functional: { 'Réglage': 1 } },
    receivedItems: { hasEcrin: true, hasCertAuth: false, docsVerified: true },
    finalControls: { identity: FINAL_CONTROL_ITEMS.identity, aesthetic: FINAL_CONTROL_ITEMS.aesthetic, technical: FINAL_CONTROL_ITEMS.technical },
    invoiceDiscount: 0,
    invoiceShipping: 0,
    powerReserve: 40,
    inspectionMeasures: {
      ch: { rate: -240, amp: 120 },
      cb: { rate: -255, amp: 118 },
      '3h': { rate: -270, amp: 112 },
      '9h': { rate: -265, amp: 114 },
      '12h': { rate: -290, amp: 110 },
      '6h': { rate: -260, amp: 115 }
    },
    finalMeasures: {
      ch: { rate: 12, amp: 240 },
      cb: { rate: 10, amp: 235 },
      '3h': { rate: 15, amp: 210 },
      '9h': { rate: 14, amp: 208 },
      '12h': { rate: 18, amp: 202 },
      '6h': { rate: 11, amp: 215 }
    },
    operations: [
      { id: 'op81', opNumber: 10, department: 'Atelier Technique', description: 'Expertise + contrôle axe balancier + pivotage', stdTime: '3.00', status: 'Terminé' },
      { id: 'op82', opNumber: 20, department: 'Atelier Technique', description: 'Rhabillage complet + refabrication/ajustage axe', stdTime: '8.00', status: 'En cours' },
      { id: 'op83', opNumber: 30, department: 'Atelier Habillage', description: 'Couronne + joints + contrôle fermeture', stdTime: '1.20', status: 'À faire' }
    ]
  },

  // --- CAS 9 : BREGUET TYPE XX (1955) ---
  {
    id: 'RO-BRG-TYPEXX-1955',
    client: 'Collection Privée (Monaco)',
    model: 'Breguet Type XX (flyback) - militaire',
    serial: 'BRG-20-1955-219',
    statusStep: 4, // En atelier
    depositDate: '2020-09-14',
    saleDate: '1956-06-11',
    productionDate: '1955-12-03',
    coverageType: 'paid',
    clientAddress: 'Boulevard des Moulins 12',
    clientZip: '98000',
    clientCity: 'Monaco',
    customerRequestText: "Restauration chrono flyback (fonction impérative) + sécurisation luminescent ancien. Conserver l’esprit d’époque, pas de boîtier miroir.",
    issue: "Flyback ne réinitialise pas correctement (retour incomplet). Poussoirs irréguliers. Huiles sèches. Traces de poussière + anciennes projections. Lume ancien instable (risque particules).",
    workshopNotes: "Restauration chrono + mécanisme flyback. Sécurisation du luminescent (fixatif conservatoire). Remplacement joints. Réglage et contrôle longues durées.",
    quote: {
      mandatory: [
        { id: 'srv_restau_flyback', name: 'Restauration chronographe flyback (vintage)', priceHT: 3600.00, uuid: 'q9-1', type: 'labor' },
        { id: 'srv_lume_stabilize', name: 'Stabilisation luminescent ancien (conservatoire)', priceHT: 480.00, uuid: 'q9-2', type: 'labor' },
        { id: 'rep_gaskets', name: 'Remplacement joints + contrôle fermeture', priceHT: 140.00, uuid: 'q9-3', type: 'part' }
      ],
      optional: [
        { id: 'opt_crystal', name: 'Remplacement verre (si micro-fissures)', priceHT: 190.00, uuid: 'q9-opt-1', type: 'part' }
      ]
    },
    internalQuoteMatrix: { srv_restau_flyback: { oblig: true, customPrice: 3600.00 } },
    checklists: { visual: { 'Carrure': 2, 'Cadran': 2, 'Aiguilles': 2 }, functional: { 'Chronographe': 0, 'Réglage': 2, 'Étanchéité': 3 } },
    receivedItems: { hasEcrin: false, hasCertAuth: false, docsVerified: true },
    finalControls: { identity: FINAL_CONTROL_ITEMS.identity, aesthetic: FINAL_CONTROL_ITEMS.aesthetic, technical: FINAL_CONTROL_ITEMS.technical },
    invoiceDiscount: 0,
    invoiceShipping: 200,
    powerReserve: 38,
    inspectionMeasures: {
      ch: { rate: -110, amp: 170 },
      cb: { rate: -125, amp: 165 },
      '3h': { rate: -150, amp: 155 },
      '9h': { rate: -145, amp: 152 },
      '12h': { rate: -165, amp: 148 },
      '6h': { rate: -138, amp: 158 }
    },
    finalMeasures: {
      ch: { rate: 5, amp: 275 },
      cb: { rate: 4, amp: 270 },
      '3h': { rate: 7, amp: 242 },
      '9h': { rate: 8, amp: 240 },
      '12h': { rate: 9, amp: 235 },
      '6h': { rate: 4, amp: 248 }
    },
    operations: [
      { id: 'op91', opNumber: 10, department: 'Atelier Technique', description: 'Démontage chrono + analyse flyback (marteaux/embrayage)', stdTime: '4.00', status: 'Terminé' },
      { id: 'op92', opNumber: 20, department: 'Atelier Technique', description: 'Nettoyage + remplacement pièces usées + lubrification', stdTime: '6.00', status: 'En cours' },
      { id: 'op93', opNumber: 30, department: 'Atelier Cadran', description: 'Fixation conservatoire luminescent ancien', stdTime: '2.00', status: 'À faire' },
      { id: 'op94', opNumber: 40, department: 'Contrôle Qualité', description: 'Réglage + tests chrono 72h', stdTime: '2.00', status: 'À faire' }
    ]
  },

  // --- CAS 10 : BLANCPAIN FIFTY FATHOMS (1960) ---
  {
    id: 'RO-BP-FF-1960',
    client: 'Collection Privée (Milan)',
    model: 'Blancpain Fifty Fathoms (vintage) - plongée',
    serial: 'BP-FF-60-784',
    statusStep: 6, // En livraison
    depositDate: '2019-04-12',
    saleDate: '1961-08-30',
    productionDate: '1960-02-17',
    coverageType: 'paid',
    clientAddress: 'Corso Venezia 14',
    clientZip: '20121',
    clientCity: 'Milano',
    customerRequestText: "Restauration fonctionnelle + sécurisation lunette. Conserver cadran d’origine et patine. Étanchéité minimale uniquement.",
    issue: "Montre irrégulière, arrêt la nuit. Lunette tourne trop librement (cliquet). Oxydation légère sous fond. Ressort barillet fatigué.",
    workshopNotes: "Service complet. Remplacement ressort barillet. Réfection système cliquet lunette. Joints + tests faibles. Conservation esthétique.",
    quote: {
      mandatory: [
        { id: 'srv_rev_auto_vintage', name: 'Révision complète automatique vintage', priceHT: 1600.00, uuid: 'q10-1', type: 'labor' },
        { id: 'rep_mainspring', name: 'Remplacement ressort barillet', priceHT: 240.00, uuid: 'q10-2', type: 'part' },
        { id: 'rep_bezel_click', name: 'Réfection système cliquet lunette', priceHT: 320.00, uuid: 'q10-3', type: 'labor' }
      ],
      optional: [
        { id: 'opt_crystal_polish', name: 'Polissage verre (si acrylique)', priceHT: 90.00, uuid: 'q10-opt-1', type: 'labor' }
      ]
    },
    internalQuoteMatrix: { srv_rev_auto_vintage: { oblig: true, customPrice: 1600.00 } },
    checklists: { visual: { 'Carrure': 2, 'Cadran': 1, 'Lunette': 0 }, functional: { 'Réglage': 2, 'Étanchéité': 3 } },
    receivedItems: { hasEcrin: false, hasCertAuth: false, docsVerified: true },
    finalControls: { identity: FINAL_CONTROL_ITEMS.identity, aesthetic: FINAL_CONTROL_ITEMS.aesthetic, technical: FINAL_CONTROL_ITEMS.technical },
    invoiceDiscount: 0,
    invoiceShipping: 130,
    powerReserve: 46,
    inspectionMeasures: {
      ch: { rate: -95, amp: 160 },
      cb: { rate: -105, amp: 155 },
      '3h': { rate: -125, amp: 148 },
      '9h': { rate: -118, amp: 150 },
      '12h': { rate: -135, amp: 145 },
      '6h': { rate: -110, amp: 152 }
    },
    finalMeasures: {
      ch: { rate: 4, amp: 280 },
      cb: { rate: 3, amp: 272 },
      '3h': { rate: 6, amp: 240 },
      '9h': { rate: 7, amp: 238 },
      '12h': { rate: 8, amp: 232 },
      '6h': { rate: 3, amp: 245 }
    },
    operations: [
      { id: 'op101', opNumber: 10, department: 'Atelier Technique', description: 'Service complet + nettoyage + remplacement barillet', stdTime: '5.50', status: 'Terminé' },
      { id: 'op102', opNumber: 20, department: 'Atelier Habillage', description: 'Réfection cliquet lunette + joints', stdTime: '2.00', status: 'Terminé' },
      { id: 'op103', opNumber: 30, department: 'Contrôle Qualité', description: 'Réglage + test marche + contrôle étanchéité faible', stdTime: '1.50', status: 'Terminé' }
    ]
  },

  // --- CAS 11 : ZENITH EL PRIMERO A386 (1969) ---
  {
    id: 'RO-ZEN-A386-1969',
    client: 'Marchand (Genève - dépôt vente)',
    model: 'Zenith El Primero A386 (chronographe)',
    serial: 'ZEN-A386-69-041',
    statusStep: 5, // Contrôle final
    depositDate: '2023-09-04',
    saleDate: '1970-02-19',
    productionDate: '1969-06-28',
    coverageType: 'paid',
    clientAddress: 'Rue du Rhône 32',
    clientZip: '1204',
    clientCity: 'Genève',
    customerRequestText: "Restauration complète avant mise en vente. Chronographe doit être parfaitement fonctionnel. Boîtier à rafraîchir très légèrement (récupérer alternance brossé/poli sans arrondir).",
    issue: "Chrono fonctionne mais reset décalé. Rotor avec jeu (bruit). Marge de marche importante selon positions. Boîtier trop poli précédemment (angles mous).",
    workshopNotes: "Révision complète El Primero. Remplacement roulement rotor + réglage chrono. Reprise finitions boîtier minimaliste (satinage directionnel + polissage ciblé).",
    quote: {
      mandatory: [
        { id: 'srv_elprimero_full', name: 'Révision complète El Primero + chrono', priceHT: 1950.00, uuid: 'q11-1', type: 'labor' },
        { id: 'rep_rotor_bearing', name: 'Remplacement roulement rotor', priceHT: 260.00, uuid: 'q11-2', type: 'part' },
        { id: 'srv_case_refinish_light', name: 'Rafraîchissement boîtier léger (respect angles)', priceHT: 380.00, uuid: 'q11-3', type: 'labor' }
      ],
      optional: [
        { id: 'opt_crown', name: 'Remplacement couronne (si non conforme)', priceHT: 210.00, uuid: 'q11-opt-1', type: 'part' }
      ]
    },
    internalQuoteMatrix: { srv_elprimero_full: { oblig: true, customPrice: 1950.00 } },
    checklists: { visual: { 'Carrure': 3, 'Cadran': 2, 'Aiguilles': 2 }, functional: { 'Chronographe': 2, 'Réglage': 2, 'Étanchéité': 3 } },
    receivedItems: { hasEcrin: false, hasCertAuth: false, docsVerified: true },
    finalControls: { identity: FINAL_CONTROL_ITEMS.identity, aesthetic: FINAL_CONTROL_ITEMS.aesthetic, technical: FINAL_CONTROL_ITEMS.technical },
    invoiceDiscount: 0,
    invoiceShipping: 0,
    powerReserve: 50,
    inspectionMeasures: {
      ch: { rate: -28, amp: 205 },
      cb: { rate: -35, amp: 200 },
      '3h': { rate: -55, amp: 188 },
      '9h': { rate: -50, amp: 190 },
      '12h': { rate: -60, amp: 184 },
      '6h': { rate: -45, amp: 192 }
    },
    finalMeasures: {
      ch: { rate: 3, amp: 295 },
      cb: { rate: 2, amp: 290 },
      '3h': { rate: 4, amp: 262 },
      '9h': { rate: 5, amp: 260 },
      '12h': { rate: 6, amp: 255 },
      '6h': { rate: 2, amp: 268 }
    },
    operations: [
      { id: 'op111', opNumber: 10, department: 'Atelier Technique', description: 'Démontage + diagnostic chrono + rotor', stdTime: '2.50', status: 'Terminé' },
      { id: 'op112', opNumber: 20, department: 'Atelier Technique', description: 'Nettoyage + remplacement roulement rotor + réglage', stdTime: '5.50', status: 'Terminé' },
      { id: 'op113', opNumber: 30, department: 'Atelier Habillage', description: 'Rafraîchissement boîtier léger (satinage/poli ciblé)', stdTime: '2.20', status: 'En cours' },
      { id: 'op114', opNumber: 40, department: 'Contrôle Qualité', description: 'Contrôle marche + test chrono', stdTime: '1.50', status: 'À faire' }
    ]
  },

  // --- CAS 12 : PATEK PHILIPPE CALATRAVA 2526 (1955) ---
  {
    id: 'RO-PP-2526-1955',
    client: 'Collection Privée (New York via boutique)',
    model: 'Patek Philippe Calatrava Ref. 2526 (cadran émail)',
    serial: 'PP-2526-114XXX',
    statusStep: 4, // En atelier
    depositDate: '2018-01-22',
    saleDate: '1956-05-10',
    productionDate: '1955-08-01',
    coverageType: 'paid',
    clientAddress: 'Madison Ave 677',
    clientZip: '10065',
    clientCity: 'New York',
    customerRequestText: "Restauration technique complète. Le cadran émail doit être préservé (pas de remplacement si possible). Demande d’un rapport détaillé + conservation des pièces remplacées.",
    issue: "Montre fonctionne mais marche instable. Rotor micro-oscillant avec frottements. Traces d’humidité anciennes sur platine. Couronne usée. Cadran émail avec micro-cheveux (stable).",
    workshopNotes: "Service complet calibre. Correction frottement rotor et remplacement pièces d’usure. Couronne neuve conforme. Cadran émail conservé, nettoyage doux uniquement. Pièces remplacées remises en sachet.",
    quote: {
      mandatory: [
        { id: 'srv_pp_restau_auto', name: 'Restauration complète automatique (vintage)', priceHT: 4800.00, uuid: 'q12-1', type: 'labor' },
        { id: 'rep_crown_pp', name: 'Couronne conforme + tube (si nécessaire)', priceHT: 680.00, uuid: 'q12-2', type: 'part' },
        { id: 'srv_report_photo', name: 'Rapport détaillé + photos étapes clés', priceHT: 450.00, uuid: 'q12-3', type: 'labor' }
      ],
      optional: [
        { id: 'opt_case_clean', name: 'Nettoyage boîtier sans polissage (conservatoire)', priceHT: 220.00, uuid: 'q12-opt-1', type: 'labor' }
      ]
    },
    internalQuoteMatrix: { srv_pp_restau_auto: { oblig: true, customPrice: 4800.00 } },
    checklists: { visual: { 'Carrure': 2, 'Cadran': 1, 'Aiguilles': 2 }, functional: { 'Réglage': 2, 'Étanchéité': 3 } },
    receivedItems: { hasEcrin: true, hasCertAuth: true, docsVerified: true },
    finalControls: { identity: FINAL_CONTROL_ITEMS.identity, aesthetic: FINAL_CONTROL_ITEMS.aesthetic, technical: FINAL_CONTROL_ITEMS.technical },
    invoiceDiscount: 0,
    invoiceShipping: 250,
    powerReserve: 44,
    inspectionMeasures: {
      ch: { rate: -55, amp: 185 },
      cb: { rate: -60, amp: 180 },
      '3h': { rate: -78, amp: 172 },
      '9h': { rate: -70, amp: 174 },
      '12h': { rate: -88, amp: 168 },
      '6h': { rate: -65, amp: 176 }
    },
    finalMeasures: {
      ch: { rate: 2, amp: 295 },
      cb: { rate: 1, amp: 290 },
      '3h': { rate: 3, amp: 258 },
      '9h': { rate: 4, amp: 255 },
      '12h': { rate: 5, amp: 250 },
      '6h': { rate: 1, amp: 265 }
    },
    operations: [
      { id: 'op121', opNumber: 10, department: 'Atelier Technique', description: 'Diagnostic + démontage + contrôle rotor micro-oscillant', stdTime: '4.00', status: 'Terminé' },
      { id: 'op122', opNumber: 20, department: 'Atelier Technique', description: 'Nettoyage + rhabillage complet + corrections frottements', stdTime: '10.00', status: 'En cours' },
      { id: 'op123', opNumber: 30, department: 'Atelier Habillage', description: 'Couronne conforme + joints', stdTime: '1.50', status: 'À faire' },
      { id: 'op124', opNumber: 40, department: 'Documentation', description: 'Rapport + photos + mise sous sachet pièces remplacées', stdTime: '2.00', status: 'À faire' }
    ]
  },

  // --- CAS 13 : AUDEMARS PIGUET ROYAL OAK 5402 (1972) ---
  {
    id: 'RO-AP-5402-1972',
    client: 'Collection Privée (Londres)',
    model: 'Audemars Piguet Royal Oak “A-Series” Ref. 5402',
    serial: 'AP-5402-A-072',
    statusStep: 7, // Rapport généré
    depositDate: '2021-08-30',
    saleDate: '1973-04-18',
    productionDate: '1972-12-02',
    coverageType: 'paid',
    clientAddress: 'Bond Street 41',
    clientZip: 'W1S',
    clientCity: 'London',
    customerRequestText: "Restauration complète + reprise finitions Genta (poli/brossé) très contrôlée. Remplacement cadran si instable uniquement. Étanchéité minimale.",
    issue: "Cadran micro-écaillage. Étanchéité nulle. Réserve de marche faible. Boîtier/bracelet rayés avec angles estompés. Rotor avec jeu.",
    workshopNotes: "Révision complète + remplacement roulement rotor. Cadran remplacé par stock conforme (l’ancien conservé). Reprise finitions brossé/poli directionnelles (atelier spécialisé). Joints + tests faibles.",
    quote: {
      mandatory: [
        { id: 'srv_ap_vintage', name: 'Restauration complète vintage (calibre 2121)', priceHT: 5200.00, uuid: 'q13-1', type: 'labor' },
        { id: 'rep_rotor_bearing_ap', name: 'Remplacement roulement rotor', priceHT: 340.00, uuid: 'q13-2', type: 'part' },
        { id: 'rep_dial_ap', name: 'Cadran conforme (stock / refabrication)', priceHT: 2100.00, uuid: 'q13-3', type: 'part' },
        { id: 'srv_finishing_ap', name: 'Reprise finitions boîtier/bracelet (poli/brossé)', priceHT: 1600.00, uuid: 'q13-4', type: 'labor' }
      ],
      optional: []
    },
    internalQuoteMatrix: { srv_ap_vintage: { oblig: true, customPrice: 5200.00 } },
    checklists: { visual: { 'Carrure': 5, 'Bracelet': 4, 'Cadran': 0 }, functional: { 'Réglage': 2, 'Étanchéité': 3 } },
    receivedItems: { hasEcrin: false, hasCertAuth: false, docsVerified: true },
    finalControls: { identity: FINAL_CONTROL_ITEMS.identity, aesthetic: FINAL_CONTROL_ITEMS.aesthetic, technical: FINAL_CONTROL_ITEMS.technical },
    invoiceDiscount: 0,
    invoiceShipping: 180,
    powerReserve: 40,
    inspectionMeasures: {
      ch: { rate: -15, amp: 190 },
      cb: { rate: -18, amp: 185 },
      '3h': { rate: -25, amp: 175 },
      '9h': { rate: -22, amp: 178 },
      '12h': { rate: -30, amp: 172 },
      '6h': { rate: -20, amp: 180 }
    },
    finalMeasures: {
      ch: { rate: 4, amp: 285 },
      cb: { rate: 3, amp: 280 },
      '3h': { rate: 6, amp: 250 },
      '9h': { rate: 7, amp: 248 },
      '12h': { rate: 8, amp: 242 },
      '6h': { rate: 3, amp: 255 }
    },
    operations: [
      { id: 'op131', opNumber: 10, department: 'Atelier Technique', description: 'Démontage + nettoyage ultrasons + contrôle rotor', stdTime: '4.00', status: 'Terminé' },
      { id: 'op132', opNumber: 20, department: 'Atelier Technique', description: 'Rhabillage + remplacement roulement + réglage', stdTime: '6.50', status: 'Terminé' },
      { id: 'op133', opNumber: 30, department: 'Atelier Habillage', description: 'Remplacement cadran + joints', stdTime: '2.00', status: 'Terminé' },
      { id: 'op134', opNumber: 40, department: 'Atelier Polissage', description: 'Finitions Genta (poli/brossé directionnels)', stdTime: '6.00', status: 'Terminé' }
    ]
  },

  // =========================================================
  // =============== 5 CAS DE RÉPARATION SIMPLE ===============
  // =========================================================

  // --- CAS 14 : TISSOT PRX QUARTZ (Pile + joints) ---
  {
    id: 'RS-TIS-PRX-2022',
    client: 'Mme C. (Annecy)',
    model: 'Tissot PRX Quartz 40',
    serial: 'TIS-PRX-2022-771',
    statusStep: 8, // Dossier clôturé
    depositDate: '2025-01-10',
    saleDate: '2022-07-01',
    productionDate: '2022-05-20',
    coverageType: 'paid',
    clientAddress: 'Avenue d’Albigny 6',
    clientZip: '74000',
    clientCity: 'Annecy',
    customerRequestText: "Changement pile + contrôle étanchéité (usage quotidien).",
    issue: "Montre arrêtée. Joint fond sec. Léger voile sous verre après forte humidité (sans corrosion visible).",
    workshopNotes: "Remplacement pile + joint fond. Séchage contrôlé. Test étanchéité basique. Nettoyage extérieur.",
    quote: {
      mandatory: [
        { id: 'srv_battery', name: 'Remplacement pile', priceHT: 35.00, uuid: 'q14-1', type: 'labor' },
        { id: 'rep_gasket_caseback', name: 'Joint fond', priceHT: 12.00, uuid: 'q14-2', type: 'part' },
        { id: 'srv_water_test_basic', name: 'Test étanchéité basique', priceHT: 18.00, uuid: 'q14-3', type: 'labor' }
      ],
      optional: []
    },
    internalQuoteMatrix: { srv_battery: { oblig: true, customPrice: 35.00 } },
    checklists: { visual: { 'Carrure': 3, 'Cadran': 4 }, functional: { 'Réglage': 4, 'Étanchéité': 3 } },
    receivedItems: { hasEcrin: false, hasCertAuth: false, docsVerified: true },
    finalControls: { identity: FINAL_CONTROL_ITEMS.identity, aesthetic: FINAL_CONTROL_ITEMS.aesthetic, technical: FINAL_CONTROL_ITEMS.technical },
    invoiceDiscount: 0,
    invoiceShipping: 0,
    powerReserve: 0,
    inspectionMeasures: {
      ch: { rate: 0, amp: 0 },
      cb: { rate: 0, amp: 0 },
      '3h': { rate: 0, amp: 0 },
      '9h': { rate: 0, amp: 0 },
      '12h': { rate: 0, amp: 0 },
      '6h': { rate: 0, amp: 0 }
    },
    finalMeasures: {
      ch: { rate: 0, amp: 0 },
      cb: { rate: 0, amp: 0 },
      '3h': { rate: 0, amp: 0 },
      '9h': { rate: 0, amp: 0 },
      '12h': { rate: 0, amp: 0 },
      '6h': { rate: 0, amp: 0 }
    },
    operations: [
      { id: 'op141', opNumber: 10, department: 'Atelier SAV', description: 'Remplacement pile + joint fond', stdTime: '0.30', status: 'Terminé' },
      { id: 'op142', opNumber: 20, department: 'Contrôle Qualité', description: 'Test étanchéité basique + contrôle fonctionnel', stdTime: '0.20', status: 'Terminé' }
    ]
  },

  // --- CAS 15 : SEIKO SKX007 (ressort cliquet lunette) ---
  {
    id: 'RS-SEI-SKX007',
    client: 'M. L. (Genève)',
    model: 'Seiko Diver SKX007',
    serial: 'SEI-SKX-007-209',
    statusStep: 8,
    depositDate: '2025-02-03',
    saleDate: '2016-05-12',
    productionDate: '2016-03-01',
    coverageType: 'paid',
    clientAddress: 'Route de Chêne 21',
    clientZip: '1208',
    clientCity: 'Genève',
    customerRequestText: "Lunette tourne trop librement + cliquet “mou”. Réparer sans révision complète.",
    issue: "Ressort cliquet usé/déformé. Accumulation de saletés sous lunette.",
    workshopNotes: "Démontage lunette, nettoyage, remplacement ressort cliquet, graissage adapté.",
    quote: {
      mandatory: [
        { id: 'rep_bezel_spring', name: 'Remplacement ressort cliquet lunette', priceHT: 18.00, uuid: 'q15-1', type: 'part' },
        { id: 'srv_bezel_service', name: 'Démontage/Nettoyage/Graissage lunette', priceHT: 65.00, uuid: 'q15-2', type: 'labor' }
      ],
      optional: []
    },
    internalQuoteMatrix: { srv_bezel_service: { oblig: true, customPrice: 65.00 } },
    checklists: { visual: { 'Carrure': 3, 'Lunette': 1 }, functional: { 'Réglage': 3, 'Étanchéité': 3 } },
    receivedItems: { hasEcrin: false, hasCertAuth: false, docsVerified: true },
    finalControls: { identity: FINAL_CONTROL_ITEMS.identity, aesthetic: FINAL_CONTROL_ITEMS.aesthetic, technical: FINAL_CONTROL_ITEMS.technical },
    invoiceDiscount: 0,
    invoiceShipping: 0,
    powerReserve: 38,
    inspectionMeasures: {
      ch: { rate: -12, amp: 240 },
      cb: { rate: -15, amp: 235 },
      '3h': { rate: -20, amp: 225 },
      '9h': { rate: -18, amp: 228 },
      '12h': { rate: -22, amp: 220 },
      '6h': { rate: -16, amp: 232 }
    },
    finalMeasures: {
      ch: { rate: -10, amp: 245 },
      cb: { rate: -12, amp: 240 },
      '3h': { rate: -18, amp: 230 },
      '9h': { rate: -15, amp: 232 },
      '12h': { rate: -20, amp: 225 },
      '6h': { rate: -12, amp: 235 }
    },
    operations: [
      { id: 'op151', opNumber: 10, department: 'Atelier SAV', description: 'Démontage lunette + nettoyage', stdTime: '0.40', status: 'Terminé' },
      { id: 'op152', opNumber: 20, department: 'Atelier SAV', description: 'Remplacement ressort cliquet + graissage', stdTime: '0.30', status: 'Terminé' }
    ]
  },

  // --- CAS 16 : TAG HEUER CARRERA (couronne/tige) ---
  {
    id: 'RS-TAG-CARRERA-2019',
    client: 'M. P. (Lyon)',
    model: 'TAG Heuer Carrera Calibre 5',
    serial: 'TAG-CAR-2019-114',
    statusStep: 8,
    depositDate: '2025-03-11',
    saleDate: '2019-10-02',
    productionDate: '2019-08-14',
    coverageType: 'paid',
    clientAddress: 'Rue de la République 88',
    clientZip: '69002',
    clientCity: 'Lyon',
    customerRequestText: "Couronne tourne dans le vide, impossible de régler l’heure.",
    issue: "Tige de remontoir usée + filetage couronne endommagé. Risque de casse lors manipulation.",
    workshopNotes: "Remplacement tige + couronne, contrôle mise à l’heure, test fonctionnel.",
    quote: {
      mandatory: [
        { id: 'rep_stem', name: 'Remplacement tige de remontoir', priceHT: 55.00, uuid: 'q16-1', type: 'part' },
        { id: 'rep_crown', name: 'Remplacement couronne', priceHT: 95.00, uuid: 'q16-2', type: 'part' },
        { id: 'srv_setting_check', name: 'Montage + contrôle réglage', priceHT: 60.00, uuid: 'q16-3', type: 'labor' }
      ],
      optional: []
    },
    internalQuoteMatrix: { srv_setting_check: { oblig: true, customPrice: 60.00 } },
    checklists: { visual: { 'Carrure': 4, 'Cadran': 4 }, functional: { 'Réglage': 1 } },
    receivedItems: { hasEcrin: false, hasCertAuth: false, docsVerified: true },
    finalControls: { identity: FINAL_CONTROL_ITEMS.identity, aesthetic: FINAL_CONTROL_ITEMS.aesthetic, technical: FINAL_CONTROL_ITEMS.technical },
    invoiceDiscount: 0,
    invoiceShipping: 0,
    powerReserve: 38,
    inspectionMeasures: {
      ch: { rate: 6, amp: 255 },
      cb: { rate: 7, amp: 250 },
      '3h': { rate: 9, amp: 240 },
      '9h': { rate: 8, amp: 242 },
      '12h': { rate: 10, amp: 238 },
      '6h': { rate: 7, amp: 245 }
    },
    finalMeasures: {
      ch: { rate: 6, amp: 255 },
      cb: { rate: 7, amp: 250 },
      '3h': { rate: 9, amp: 240 },
      '9h': { rate: 8, amp: 242 },
      '12h': { rate: 10, amp: 238 },
      '6h': { rate: 7, amp: 245 }
    },
    operations: [
      { id: 'op161', opNumber: 10, department: 'Atelier SAV', description: 'Dépose couronne/tige + remplacement', stdTime: '0.60', status: 'Terminé' },
      { id: 'op162', opNumber: 20, department: 'Contrôle Qualité', description: 'Contrôle réglage + test fonctionnel', stdTime: '0.20', status: 'Terminé' }
    ]
  },

  // --- CAS 17 : ROLEX DATEJUST (réglage + contrôle étanchéité) ---
  {
    id: 'RS-RX-DJ-16234',
    client: 'M. S. (Genève)',
    model: 'Rolex Datejust 36 Ref. 16234',
    serial: 'RX-DJ-16234-U96',
    statusStep: 8,
    depositDate: '2025-04-22',
    saleDate: '1998-06-05',
    productionDate: '1998-02-19',
    coverageType: 'paid',
    clientAddress: 'Rue de Carouge 33',
    clientZip: '1205',
    clientCity: 'Genève',
    customerRequestText: "Montre avance fortement + contrôle étanchéité avant vacances.",
    issue: "Dérive importante. Joints anciens. Couronne légèrement sèche. Pas de casse visible.",
    workshopNotes: "Régulation simple + remplacement joints couronne/fond + test étanchéité.",
    quote: {
      mandatory: [
        { id: 'srv_regulation', name: 'Régulation simple (sans révision complète)', priceHT: 180.00, uuid: 'q17-1', type: 'labor' },
        { id: 'rep_seals', name: 'Remplacement joints (fond + couronne)', priceHT: 90.00, uuid: 'q17-2', type: 'part' },
        { id: 'srv_pressure', name: 'Test étanchéité', priceHT: 60.00, uuid: 'q17-3', type: 'labor' }
      ],
      optional: []
    },
    internalQuoteMatrix: { srv_regulation: { oblig: true, customPrice: 180.00 } },
    checklists: { visual: { 'Carrure': 4, 'Cadran': 4, 'Bracelet': 3 }, functional: { 'Réglage': 1, 'Étanchéité': 2 } },
    receivedItems: { hasEcrin: false, hasCertAuth: false, docsVerified: true },
    finalControls: { identity: FINAL_CONTROL_ITEMS.identity, aesthetic: FINAL_CONTROL_ITEMS.aesthetic, technical: FINAL_CONTROL_ITEMS.technical },
    invoiceDiscount: 0,
    invoiceShipping: 0,
    powerReserve: 48,
    inspectionMeasures: {
      ch: { rate: 38, amp: 265 },
      cb: { rate: 42, amp: 260 },
      '3h': { rate: 55, amp: 248 },
      '9h': { rate: 50, amp: 250 },
      '12h': { rate: 62, amp: 242 },
      '6h': { rate: 45, amp: 252 }
    },
    finalMeasures: {
      ch: { rate: 6, amp: 280 },
      cb: { rate: 5, amp: 275 },
      '3h': { rate: 7, amp: 252 },
      '9h': { rate: 8, amp: 248 },
      '12h': { rate: 10, amp: 245 },
      '6h': { rate: 5, amp: 255 }
    },
    operations: [
      { id: 'op171', opNumber: 10, department: 'Atelier SAV', description: 'Régulation simple + contrôle marche', stdTime: '0.80', status: 'Terminé' },
      { id: 'op172', opNumber: 20, department: 'Atelier SAV', description: 'Remplacement joints + test étanchéité', stdTime: '0.50', status: 'Terminé' }
    ]
  },

  // --- CAS 18 : CARTIER SANTOS (bracelet + boucle) ---
  {
    id: 'RS-CAR-SANTOS-2020',
    client: 'Mme D. (Paris)',
    model: 'Cartier Santos (automatique)',
    serial: 'CAR-SAN-2020-550',
    statusStep: 8,
    depositDate: '2025-05-19',
    saleDate: '2020-11-10',
    productionDate: '2020-09-26',
    coverageType: 'paid',
    clientAddress: 'Boulevard Saint-Germain 102',
    clientZip: '75006',
    clientCity: 'Paris',
    customerRequestText: "Changement bracelet cuir + contrôle fermeture boucle. Nettoyage extérieur.",
    issue: "Bracelet cuir fendu, usure avancée. Boucle légèrement desserrée.",
    workshopNotes: "Remplacement bracelet + contrôle/serrage boucle. Nettoyage boîtier sans polissage.",
    quote: {
      mandatory: [
        { id: 'rep_strap', name: 'Remplacement bracelet cuir (OEM)', priceHT: 220.00, uuid: 'q18-1', type: 'part' },
        { id: 'srv_buckle_check', name: 'Contrôle + serrage boucle', priceHT: 40.00, uuid: 'q18-2', type: 'labor' }
      ],
      optional: [
        { id: 'opt_clean', name: 'Nettoyage extérieur (microfibre + dégraissage doux)', priceHT: 25.00, uuid: 'q18-opt-1', type: 'labor' }
      ]
    },
    internalQuoteMatrix: { rep_strap: { oblig: true, customPrice: 220.00 } },
    checklists: { visual: { 'Carrure': 4, 'Bracelet': 1 }, functional: { 'Réglage': 4 } },
    receivedItems: { hasEcrin: false, hasCertAuth: false, docsVerified: true },
    finalControls: { identity: FINAL_CONTROL_ITEMS.identity, aesthetic: FINAL_CONTROL_ITEMS.aesthetic, technical: FINAL_CONTROL_ITEMS.technical },
    invoiceDiscount: 0,
    invoiceShipping: 0,
    powerReserve: 42,
    inspectionMeasures: {
      ch: { rate: 4, amp: 275 },
      cb: { rate: 3, amp: 270 },
      '3h': { rate: 6, amp: 255 },
      '9h': { rate: 5, amp: 258 },
      '12h': { rate: 7, amp: 250 },
      '6h': { rate: 3, amp: 260 }
    },
    finalMeasures: {
      ch: { rate: 4, amp: 275 },
      cb: { rate: 3, amp: 270 },
      '3h': { rate: 6, amp: 255 },
      '9h': { rate: 5, amp: 258 },
      '12h': { rate: 7, amp: 250 },
      '6h': { rate: 3, amp: 260 }
    },
    operations: [
      { id: 'op181', opNumber: 10, department: 'Atelier SAV', description: 'Remplacement bracelet + contrôle boucle', stdTime: '0.40', status: 'Terminé' },
      { id: 'op182', opNumber: 20, department: 'Atelier SAV', description: 'Nettoyage extérieur (sans polissage)', stdTime: '0.20', status: 'Terminé' }
    ]
  }
];

            const [repairs, setRepairs] = useState(() => {
                try {
                const saved = localStorage.getItem('cscs_repairs_v27'); 
                return saved ? JSON.parse(saved) : initialRepairs;
                } catch (e) { return initialRepairs; }
            });

            const [currentRepair, setCurrentRepair] = useState(null);

            useEffect(() => { localStorage.setItem('cscs_repairs_v27', JSON.stringify(repairs)); }, [repairs]);

            useEffect(() => {
                if (!currentRepair && repairs.length > 0) {
                    setCurrentRepair(repairs[0]);
                }
            }, []);

            const handleUpdateRepair = (upd) => {
                setCurrentRepair(upd);
                setRepairs(repairs.map(r => r.id === upd.id ? upd : r));
            };

            const createNewRepair = () => {
                const nr = { id: `RO-2026-${Math.floor(Math.random()*1000)}`, client: '', model: '', serial: '', statusStep: 0, depositDate: new Date().toISOString().split('T')[0], invoiceDiscount: undefined, invoiceShipping: 0, quote: { mandatory: [], optional: [] }, coverageType: 'paid', photos: [], receivedItems: {}, internalQuoteMatrix: {} }; 
                setRepairs([nr, ...repairs]);
                setCurrentRepair(nr);
                setActiveTab('client_request');
            };

            const navNext = (step, tab) => {
                if (currentRepair) handleUpdateRepair({ ...currentRepair, statusStep: step });
                setActiveTab(tab);
                window.scrollTo(0,0);
            };

            const handleNextRepair = () => {
                const currentIndex = repairs.findIndex(r => r.id === currentRepair?.id);
                if (currentIndex !== -1 && currentIndex < repairs.length - 1) {
                    const nextRepair = repairs[currentIndex + 1];
                    setCurrentRepair(nextRepair);
                }
            };

            const handlePrevRepair = () => {
                const currentIndex = repairs.findIndex(r => r.id === currentRepair?.id);
                if (currentIndex !== -1 && currentIndex > 0) {
                    const prevRepair = repairs[currentIndex - 1];
                    setCurrentRepair(prevRepair);
                }
            };

            const currentIndex = repairs.findIndex(r => r.id === currentRepair?.id);
            const nextRepair = (currentIndex !== -1 && currentIndex < repairs.length - 1) ? repairs[currentIndex + 1] : null;
            const prevRepair = (currentIndex !== -1 && currentIndex > 0) ? repairs[currentIndex - 1] : null;

            const themeValues = getThemeClasses(isDark);

            const renderContent = () => {
                if (activeTab === 'dashboard') return <Dashboard repairs={repairs} selectRepair={r => { setCurrentRepair(r); setActiveTab('client_request'); }} createNewRepair={createNewRepair} />;
                if (!currentRepair) return <div className="p-20 text-center text-slate-400 font-bold uppercase tracking-widest opacity-40 select-none">Sélectionner un dossier SAV</div>;

                switch (activeTab) {
                case 'client_request': return <ClientRequestForm data={currentRepair} updateData={handleUpdateRepair} onValidateStep={() => navNext(1, 'inspection')} />;
                case 'inspection': return <InspectionForm data={currentRepair} updateData={handleUpdateRepair} onValidateStep={() => navNext(2, 'internal_quote')} />;
                case 'internal_quote': return <InternalQuoteSheet data={currentRepair} updateData={handleUpdateRepair} onValidateStep={() => navNext(3, 'quote')} />;
                case 'quote': return <QuoteBuilder data={currentRepair} updateData={handleUpdateRepair} onValidateStep={() => navNext(5, 'workshop')} />;
                case 'workshop': return <WorkshopSheet data={currentRepair} updateData={handleUpdateRepair} onValidateStep={() => navNext(6, 'delivery')} />;
                case 'delivery': return <DeliverySheet data={currentRepair} updateData={handleUpdateRepair} onValidateStep={() => navNext(7, 'report')} />;
                case 'report': return <FinalReportSheet data={currentRepair} onValidateStep={() => navNext(8, 'invoice')} />;
                case 'invoice': return <InvoiceSheet data={currentRepair} updateData={handleUpdateRepair} onValidateStep={() => { setCurrentRepair(null); setActiveTab('dashboard'); }} />;
                default: return <Dashboard repairs={repairs} />;
                }
            };

            return (
                <ThemeContext.Provider value={themeValues}>
                <div className={`flex h-screen ${themeValues.appBg} ${themeValues.textMain} overflow-hidden font-sans antialiased`}>
                    <Sidebar activeTab={activeTab} setActiveTab={setActiveTab} isOpen={isSidebarOpen} toggleSidebar={() => setSidebarOpen(!isSidebarOpen)} currentRepair={currentRepair} />
                    <main className="flex-1 flex flex-col min-w-0 overflow-hidden relative">
                    <header className={`${themeValues.headerBg} border-b ${themeValues.headerBorder} p-4 flex justify-between items-center shadow-sm z-10`}>
                        <div className="flex items-center gap-4">
                        <button onClick={() => setSidebarOpen(true)} className="md:hidden text-slate-500 hover:bg-slate-100 p-2 rounded-lg transition-colors"><Icons.Menu size={20}/></button>
                        </div>
                        
                        {currentRepair && activeTab !== 'dashboard' && (
                            <div className="flex items-center gap-4">
                                <div className="flex items-center gap-2">
                                    <button 
                                        onClick={handlePrevRepair} 
                                        disabled={!prevRepair}
                                        className={`p-2 rounded-full transition-colors ${prevRepair ? 'hover:bg-slate-100 text-slate-600' : 'text-slate-300 cursor-not-allowed'}`}
                                    >
                                        <Icons.ArrowLeftCircle size={20} />
                                    </button>
                                    
                                    <span className="text-sm font-bold font-mono bg-slate-100 px-3 py-1 rounded border border-slate-200 flex items-center gap-2">
                                        <span>{currentRepair.id}</span>
                                    </span>

                                    <button 
                                        onClick={handleNextRepair} 
                                        disabled={!nextRepair}
                                        className={`p-2 rounded-full transition-colors ${nextRepair ? 'hover:bg-slate-100 text-slate-600' : 'text-slate-300 cursor-not-allowed'}`}
                                    >
                                        <Icons.ArrowRightCircle size={20} />
                                    </button>
                                </div>

                                <div className={`hidden md:flex items-center gap-2 px-3 py-1.5 rounded-full text-[10px] font-bold uppercase tracking-wider ${currentRepair.statusStep >= 8 ? 'bg-green-100 text-green-700' : 'bg-blue-100 text-blue-700'}`}>
                                    <div className={`w-2 h-2 rounded-full ${currentRepair.statusStep >= 8 ? 'bg-green-500' : 'bg-blue-500'}`}></div>
                                    {STATUS_STEPS[currentRepair.statusStep]}
                                </div>
                            </div>
                        )}

                        <div className="flex items-center gap-3">
                        <button onClick={() => setIsDark(!isDark)} className={`p-2 rounded-lg transition-colors ${isDark ? 'bg-slate-800 text-amber-400' : 'bg-slate-100 text-slate-500'}`}>{isDark ? <Icons.Sun size={18}/> : <Icons.Moon size={18}/>}</button>
                        {currentRepair && activeTab !== 'dashboard' && <button onClick={() => { setCurrentRepair(null); setActiveTab('dashboard'); }} className="text-[10px] font-bold text-slate-400 hover:text-slate-600 uppercase border-l pl-4 border-slate-300 ml-2 tracking-widest">Fermer Dossier</button>}
                        </div>
                    </header>
                    <div className="flex-1 overflow-y-auto">{renderContent()}</div>
                    </main>
                </div>
                </ThemeContext.Provider>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>