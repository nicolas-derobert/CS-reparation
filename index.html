
<html lang="fr">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>CS Manager</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
      body { margin: 0; }
    </style>
  </head>
  <body>
    <div id="root"></div>
    <script type="text/babel" data-presets="env,react">
      const { useState, useEffect, useContext, createContext } = React;

      const startApp = async () => {
        let LucideSet = {};
        try {
          LucideSet = await import("https://esm.sh/lucide-react@0.400.0?bundle");
        } catch (e) {
          console.warn("Impossible de charger lucide-react, utilisation des icones de secours.", e);
        }

        // --- SYSTEME DE ROBUSTESSE DES ICONES (FALLBACK SYSTEM) ---

        const GenericFallbackIcon = ({ size = 24, className = "", ...props }) => (
          <svg 
            width={size} 
            height={size} 
            viewBox="0 0 24 24" 
            fill="none" 
            stroke="currentColor" 
            strokeWidth="2" 
            strokeLinecap="round" 
            strokeLinejoin="round" 
            className={`opacity-50 ${className}`} 
            {...props}
          >
            <rect x="3" y="3" width="18" height="18" rx="2" ry="2" strokeDasharray="4 2" />
            <text x="12" y="17" textAnchor="middle" fontSize="12" stroke="none" fill="currentColor" fontWeight="bold">?</text>
          </svg>
        );

        const CriticalIcons = {
          Menu: ({ size=24, ...p }) => <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...p}><line x1="4" x2="20" y1="12" y2="12"/><line x1="4" x2="20" y1="6" y2="6"/><line x1="4" x2="20" y1="18" y2="18"/></svg>,
          X: ({ size=24, ...p }) => <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...p}><path d="M18 6 6 18"/><path d="m6 6 12 12"/></svg>,
          ChevronRight: ({ size=24, ...p }) => <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...p}><path d="m9 18 6-6-6-6"/></svg>,
          ChevronLeft: ({ size=24, ...p }) => <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...p}><path d="m15 18-6-6 6-6"/></svg>,
          Check: ({ size=24, ...p }) => <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...p}><path d="M20 6 9 17l-5-5"/></svg>,
          AlertTriangle: ({ size=24, ...p }) => <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...p}><path d="m21.73 18-8-14a2 2 0 0 0-3.48 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3Z"/><path d="M12 9v4"/><path d="M12 17h.01"/></svg>,
          Watch: ({ size=24, ...p }) => <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...p}><circle cx="12" cy="12" r="6"/><polyline points="12 10 12 12 13 13"/><path d="m16.13 7.66-.81-4.05a2 2 0 0 0-2.53-1.46L10.5 2.5"/><path d="m8 16.29.6 3.65a2 2 0 0 0 2.25 1.63L13.5 21"/></svg>
        };

        const getSafeIcon = (iconName) => {
          if (LucideSet && LucideSet[iconName]) {
            return LucideSet[iconName];
          }
          if (CriticalIcons[iconName]) {
            return CriticalIcons[iconName];
          }
          return GenericFallbackIcon;
        };

        const ICON_NAMES = [
          'Clock', 'FileText', 'Settings', 'Search', 'Plus', 'CheckCircle', 'AlertTriangle', 'XCircle', 'Save', 'Printer', 
          'ChevronRight', 'DollarSign', 'Wrench', 'Archive', 'Menu', 'X', 'ClipboardList', 'FileSearch', 'ClipboardCheck', 
          'UserPlus', 'Star', 'Trash2', 'RefreshCw', 'Download', 'CheckSquare', 'Edit3', 'Lock', 'ArrowRight', 'ChevronLeft', 
          'Package', 'BarChart2', 'TrendingDown', 'AlertOctagon', 'Calendar', 'Info', 'Calculator', 'HelpCircle', 
          'MoreHorizontal', 'Sun', 'Moon', 'LogOut', 'Camera', 'Image', 'UploadCloud', 'MapPin', 'BookOpen', 
          'Timer', 'PauseCircle', 'PlayCircle', 'CreditCard', 'Factory', 'Gift', 'PenTool', 'Briefcase', 'Layout', 'GitMerge', 
          'Truck', 'Percent', 'Check', 'Hash', 'ShieldCheck', 'ShieldAlert', 'Lightbulb', 'ListChecks', 'Wifi', 'WifiOff', 
          'Database', 'Book', 'FileCheck', 'ArrowRightCircle', 'ArrowLeftCircle', 'ChevronsRight', 'Watch'
        ];

        const SafeIcons = {};
        ICON_NAMES.forEach(name => {
          const lookupName = name === 'ImageIcon' ? 'Image' : name; 
          SafeIcons[name] = getSafeIcon(lookupName);
        });

        const { 
          Clock, FileText, Settings, Search, Plus, CheckCircle, AlertTriangle, XCircle, Save, Printer, 
          ChevronRight, DollarSign, Wrench, Archive, Menu, X, ClipboardList, FileSearch, ClipboardCheck, 
          UserPlus, Star, Trash2, RefreshCw, Download, CheckSquare, Edit3, Lock, ArrowRight, ChevronLeft, 
          Package, BarChart2, TrendingDown, AlertOctagon, Calendar, Info, Calculator, HelpCircle, 
          MoreHorizontal, Sun, Moon, LogOut, Camera, Image: ImageIcon, UploadCloud, MapPin, BookOpen, 
          Timer, PauseCircle, PlayCircle, CreditCard, Factory, Gift, PenTool, Briefcase, Layout, GitMerge, 
          Truck, Percent, Check, Hash, ShieldCheck, ShieldAlert, Lightbulb, ListChecks, Wifi, WifiOff, 
          Database, Book, FileCheck, ArrowRightCircle, ArrowLeftCircle, ChevronsRight, Watch
        } = SafeIcons;

        // --- THEME CONTEXT ---
        const ThemeContext = createContext();
        const useTheme = () => useContext(ThemeContext);

        const getThemeClasses = (isDark) => ({
          isDark,
          appBg: isDark ? 'bg-slate-950' : 'bg-gray-100',
          panelBg: isDark ? 'bg-slate-800' : 'bg-white',
          panelBorder: isDark ? 'border-slate-700' : 'border-gray-200 shadow-sm',
          headerBg: isDark ? 'bg-slate-900' : 'bg-white',
          headerBorder: isDark ? 'border-slate-800' : 'border-gray-200',
          sidebarBg: isDark ? 'bg-slate-900' : 'bg-white',
          sidebarBorder: isDark ? 'border-slate-800' : 'border-gray-200',
          textMain: isDark ? 'text-white' : 'text-slate-900',
          textSec: isDark ? 'text-slate-400' : 'text-slate-500',
          inputBg: isDark ? 'bg-slate-900' : 'bg-gray-50',
          inputBorder: isDark ? 'border-slate-600' : 'border-gray-300',
          tableHeader: isDark ? 'bg-slate-900/50' : 'bg-gray-100',
          tableRowHover: isDark ? 'hover:bg-slate-700/30' : 'hover:bg-gray-50',
          accentText: isDark ? 'text-amber-500' : 'text-amber-600',
          accentBg: isDark ? 'bg-amber-500' : 'bg-amber-600',
          accentLightBg: isDark ? 'bg-amber-500/10' : 'bg-amber-50',
          bgHighlightBlue: isDark ? 'bg-blue-500/20' : 'bg-blue-100',
          textOnHighlightBlue: isDark ? 'text-blue-400' : 'text-blue-800',
          bgHighlightGreen: isDark ? 'bg-green-500/20' : 'bg-green-100',
          textOnHighlightGreen: isDark ? 'text-green-400' : 'text-green-800',
          bgHighlightAmber: isDark ? 'bg-amber-500/20' : 'bg-amber-100',
          textOnHighlightAmber: isDark ? 'text-amber-400' : 'text-amber-800',
          bgHighlightPurple: isDark ? 'bg-purple-500/20' : 'bg-purple-100',
          textOnHighlightPurple: isDark ? 'text-purple-400' : 'text-purple-800',
          alertDangerBg: isDark ? 'bg-red-900/20' : 'bg-red-50',
          alertDangerBorder: isDark ? 'border-red-900/50' : 'border-red-200',
          alertDangerText: isDark ? 'text-red-300' : 'text-red-800',
          alertWarningBg: isDark ? 'bg-amber-900/20' : 'bg-amber-50',
          alertWarningBorder: isDark ? 'border-amber-900/50' : 'border-amber-200',
          alertWarningText: isDark ? 'text-amber-300' : 'text-amber-800',
          divider: isDark ? 'divide-slate-700' : 'divide-gray-200',
          menuItemHover: isDark ? 'hover:bg-slate-800' : 'hover:bg-gray-100',
        });

        // --- CONSTANTS & DATA ---
        const VAT_RATE = 0.081; 
        const STATUS_STEPS = ["Demande enregistrée", "Pièce réceptionnée", "Diagnostic terminé", "Devis réalisé", "Accord client", "En réparation", "Contrôle & livraison", "Rapport généré", "Dossier clôturé"];
        const COVERAGE_TYPES = [
          { id: 'paid', label: 'Payant (Hors garantie)', icon: DollarSign, color: 'text-slate-600' },
          { id: 'goodwill', label: 'Geste commercial (Goodwill)', icon: ShieldAlert, color: 'text-amber-600' }
        ];
        const CHECKLIST_ITEMS = {
          visual: ['Carrure', 'Lunette', 'Fond', 'Cadran', 'Aiguilles', 'Couronne', 'Bracelet'],
          functional: ['RÃ©glage', 'Ã‰tanchÃ©itÃ©', 'Ã‰tat des joints', 'Vis de bracelet', 'Armage / mise Ã  l\\'heure', 'MagnÃ©tisme']
        };
        const FINAL_CONTROL_ITEMS = {
          identity: ["Contrôler les documents remis par le client (Certificat, facture...)", "Contrôler la référence montre et conformité des composants"],
          aesthetic: ["Contrôler l'esthétique (lunette, carrure, fond, cornes, fermoir)", "Contrôler vis de fond / orientation / olivette", "Contrôler la propreté emboîtage (poils, poussières...)", "Contrôler aiguilles / cadran / index / appliques", "Contrôler guichet / disque / décalque"],
          technical: ["Contrôler l’étanchéité", "Contrôler la marche (précision)", "Contrôler le placage de la couronne", "Contrôler le passage des fonctions et tenue de la tige", "Contrôler la friction en mise à l’heure", "Contrôler le stop seconde", "Contrôler le saut de date (minuit +/- tolérance)", "Contrôler l'alignement des aiguilles (12h, 6h...)", "Contrôler le parallélisme des aiguilles", "Contrôler le correcteur rapide de quantième", "Contrôler le centrage de la date", "Contrôler le remontage manuel (couronne)", "Contrôler le remontage automatique (masse)", "Contrôler la liberté de rotation de la masse"]
        };
        const MEASURE_POSITIONS = [
          { id: 'ch', label: 'Cadran haut (CH)' },
          { id: 'cb', label: 'Cadran bas (CB)' },
          { id: '3h', label: 'Couronne haut (3H)' },
          { id: '9h', label: 'Couronne bas (9H)' },
          { id: '12h', label: 'Couronne gauche (12H)' },
          { id: '6h', label: 'Couronne droite (6H)' }
        ];

        const PRICING_DB = [
          { id: 'srv_complet', name: 'Service complet', priceHT: 650.00, type: 'package' },
          { id: 'srv_rev_mvt', name: 'RÃ©vision du mouvement', priceHT: 350.00, type: 'labor' },
          { id: 'srv_demag', name: 'DÃ©magnÃ©tisation', priceHT: 30.00, type: 'labor' },
          { id: 'srv_restau', name: 'Restauration horlogÃ¨re (montres anciennes / vintage)', priceHT: 1200.00, type: 'labor' },
          { id: 'srv_pile', name: 'Remplacement de pile', priceHT: 25.00, type: 'labor' },
          { id: 'srv_pol_brac', name: 'Polissage du bracelet', priceHT: 120.00, type: 'labor' },
          { id: 'srv_ajust_brac', name: 'Ajustement du bracelet', priceHT: 30.00, type: 'labor' },
          { id: 'srv_rep_brac', name: 'RÃ©paration de bracelet', priceHT: 90.00, type: 'labor' },
          { id: 'srv_remp_boucle', name: 'Remplacement de boucle / fermoir', priceHT: 20.00, type: 'labor' },
          { id: 'srv_net_brac', name: 'Nettoyage de bracelet', priceHT: 40.00, type: 'labor' },
          { id: 'pm_mouvement', name: 'Mouvement complet', priceHT: 350.00, type: 'part' },
          { id: 'pm_masse', name: 'Masse', priceHT: 85.00, type: 'part' },
          { id: 'pm_balancier', name: 'Balancier', priceHT: 120.00, type: 'part' },
          { id: 'pm_pont', name: 'Pont', priceHT: 150.00, type: 'part' },
          { id: 'pm_barillet', name: 'Barillet', priceHT: 45.00, type: 'part' },
          { id: 'pm_platine', name: 'Platine', priceHT: 200.00, type: 'part' },
          { id: 'pm_autre1', name: 'Autre fourniture mouvement', priceHT: 0.00, type: 'part' },
          { id: 'ph_boite_comp', name: 'BoÃ®te complÃ¨te', priceHT: 1200.00, type: 'part' },
          { id: 'ph_fond', name: 'Fond', priceHT: 80.00, type: 'part' },
          { id: 'ph_carrure', name: 'Carrure', priceHT: 350.00, type: 'part' },
          { id: 'ph_cadran', name: 'Cadran', priceHT: 250.00, type: 'part' },
          { id: 'ph_cadran_pieds', name: 'Cadran avec pieds', priceHT: 300.00, type: 'part' },
          { id: 'ph_cadran_sans', name: 'Cadran sans pied', priceHT: 300.00, type: 'part' },
          { id: 'ph_cadran_cart', name: 'Cartouche', priceHT: 250.00, type: 'part' },
          { id: 'ph_bracelet', name: 'Changement du bracelet', priceHT: 400.00, type: 'part' },
          { id: 'ph_disque', name: 'Disque', priceHT: 80.00, type: 'part' },
          { id: 'ph_aiguille_jeu', name: 'Aiguilles (jeu)', priceHT: 111.40, type: 'part' },
          { id: 'ph_glace_sus', name: 'Glace sus', priceHT: 120.00, type: 'part' },
          { id: 'ph_glace_sous', name: 'Glace sous', priceHT: 120.00, type: 'part' },
          { id: 'ph_couronne', name: 'Couronne', priceHT: 140.00, type: 'part' },
          { id: 'ph_tube', name: 'Tube de couronne', priceHT: 40.00, type: 'part' },
          { id: 'ph_poussoir_corr', name: 'Poussoir correcteur', priceHT: 60.00, type: 'part' },
          { id: 'ph_poussoir_chrono', name: 'Poussoir chrono', priceHT: 350.00, type: 'part' },
          { id: 'ph_boucle_ard', name: 'Boucle ardillon', priceHT: 60.00, type: 'part' },
          { id: 'ph_maillon', name: 'Maillon', priceHT: 50.00, type: 'part' },
          { id: 'ph_coiffe', name: 'Coiffe', priceHT: 40.00, type: 'part' },
          { id: 'ph_vis', name: 'Vis maillons', priceHT: 10.00, type: 'part' },
          { id: 'ph_barrette', name: 'Barrette', priceHT: 5.00, type: 'part' },
          { id: 'ph_attache', name: 'Attache cuir', priceHT: 150.00, type: 'part' },
          { id: 'ph_entrecornes', name: 'Entre-cornes', priceHT: 50.00, type: 'part' },
          { id: 'ph_joints', name: 'Joints', priceHT: 15.00, type: 'part' },
          { id: 'fab_cadran', name: 'Fabrication cadran neuf (identique)', priceHT: 8500.00, type: 'part' },
          { id: 'srv_etanche_na', name: 'ContrÃ´le Ã©tanchÃ©itÃ©', priceHT: 0.00, type: 'labor' },
          { id: 'srv_restau_master', name: 'Restauration Grande Complication', priceHT: 45000.00, type: 'labor' },
          { id: 'fab_boitier', name: 'Reconstruction BoÃ®tier Or Rose', priceHT: 25000.00, type: 'part' },
          { id: 'srv_restau_hab', name: 'Restauration Habillage & OrfÃ¨vrerie', priceHT: 12000.00, type: 'labor' },
          { id: 'srv_restau_mvt', name: 'Restauration Mouvement CompliquÃ©', priceHT: 8000.00, type: 'labor' },
          { id: 'fab_pieces', name: 'Fabrication PiÃ¨ces (Came, Ressort)', priceHT: 4500.00, type: 'part' },
          { id: 'srv_restau_sonnerie', name: 'Restauration RÃ©pÃ©tition Minutes', priceHT: 9500.00, type: 'labor' },
          { id: 'srv_redressage', name: 'Redressage Gongs & Accordage', priceHT: 2500.00, type: 'labor' }
        ];

        // --- UTILS ---
        const formatCurrency = (amount) => {
            if (amount === undefined || amount === null) return '0.00 CHF';
            return new Intl.NumberFormat('fr-CH', { style: 'currency', currency: 'CHF' }).format(amount);
        };
        const roundMoney = (amount) => (Math.round((amount || 0) * 20) / 20).toFixed(2);

        // --- COMPOSANT DE GESTION PHOTO ---
        const PhotoManager = ({ title, category, photos, updatePhotos }) => {
          const { panelBg, panelBorder, textMain, textSec, inputBorder } = useTheme();
          
          const handleUpload = (e) => {
            if (e.target.files && e.target.files[0]) {
              const file = e.target.files[0];
              const newPhoto = { id: Date.now(), url: URL.createObjectURL(file), name: file.name, category };
              updatePhotos([...photos, newPhoto]);
            }
          };

          const removePhoto = (id) => updatePhotos(photos.filter(p => p.id !== id));
          const currentPhotos = (photos || []).filter(p => p.category === category);

          return (
            <div className={`${panelBg} p-4 rounded-lg border ${panelBorder} mb-4`}>
              <h5 className={`font-bold text-xs uppercase ${textSec} mb-3 flex items-center gap-2`}>
                <Camera size={14}/> {title}
              </h5>
              <div className="grid grid-cols-3 md:grid-cols-5 gap-3">
                {currentPhotos.map(photo => (
                  <div key={photo.id} className="relative group aspect-square rounded-lg overflow-hidden border border-slate-600 bg-black">
                     <img src={photo.url} alt={title} className="w-full h-full object-cover" />
                     <button onClick={() => removePhoto(photo.id)} className="absolute top-1 right-1 bg-red-600 text-white p-1 rounded-full opacity-0 group-hover:opacity-100 transition-opacity"><X size={12} /></button>
                  </div>
                ))}
                <label className={`flex flex-col items-center justify-center aspect-square border-2 border-dashed ${inputBorder} rounded-lg cursor-pointer hover:bg-slate-50 dark:hover:bg-slate-800 transition-colors`}>
                  <input type="file" className="hidden" accept="image/*" onChange={handleUpload} />
                  <Plus size={20} className={textSec} />
                  <span className={`text-[10px] mt-1 ${textSec}`}>Ajouter</span>
                </label>
              </div>
            </div>
          );
        };

        // --- SUB-COMPONENT: MEASURE TABLE ---
        const MeasureTable = ({ title, measures, updateMeasure, readOnly = false }) => {
            const { panelBg, panelBorder, textMain, inputBg, inputBorder } = useTheme();
            return (
                <div className={`${panelBg} rounded-lg border ${panelBorder} overflow-hidden mb-6`}>
                    {title && (
                        <div className="bg-slate-100 dark:bg-slate-700 p-3 border-b dark:border-slate-600">
                            <h4 className="font-bold text-xs uppercase text-slate-500 tracking-widest">{title}</h4>
                        </div>
                    )}
                    <table className="w-full text-sm">
                        <thead>
                            <tr className="border-b dark:border-slate-700">
                                <th className="p-3 text-left font-medium text-slate-500 w-1/3">Position</th>
                                <th className="p-3 text-center font-medium text-slate-500">Marche (s/j)</th>
                                <th className="p-3 text-center font-medium text-slate-500">Amplitude (Â°)</th>
                            </tr>
                        </thead>
                        <tbody className="divide-y dark:divide-slate-700">
                            {MEASURE_POSITIONS.map(pos => {
                                const m = measures?.[pos.id] || { rate: '', amp: '' };
                                return (
                                    <tr key={pos.id} className={readOnly ? '' : 'hover:bg-slate-50 dark:hover:bg-slate-700/50'}>
                                        <td className={`p-3 font-medium ${textMain}`}>{pos.label}</td>
                                        <td className="p-2">
                                            {readOnly ? (
                                                <div className="text-center font-mono">{m.rate || '-'}</div>
                                            ) : (
                                                <input 
                                                    type="number" 
                                                    className={`w-full text-center p-1 rounded ${inputBg} border ${inputBorder} outline-none focus:border-amber-500`}
                                                    value={m.rate}
                                                    onChange={(e) => updateMeasure(pos.id, 'rate', e.target.value)}
                                                />
                                            )}
                                        </td>
                                        <td className="p-2">
                                            {readOnly ? (
                                                <div className="text-center font-mono">{m.amp || '-'}</div>
                                            ) : (
                                                <input 
                                                    type="number" 
                                                    className={`w-full text-center p-1 rounded ${inputBg} border ${inputBorder} outline-none focus:border-amber-500`}
                                                    value={m.amp}
                                                    onChange={(e) => updateMeasure(pos.id, 'amp', e.target.value)}
                                                />
                                            )}
                                        </td>
                                    </tr>
                                );
                            })}
                        </tbody>
                    </table>
                </div>
            );
        };

        // --- LOGO ROBUSTE (SVG Inline) ---
        const FallbackLogo = () => (
             <div className="relative flex items-center justify-center w-10 h-10 bg-amber-500 rounded-lg text-slate-900 shadow-sm overflow-hidden">
               <Watch size={24} strokeWidth={2} className="print:w-5 print:h-5"/>
               <div className="absolute -bottom-1 -right-1 bg-white rounded-full p-0.5 print:p-0">
                 <Plus size={10} className="text-amber-600" strokeWidth={4}/>
               </div>
             </div>
        );

        const BrandLogo = ({ className = "", src = null }) => {
          const [imageError, setImageError] = useState(false);

          return (
            <div className={`flex items-center gap-3 ${className}`}>
               <div className="flex-shrink-0">
                 {src && !imageError ? (
                   <img 
                      src={src} 
                      alt="Logo Watch Repair Plus" 
                      className="w-10 h-10 object-contain rounded-lg bg-white" 
                      onError={(e) => {
                        console.warn("Erreur chargement logo distant, passage au logo vectoriel local.");
                        setImageError(true);
                        e.target.onerror = null; 
                      }} 
                   />
                 ) : (
                   <FallbackLogo />
                 )}
               </div>
               
               <div className="leading-none">
                  <h1 className="font-bold text-lg tracking-wider uppercase text-slate-900 print:text-base">Watch</h1>
                  <h1 className="font-bold text-xs tracking-widest uppercase text-amber-600 print:text-[10px]">Repair Plus</h1>
               </div>
            </div>
          );
        };

        // --- NAVIGATION ---
        const Sidebar = ({ activeTab, setActiveTab, isOpen, toggleSidebar, currentRepair }) => {
          const { sidebarBg, sidebarBorder, textMain, textSec, accentText, accentLightBg, accentLightBorder, menuItemHover } = useTheme();
          
          const menuItems = [
            { id: 'dashboard', label: 'TABLEAU DE BORD', icon: Archive },
            { id: 'client_request', label: '1. Demande client', icon: UserPlus }, 
            { id: 'inspection', label: '2. RÃ©ception & Ã©tat', icon: FileSearch }, 
            { id: 'internal_quote', label: '3. Fiche devis interne', icon: ClipboardCheck }, 
            { id: 'quote', label: '4. Devis', icon: DollarSign }, 
            { id: 'workshop', label: '5. Fiche atelier', icon: Wrench }, 
            { id: 'delivery', label: '6. Livraison', icon: Gift }, 
            { id: 'report', label: '7. Rapport de rÃ©paration', icon: BookOpen },
            { id: 'invoice', label: '8. Facturation', icon: Printer }, 
          ];

          const getRecommendedPage = (statusStep) => {
            switch (statusStep) {
                case 0: return 'client_request';
                case 1: return 'inspection';
                case 2: return 'internal_quote';
                case 3: return 'quote';
                case 4: return 'workshop'; 
                case 5: return 'workshop'; 
                case 6: return 'delivery'; 
                case 7: return 'report'; 
                case 8: return 'invoice'; 
                default: return 'dashboard';
            }
          };

          const recommendedPage = currentRepair ? getRecommendedPage(currentRepair.statusStep) : null;

          return (
            <>
              <div className={`fixed inset-0 bg-black/50 z-20 md:hidden transition-opacity ${isOpen ? 'opacity-100' : 'opacity-0 pointer-events-none'}`} onClick={toggleSidebar} />
              <div className={`fixed md:static inset-y-0 left-0 z-30 w-64 ${sidebarBg} ${textMain} border-r ${sidebarBorder} transform transition-transform md:transform-none ${isOpen ? 'translate-x-0' : '-translate-x-full'} transition-colors duration-300 flex flex-col no-print`}>
                <div className={`p-6 border-b ${sidebarBorder} flex items-center gap-3 shrink-0`}>
                   <BrandLogo />
                </div>
                
                <nav className="px-4 space-y-1 flex-1 overflow-y-auto mt-4">
                  {menuItems.map((item) => (
                    <button 
                        key={item.id} 
                        onClick={() => { setActiveTab(item.id); toggleSidebar(); }} 
                        className={`w-full flex items-center px-4 py-3 rounded-lg transition-colors text-left group gap-3 ${activeTab === item.id ? `${accentLightBg} ${accentText} border ${accentLightBorder}` : `${textSec} ${menuItemHover}`}`}
                    >
                      {item.id === recommendedPage && item.id !== 'dashboard' ? (
                          <ChevronsRight size={16} className="text-amber-500 animate-pulse shrink-0" />
                      ) : (
                          <div className="w-4 shrink-0"></div>
                      )}
                      
                      <item.icon size={18} className="shrink-0" />
                      <span className="font-medium text-sm truncate">{item.label}</span>
                    </button>
                  ))}
                </nav>
              </div>
            </>
          );
        };

        // --- PAGES ---

        const Dashboard = ({ repairs, selectRepair, createNewRepair }) => {
          const { textMain, textSec, panelBg, panelBorder, inputBg, inputBorder, tableHeader, tableRowHover, divider, bgHighlightBlue, textOnHighlightBlue, bgHighlightGreen, textOnHighlightGreen, alertDangerBg, alertDangerBorder, alertDangerText } = useTheme();
          const [searchTerm, setSearchTerm] = useState('');
          const filtered = repairs.filter(r => (r.client || '').toLowerCase().includes(searchTerm.toLowerCase()) || (r.id || '').toLowerCase().includes(searchTerm.toLowerCase()));
          const lateRepairs = repairs.filter(r => r.statusStep > 0 && r.statusStep < 7).slice(0, 2);
          const getCoverageDisplay = (type) => COVERAGE_TYPES.find(c => c.id === (type || 'paid')) || COVERAGE_TYPES[0];

          // Calculer les statistiques par statut
          const statusStats = repairs.reduce((acc, curr) => {
            const status = STATUS_STEPS[curr.statusStep];
            acc[status] = (acc[status] || 0) + 1;
            return acc;
          }, {});

          return (
            <div className="p-6 max-w-7xl mx-auto animate-in fade-in duration-500">
              <div className="flex justify-between items-center mb-8">
                <div><h2 className={`text-2xl font-bold ${textMain} mb-2 uppercase tracking-widest`}>TABLEAU DE BORD</h2><p className={textSec}>AperÃ§u global des dossiers</p></div>
                <button onClick={createNewRepair} className="bg-amber-500 hover:bg-amber-600 text-slate-900 px-4 py-2 rounded-lg font-bold flex items-center gap-2 shadow-md"><Plus size={18} /> Nouveau dossier</button>
              </div>
              <div className="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
                  <div className={`${panelBg} border ${panelBorder} rounded-xl p-5 shadow-sm`}>
                     <h3 className={`text-sm font-bold uppercase mb-4 ${textSec} flex items-center gap-2`}><AlertOctagon size={16} className="text-red-500"/> Alertes retards</h3>
                     <div className="space-y-3">
                        {lateRepairs.map((r, i) => (
                            <div key={i} className={`${alertDangerBg} border ${alertDangerBorder} p-3 rounded-lg flex justify-between items-center`}>
                                <div className="flex items-center gap-3"><span className={`text-xs font-bold ${alertDangerText} font-mono`}>{r.id}</span><span className={`text-xs ${alertDangerText} opacity-80`}>{r.model}</span></div><span className={`text-xs font-bold ${alertDangerText}`}>+5j</span>
                            </div>
                        ))}
                     </div>
                  </div>
                  <div className={`${panelBg} border ${panelBorder} rounded-xl p-5 shadow-sm`}>
                     <h3 className={`text-sm font-bold uppercase mb-4 ${textSec} flex items-center gap-2`}><TrendingDown size={16} className="text-blue-500"/> Charge atelier</h3>
                     <div className="space-y-3 mt-4">
                        {Object.entries(statusStats).slice(0, 5).map(([status, count]) => (
                          <div key={status} className="flex justify-between items-center text-sm border-b border-gray-100 dark:border-gray-800 pb-2 last:border-0">
                            <span className={textMain}>{status}</span>
                            <span className={`font-bold px-2 py-0.5 rounded-full ${bgHighlightBlue} ${textOnHighlightBlue}`}>{count}</span>
                          </div>
                        ))}
                     </div>
                  </div>
              </div>
              <div className={`${panelBg} rounded-xl border ${panelBorder} overflow-hidden shadow-sm`}>
                <div className={`p-4 border-b ${panelBorder} flex justify-between items-center`}>
                  <h3 className={`font-bold ${textMain}`}>Dossiers récents</h3>
                  <div className="relative"><Search className={`absolute left-3 top-1/2 -translate-y-1/2 ${textSec}`} size={16} /><input type="text" placeholder="Chercher client, numéro..." value={searchTerm} onChange={(e) => setSearchTerm(e.target.value)} className={`${inputBg} border ${inputBorder} ${textMain} pl-10 pr-4 py-1.5 rounded-lg text-sm outline-none w-64`} /></div>
                </div>
                <div className="overflow-x-auto">
                  <table className={`w-full text-left text-sm ${textSec}`}>
                    <thead className={`${tableHeader} uppercase text-[10px] font-bold tracking-wider`}><tr><th className="p-4">NÂ° SAV</th><th className="p-4">Client</th><th className="p-4">ModÃ¨le</th><th className="p-4">Prise en charge</th><th className="p-4">Statut</th><th className="p-4 text-right">Action</th></tr></thead>
                    <tbody className={`divide-y ${divider}`}>
                      {filtered.map((r) => {
                        const coverage = getCoverageDisplay(r.coverageType);
                        const CoverageIcon = coverage.icon;
                        return (
                          <tr key={r.id} className={`${tableRowHover} transition-colors cursor-pointer`} onClick={() => selectRepair(r)}>
                            <td className={`p-4 font-mono font-bold ${textMain}`}>{r.id}</td><td className="p-4 font-medium">{r.client || 'Client Inconnu'}</td><td className="p-4">{r.model || 'N/A'}</td>
                            <td className="p-4"><div className={`flex items-center gap-2 text-xs font-bold ${coverage.color}`}><CoverageIcon size={14} /><span className="truncate max-w-[150px]">{coverage.label}</span></div></td>
                            <td className="p-4"><span className={`px-2 py-0.5 rounded text-[10px] font-bold uppercase tracking-wider ${r.statusStep >= 7 ? `${bgHighlightGreen} ${textOnHighlightGreen}` : `${bgHighlightBlue} ${textOnHighlightBlue}`}`}>{STATUS_STEPS[r.statusStep]}</span></td>
                            <td className="p-4 text-right"><button className="p-2 rounded-full hover:bg-amber-500/10 text-amber-500"><ChevronRight size={18} /></button></td>
                          </tr>
                        );
                      })}
                    </tbody>
                  </table>
                </div>
              </div>
            </div>
          );
        };

        const ClientRequestForm = ({ data, updateData, onValidateStep }) => {
          const { panelBg, panelBorder, textMain, textSec, inputBg, inputBorder, accentText } = useTheme();
          return (
            <div className="p-6 max-w-5xl mx-auto space-y-6 pb-24 animate-in fade-in duration-500">
              <div className={`${panelBg} p-6 rounded-xl border ${panelBorder}`}>
                <h3 className={`text-lg font-bold ${accentText} mb-6 flex items-center gap-2`}><UserPlus size={20} /> Demande client & identification</h3>
                <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-6">
                  <div><label className={`block text-[10px] uppercase font-bold ${textSec} mb-1 flex items-center`}>N° Client</label><input type="text" value={data.clientId || ''} onChange={e => updateData({...data, clientId: e.target.value})} className={`w-full ${inputBg} border ${inputBorder} rounded p-2 text-sm outline-none focus:border-amber-500`} placeholder="ex: CL-8890" /></div>
                  <div className="lg:col-span-2"><label className={`block text-[10px] uppercase font-bold ${textSec} mb-1`}>Nom du client</label><input type="text" value={data.client || ''} onChange={e => updateData({...data, client: e.target.value})} className={`w-full ${inputBg} border ${inputBorder} rounded p-2 text-sm outline-none focus:border-amber-500`} /></div>
                  
                  <div className="lg:col-span-3 grid grid-cols-3 gap-4">
                     <div><label className={`block text-[10px] uppercase font-bold ${textSec} mb-1`}>Adresse</label><input type="text" value={data.clientAddress || ''} onChange={e => updateData({...data, clientAddress: e.target.value})} className={`w-full ${inputBg} border ${inputBorder} rounded p-2 text-sm outline-none focus:border-amber-500`} /></div>
                     <div><label className={`block text-[10px] uppercase font-bold ${textSec} mb-1`}>NPA</label><input type="text" value={data.clientZip || ''} onChange={e => updateData({...data, clientZip: e.target.value})} className={`w-full ${inputBg} border ${inputBorder} rounded p-2 text-sm outline-none focus:border-amber-500`} /></div>
                     <div><label className={`block text-[10px] uppercase font-bold ${textSec} mb-1`}>Ville</label><input type="text" value={data.clientCity || ''} onChange={e => updateData({...data, clientCity: e.target.value})} className={`w-full ${inputBg} border ${inputBorder} rounded p-2 text-sm outline-none focus:border-amber-500`} /></div>
                  </div>
                  
                  <div><label className={`block text-[10px] uppercase font-bold ${textSec} mb-1`}>Modèle / Référence</label><input type="text" value={data.model || ''} onChange={e => updateData({...data, model: e.target.value})} className={`w-full ${inputBg} border ${inputBorder} rounded p-2 text-sm outline-none focus:border-amber-500`} /></div>
                  <div><label className={`block text-[10px] uppercase font-bold ${textSec} mb-1`}>N° de série</label><input type="text" value={data.serial || ''} onChange={e => updateData({...data, serial: e.target.value})} className={`w-full ${inputBg} border ${inputBorder} rounded p-2 text-sm outline-none focus:border-amber-500`} /></div>
                </div>
                <div className={`p-5 rounded-lg border ${panelBorder} bg-slate-50 dark:bg-slate-900/30 mb-6 shadow-inner`}>
                  <h4 className="text-xs font-bold uppercase mb-4 flex items-center gap-2 text-slate-400 font-mono">CHRONOLOGIE DU DOSSIER</h4>
                  <div className="grid grid-cols-1 md:grid-cols-3 gap-6 text-sm">
                    <div><label className="block text-[10px] font-bold mb-1 opacity-70">DATE DE VENTE</label><input type="date" value={data.saleDate || ''} onChange={e => updateData({...data, saleDate: e.target.value})} className={`w-full p-2 rounded border ${inputBorder} ${inputBg} text-xs`} /></div>
                    <div><label className="block text-[10px] font-bold mb-1 opacity-70">DATE DERNIÈRE RÉPARATION</label><input type="date" value={data.lastRepairDate || ''} onChange={e => updateData({...data, lastRepairDate: e.target.value})} className={`w-full p-2 rounded border ${inputBorder} ${inputBg} text-xs`} /></div>
                    <div><label className={`block text-[10px] font-bold mb-1 ${accentText}`}>DATE DE RETOUR SAV</label><input type="date" value={data.depositDate || ''} onChange={e => updateData({...data, depositDate: e.target.value})} className="w-full p-2 rounded border border-amber-500 bg-amber-500/5 text-xs font-bold" /></div>
                  </div>
                </div>
                <div className="space-y-4">
                  <div><label className="block text-[10px] font-bold uppercase mb-1 opacity-70">Demande client</label><textarea rows={3} value={data.customerRequestText || ''} onChange={e => updateData({...data, customerRequestText: e.target.value})} className={`w-full ${inputBg} border ${inputBorder} rounded p-3 text-sm outline-none focus:border-amber-500`} placeholder="Demande précise du client..." /></div>
                  <div><label className="block text-[10px] font-bold uppercase mb-1 opacity-70">Problème remonté par le client</label><textarea rows={3} value={data.issue || ''} onChange={e => updateData({...data, issue: e.target.value})} className={`w-full ${inputBg} border ${inputBorder} rounded p-3 text-sm outline-none focus:border-amber-500`} placeholder="Adapte le contenu en te limitant à une reformulation des mot du client qui explique le problème tel qu'il le vit." /></div>
                </div>
              </div>
              <div className={`fixed bottom-0 left-0 right-0 ${panelBg} border-t ${panelBorder} p-4 flex justify-end gap-4 z-30 md:pl-64 shadow-2xl`}><button onClick={onValidateStep} className="bg-green-600 hover:bg-green-700 text-white px-6 py-3 rounded-lg font-bold flex items-center gap-2 shadow-lg hover:scale-105 transition-transform"><CheckCircle size={18}/> Valider & Suivant</button></div>
            </div>
          );
        };

        const InspectionForm = ({ data, updateData, onValidateStep }) => {
          const { panelBg, panelBorder, textMain, accentText, inputBg, inputBorder, textSec, bgHighlightAmber } = useTheme();
          const setRating = (k, v) => updateData({ ...data, checklists: { ...data.checklists, visual: { ...(data.checklists?.visual || {}), [k]: v } } });
          
          const handleItemToggle = (key) => {
            updateData({ ...data, receivedItems: { ...(data.receivedItems || {}), [key]: !data.receivedItems?.[key] } });
          };
          
          const updateInspectionMeasure = (posId, field, value) => {
              const current = data.inspectionMeasures || {};
              const posData = current[posId] || {};
              updateData({
                  ...data,
                  inspectionMeasures: {
                      ...current,
                      [posId]: { ...posData, [field]: value }
                  }
              });
          };

          return (
            <div className="p-6 max-w-5xl mx-auto space-y-6 pb-24 animate-in fade-in duration-500">
              
              <div className={`${panelBg} p-6 rounded-xl border ${panelBorder} shadow-sm`}>
                <h3 className={`text-lg font-bold ${accentText} mb-4 flex items-center gap-2`}><Package size={20}/> Éléments remis par le client</h3>
                
                <div className="grid grid-cols-2 md:grid-cols-3 gap-6 mb-6">
                    <label className="flex items-center gap-2 cursor-pointer font-medium hover:text-amber-500 transition-colors">
                        <input type="checkbox" checked={!!data.receivedItems?.hasBox} onChange={() => handleItemToggle('hasBox')} className="w-5 h-5 accent-amber-500" /> 
                        Boîte
                    </label>
                    <label className="flex items-center gap-2 cursor-pointer font-medium hover:text-amber-500 transition-colors">
                        <input type="checkbox" checked={!!data.receivedItems?.hasEcrin} onChange={() => handleItemToggle('hasEcrin')} className="w-5 h-5 accent-amber-500" /> 
                        Ecrin
                    </label>
                    <label className="flex items-center gap-2 cursor-pointer font-medium hover:text-amber-500 transition-colors">
                        <input type="checkbox" checked={!!data.receivedItems?.hasCertAuth} onChange={() => handleItemToggle('hasCertAuth')} className="w-5 h-5 accent-amber-500" /> 
                        Certificat d'authenticité
                    </label>
                    <label className="flex items-center gap-2 cursor-pointer font-medium hover:text-amber-500 transition-colors">
                        <input type="checkbox" checked={!!data.receivedItems?.hasInvoice} onChange={() => handleItemToggle('hasInvoice')} className="w-5 h-5 accent-amber-500" /> 
                        Facture d'achat
                    </label>
                    <label className="flex items-center gap-2 cursor-pointer font-medium hover:text-amber-500 transition-colors">
                        <input type="checkbox" checked={!!data.receivedItems?.hasWarrantyCard} onChange={() => handleItemToggle('hasWarrantyCard')} className="w-5 h-5 accent-amber-500" /> 
                        Carte de garantie
                    </label>
                </div>

                <div className={`p-4 rounded-lg border ${bgHighlightAmber} border-amber-200`}>
                    <div className="flex items-start gap-3">
                       <div className="p-2 bg-amber-100 rounded-full text-amber-600"><FileCheck size={20}/></div>
                       <div>
                          <h4 className="text-sm font-bold text-amber-800 uppercase mb-1">Procédure de vérification documentaire</h4>
                          <p className="text-xs text-amber-700 leading-relaxed mb-3">
                             Le personnel du SAV doit examiner soigneusement les documents fournis (certificats, factures, cartes) pour vérifier l'authenticité de la montre et déterminer avec précision le statut de la garantie (validité, couverture géographique).
                          </p>
                          <label className="flex items-center gap-2 cursor-pointer text-xs font-bold text-amber-900">
                              <input type="checkbox" checked={!!data.receivedItems?.docsVerified} onChange={() => handleItemToggle('docsVerified')} className="w-4 h-4 accent-amber-600" />
                              J'atteste avoir vérifié l'authenticité et la validité des documents.
                          </label>
                       </div>
                    </div>
                </div>
              </div>
              
              <PhotoManager title="Photos de réception / diagnostic" category="receipt" photos={data.photos || []} updatePhotos={p => updateData({...data, photos: p})} />

              <div className={`${panelBg} p-6 rounded-xl border ${panelBorder} mb-6`}>
                 <h4 className="font-bold border-b pb-2 mb-4 text-xs uppercase tracking-widest text-slate-400">Observations initiales (Avant ouverture)</h4>
                 <textarea 
                    rows={4} 
                    value={data.initialObservations || ''} 
                    onChange={e => updateData({...data, initialObservations: e.target.value})} 
                    className={`w-full ${inputBg} border ${inputBorder} rounded p-3 text-sm outline-none focus:border-amber-500 mb-4`} 
                    placeholder="Noter ici l'état général, les rayures visibles, l'oxydation, etc..." 
                 />
              </div>

              <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div className={`${panelBg} p-6 rounded-xl border ${panelBorder}`}><h4 className="font-bold border-b pb-2 mb-4 text-xs uppercase tracking-widest text-slate-400">État esthétique (0-5)</h4><div className="space-y-4">{CHECKLIST_ITEMS.visual.map(item => (<div key={item} className="flex items-center justify-between"><span className="text-sm">{item}</span><div className="flex gap-1">{[0,1,2,3,4,5].map(v => (<button key={v} onClick={() => setRating(item,v)} className={`w-8 h-8 rounded text-xs font-bold transition-colors ${data.checklists?.visual?.[item] === v ? 'bg-amber-500 text-white' : 'bg-slate-100 hover:bg-slate-200'}`}>{v}</button>))}</div></div>))}</div></div>
                
                <div>
                    <MeasureTable 
                        title="Mesures initiales (Chronométrie)" 
                        measures={data.inspectionMeasures} 
                        updateMeasure={updateInspectionMeasure} 
                    />
                </div>
              </div>
              <div className={`fixed bottom-0 left-0 right-0 ${panelBg} border-t ${panelBorder} p-4 flex justify-end z-30 md:pl-64 shadow-xl`}><button onClick={onValidateStep} className="bg-green-600 text-white px-6 py-3 rounded-lg font-bold flex items-center gap-2"><CheckCircle size={18}/> Valider état & suivant</button></div>
            </div>
          );
        };

        const WorkshopSheet = ({ data, updateData, onValidateStep }) => {
          const { panelBg, panelBorder, accentText, inputBg, inputBorder, textMain } = useTheme();
          
          const toggleFinalControl = (category, item) => {
            const currentCategory = data.finalControls?.[category] || [];
            const newCategory = currentCategory.includes(item) ? currentCategory.filter(i => i !== item) : [...currentCategory, item];
            updateData({ ...data, finalControls: { ...data.finalControls, [category]: newCategory } });
          };

          const totalItems = FINAL_CONTROL_ITEMS.identity.length + FINAL_CONTROL_ITEMS.aesthetic.length + FINAL_CONTROL_ITEMS.technical.length;
          const checkedItems = (data.finalControls?.identity?.length || 0) + (data.finalControls?.aesthetic?.length || 0) + (data.finalControls?.technical?.length || 0);
          const progress = Math.round((checkedItems / totalItems) * 100);
          
          const updateFinalMeasure = (posId, field, value) => {
              const current = data.finalMeasures || {};
              const posData = current[posId] || {};
              updateData({
                  ...data,
                  finalMeasures: {
                      ...current,
                      [posId]: { ...posData, [field]: value }
                  }
              });
          };

          const [selectedGamme, setSelectedGamme] = useState('');
          const [selectedPartToAdd, setSelectedPartToAdd] = useState('');
          const [newOpData, setNewOpData] = useState({ description: '', department: 'Atelier Technique', stdTime: '0.50' });
          const [editingPartId, setEditingPartId] = useState(null);
          
          const GAMMES_OPERATOIRES = {
              'service_complet_meca': { label: 'Service Complet (Méc/Auto)', ops: [ { desc: 'Démontage complet', time: '0.75' }, { desc: 'Lavage', time: '0.50' }, { desc: 'Remontage & Huilage', time: '1.00' }, { desc: 'Réglage', time: '0.25' } ] },
              'service_quartz': { label: 'Service Quartz', ops: [ { desc: 'Contrôle circuit', time: '0.30' }, { desc: 'Remplacement pile', time: '0.15' } ] },
              'polissage': { label: 'Polissage', ops: [ { desc: 'Préparation', time: '0.50' }, { desc: 'Polissage', time: '1.00' }, { desc: 'Lavage', time: '0.20' } ] }
          };

          const operations = data.operations || (data.quote?.mandatory || []).map((item, index) => ({
              id: item.uuid, opNumber: (index + 1) * 10, department: 'Atelier Horlogerie', description: item.name, stdTime: '1.00', status: 'À réaliser'
          }));

          const partsToReplace = (data.quote?.mandatory || []).filter(item => item.type === 'part');
          const availablePartsToAdd = PRICING_DB.filter(p => p.type === 'part' && !partsToReplace.some(existing => existing.id === p.id));

          const launchGamme = (key) => {
              const gamme = GAMMES_OPERATOIRES[key];
              if (!gamme) return;
              const currentMax = operations.length > 0 ? Math.max(...operations.map(o => o.opNumber)) : 0;
              const newOps = gamme.ops.map((op, idx) => ({
                  id: Date.now() + idx, opNumber: currentMax + ((idx + 1) * 10), department: 'Atelier', description: op.desc, stdTime: op.time, status: 'À réaliser', isGamme: true
              }));
              updateData({ ...data, operations: [...operations, ...newOps] });
              setSelectedGamme('');
          };

          const addManualOperation = () => {
            if (!newOpData.description) return;
            const maxOpNum = operations.length > 0 ? Math.max(...operations.map(o => o.opNumber)) : 0;
            const manualOp = {
              id: `manual-${Date.now()}`,
              opNumber: maxOpNum + 10,
              department: newOpData.department,
              description: newOpData.description,
              stdTime: newOpData.stdTime,
              status: 'À réaliser',
              isGamme: false, isManual: true
            };
            updateData({ ...data, operations: [...operations, manualOp] });
            setNewOpData({ description: '', department: 'Atelier Technique', stdTime: '0.50' });
          };

          const updateOperation = (id, field, value) => {
            const updatedOps = operations.map(op => 
              op.id === id ? { ...op, [field]: value } : op
            );
            updateData({ ...data, operations: updatedOps });
          };

          const deleteOperation = (id) => {
            const updatedOps = operations.filter(op => op.id !== id);
            updateData({ ...data, operations: updatedOps });
          };
          
          const toggleOpStatus = (opId) => {
            const newOps = operations.map(op => {
                if (op.id === opId) return { ...op, status: op.status === 'Terminé' ? 'À réaliser' : 'Terminé' };
                return op;
            });
            updateData({ ...data, operations: newOps });
          };

          const addPartToReplace = () => {
            const partToAdd = PRICING_DB.find(p => p.id === selectedPartToAdd);
            if (partToAdd) {
                const newPartItem = { ...partToAdd, uuid: `workshop-added-${Date.now()}`, priceHT: partToAdd.priceHT, isMatrix: false, type: 'part' };
                const newMandatory = [...(data.quote?.mandatory || []), newPartItem];
                updateData({ ...data, quote: { ...data.quote, mandatory: newMandatory } });
                setSelectedPartToAdd('');
            }
          };

          const updatePartPrice = (uuid, newPrice) => {
            const newMandatory = (data.quote?.mandatory || []).map(item => {
                if (item.uuid === uuid) return { ...item, priceHT: parseFloat(newPrice) || 0 };
                return item;
            });
            updateData({ ...data, quote: { ...data.quote, mandatory: newMandatory } });
          };
          
          const updatePartName = (uuid, newName) => {
              const newMandatory = (data.quote?.mandatory || []).map(item => {
                  if (item.uuid === uuid) return { ...item, name: newName };
                  return item;
              });
              updateData({ ...data, quote: { ...data.quote, mandatory: newMandatory } });
          };

          const removePartToReplace = (uuid) => {
            const newMandatory = (data.quote?.mandatory || []).filter(item => item.uuid !== uuid);
            updateData({ ...data, quote: { ...data.quote, mandatory: newMandatory } });
          };

          const togglePartStatus = (partUuid) => {
            const isCompleted = data.completedTasks?.includes(partUuid);
            let newCompleted = data.completedTasks || [];
            if (isCompleted) newCompleted = newCompleted.filter(id => id !== partUuid);
            else newCompleted = [...newCompleted, partUuid];
            updateData({ ...data, completedTasks: newCompleted });
          };

          return (
            <div className="p-6 max-w-5xl mx-auto space-y-6 pb-24 animate-in slide-in-from-bottom duration-500">
              <div className={`${panelBg} p-8 rounded-xl border ${panelBorder} shadow-lg`} id="workshop-print">
                <div className="flex justify-between items-center mb-8 border-b pb-4">
                   <h2 className="text-2xl font-bold flex items-center gap-3 uppercase tracking-tighter"><Factory size={24} className="text-amber-500"/> Fiche atelier & contrÃ´les</h2>
                   <div className="flex items-center gap-4">
                      <div className="text-right text-xs font-mono font-bold text-slate-400 uppercase tracking-widest mr-4">ORDRE: {data.id}</div>
                   </div>
                </div>

                <div className={`mb-8 p-5 rounded-lg border ${panelBorder} bg-slate-50 dark:bg-slate-900/30`}>
                   <div className="flex justify-between items-center border-b border-gray-200 dark:border-gray-700 pb-3 mb-4">
                       <h4 className={`text-sm font-bold ${accentText} uppercase flex items-center gap-2`}><Package size={16} /> Composants Ã  remplacer</h4>
                       <div className="flex items-center gap-2 no-print">
                           <select value={selectedPartToAdd} onChange={(e) => setSelectedPartToAdd(e.target.value)} className={`text-xs p-2 rounded border ${inputBorder} ${inputBg} ${textMain} outline-none w-48`}><option value="">+ Ajouter un composant...</option>{availablePartsToAdd.map(part => (<option key={part.id} value={part.id}>{part.name} ({part.priceHT} CHF)</option>))}</select>
                           <button onClick={addPartToReplace} disabled={!selectedPartToAdd} className={`p-2 rounded transition-colors ${selectedPartToAdd ? 'bg-blue-600 text-white hover:bg-blue-500' : 'bg-slate-700 text-slate-500 cursor-not-allowed'}`}><Plus size={14} /></button>
                       </div>
                   </div>
                   <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                      {partsToReplace.map(part => {
                         const isReplaced = data.completedTasks?.includes(part.uuid);
                         
                         return (
                            <div key={part.uuid} className={`flex items-center gap-3 p-3 rounded border transition-all ${isReplaced ? 'bg-green-500/10 border-green-500/30' : `${panelBg} ${inputBorder} hover:border-amber-500`}`}>
                               <div onClick={() => togglePartStatus(part.uuid)} className={`cursor-pointer w-5 h-5 rounded border flex items-center justify-center shrink-0 transition-colors ${isReplaced ? 'bg-green-500 border-green-500 text-white' : 'border-gray-400'}`}>{isReplaced && <CheckSquare size={12} />}</div>
                               
                               <div className="flex-1 min-w-0">
                                   <input 
                                       type="text" 
                                       value={part.name} 
                                       onChange={(e) => updatePartName(part.uuid, e.target.value)}
                                       className={`w-full text-xs p-1 border rounded ${inputBorder} bg-white dark:bg-black`}
                                   />
                                   
                                   <div className="flex items-center mt-1">
                                        <input 
                                            type="number" 
                                            value={part.priceHT} 
                                            onChange={(e) => updatePartPrice(part.uuid, e.target.value)}
                                            className={`w-20 text-xs p-1 border rounded ${inputBorder} bg-white dark:bg-black`}
                                        />
                                        <span className="text-[10px] ml-1">CHF</span>
                                   </div>
                               </div>
                               
                               <button onClick={() => removePartToReplace(part.uuid)} className="text-slate-400 hover:text-red-500 transition-colors p-1"><Trash2 size={14}/></button>
                            </div>
                         );
                      })}
                   </div>
                </div>

                <div className={`mb-8 p-4 rounded-lg border border-dashed ${panelBorder} bg-slate-50 dark:bg-slate-900/50 no-print`}>
                   <h4 className={`text-sm font-bold ${accentText} uppercase mb-3 flex items-center gap-2`}><Settings size={14} /> Gammes opÃ©ratoires (GÃ©nÃ©rer l'OF)</h4>
                   <p className=\"text-xs text-slate-400 mb-2\">SÃ©lectionnez une gamme standard pour prÃ©-remplir l'ordre de fabrication.</p>
                   <div className=\"flex gap-4\">
                   <h4 className={`text-sm font-bold ${accentText} uppercase mb-3 flex items-center gap-2`}><Settings size={14} /> Gammes opératoires (Générer l'OF)</h4>
                   <p className="text-xs text-slate-400 mb-2">Sélectionnez une gamme standard pour pré-remplir l'ordre de fabrication.</p>
                   <div className="flex gap-4">
                      <select value={selectedGamme} onChange={(e) => setSelectedGamme(e.target.value)} className={`flex-1 ${inputBg} border ${inputBorder} rounded p-2 text-sm outline-none`}><option value="">-- Choisir une gamme --</option>{Object.entries(GAMMES_OPERATOIRES).map(([k, v]) => (<option key={k} value={k}>{v.label}</option>))}</select>
                      <button onClick={() => launchGamme(selectedGamme)} disabled={!selectedGamme} className="bg-amber-500 text-white px-4 py-2 rounded font-bold text-sm">GÃ©nÃ©rer OF</button>
                   </div>
                </div>

                <div className="mb-8 overflow-hidden rounded-lg border border-gray-200">
                   <table className="w-full text-sm text-left">
                      <thead className="bg-gray-100 text-xs uppercase font-bold text-gray-500"><tr><th className="p-3 text-center">Op NÂ°</th><th className="p-3">Description (Editable)</th><th className="p-3 w-32">DÃ©partement</th><th className="p-3 w-20 text-right">Temps</th><th className="p-3 text-center w-24 no-print">Action</th></tr></thead>
                      <tbody className="divide-y divide-gray-100">
                         {operations.map(op => {
                           const isDone = op.status === 'TerminÃ©';
                           const isDone = op.status === 'Terminé';
                           return (
                            <tr key={op.id} className={isDone ? 'bg-green-50' : ''}>
                               <td className=\"p-3 text-center font-mono text-xs\">{op.opNumber}</td>
                               <td className=\"p-3\">
                               <td className="p-3 text-center font-mono text-xs">{op.opNumber}</td>
                               <td className="p-3">
                                 <input 
                                   type=\"text\" 
                                   type="text" 
                                   value={op.description} 
                                   onChange={(e) => updateOperation(op.id, 'description', e.target.value)}
                                   className={`bg-transparent w-full outline-none border-b border-transparent hover:border-gray-300 focus:border-amber-500 ${isDone ? 'text-slate-500 font-medium' : 'font-medium'}`} 
                                 />
                               </td>
                               <td className="p-3">
                                 <select 
                                   value={op.department} 
                                   onChange={(e) => updateOperation(op.id, 'department', e.target.value)}
                                   className=\"bg-transparent text-xs w-full outline-none\"
                                   className="bg-transparent text-xs w-full outline-none"
                                 >
                                    <option value=\"Atelier Technique\">Atelier Technique</option>
                                    <option value=\"Atelier Habillage\">Atelier Habillage</option>
                                    <option value=\"Atelier Polissage\">Atelier Polissage</option>
                                    <option value=\"Atelier Lavage\">Atelier Lavage</option>
                                    <option value=\"ContrÃ´le QualitÃ©\">ContrÃ´le QualitÃ©</option>
                                    <option value=\"Sous-traitant\">Sous-traitant</option>
                                    <option value="Atelier Technique">Atelier Technique</option>
                                    <option value="Atelier Habillage">Atelier Habillage</option>
                                    <option value="Atelier Polissage">Atelier Polissage</option>
                                    <option value="Atelier Lavage">Atelier Lavage</option>
                                    <option value="Contrôle Qualité">Contrôle Qualité</option>
                                    <option value="Sous-traitant">Sous-traitant</option>
                                 </select>
                               </td>
                               <td className=\"p-3 text-right\">
                               <td className="p-3 text-right">
                                 <input 
                                   type=\"number\" 
                                   step=\"0.1\" 
                                   type="number" 
                                   step="0.1" 
                                   value={op.stdTime} 
                                   onChange={(e) => updateOperation(op.id, 'stdTime', e.target.value)}
                                   className=\"w-12 text-right bg-transparent border-b border-transparent hover:border-gray-300 focus:border-amber-500 outline-none\"
                                   className="w-12 text-right bg-transparent border-b border-transparent hover:border-gray-300 focus:border-amber-500 outline-none"
                                 />
                               </td>
                               <td className=\"p-3 flex items-center justify-center gap-2 no-print\">
                               <td className="p-3 flex items-center justify-center gap-2 no-print">
                                  <button onClick={() => toggleOpStatus(op.id)} className={`w-6 h-6 rounded flex items-center justify-center border ${isDone ? 'bg-green-500 border-green-500 text-white' : 'border-gray-300 text-gray-300 hover:border-green-500 hover:text-green-500'}`}><Check size={14}/></button>
                                  <button onClick={() => deleteOperation(op.id)} className="text-red-400 hover:text-red-600"><Trash2 size={16}/></button>
                               </td>
                            </tr>
                         )})}
                         
                         <tr className="bg-slate-50 border-t-2 border-slate-100 no-print">
                            <td className="p-3 text-center font-bold text-slate-400">+</td>
                            <td className="p-3"><input type="text" placeholder="Ajouter une opÃ©ration manuelle..." value={newOpData.description} onChange={(e) => setNewOpData({...newOpData, description: e.target.value})} className="w-full bg-transparent border-b border-slate-300 focus:border-amber-500 outline-none" /></td>
                            <td className="p-3"><input type="text" placeholder="Ajouter une opération manuelle..." value={newOpData.description} onChange={(e) => setNewOpData({...newOpData, description: e.target.value})} className="w-full bg-transparent border-b border-slate-300 focus:border-amber-500 outline-none" /></td>
                            <td className="p-3">
                               <select value={newOpData.department} onChange={(e) => setNewOpData({...newOpData, department: e.target.value})} className="bg-transparent text-xs outline-none">
                                  <option value="Atelier Technique">Atelier Technique</option>
                                  <option value="Atelier Habillage">Atelier Habillage</option>
                                  <option value="Atelier Polissage">Atelier Polissage</option>
                                  <option value="Sous-traitant">Sous-traitant</option>
                               </select>
                            </td>
                            <td className="p-3 text-right"><input type="number" step="0.1" value={newOpData.stdTime} onChange={(e) => setNewOpData({...newOpData, stdTime: e.target.value})} className="w-12 text-right bg-transparent border-b border-slate-300 outline-none" /></td>
                            <td className="p-3 text-center"><button onClick={addManualOperation} disabled={!newOpData.description} className="bg-blue-600 text-white rounded-full p-1 hover:bg-blue-700 disabled:opacity-50"><Plus size={16}/></button></td>
                         </tr>
                      </tbody>
                   </table>
                </div>

                <PhotoManager title="Photos composants dÃ©fectueux / remplacÃ©s" category="parts" photos={data.photos || []} updatePhotos={p => updateData({...data, photos: p})} />
                <PhotoManager title="Photos composants défectueux / remplacés" category="parts" photos={data.photos || []} updatePhotos={p => updateData({...data, photos: p})} />

                <div className="mb-8">
                  <div className="flex justify-between items-end mb-4 border-b pb-2">
                    <h4 className={`text-sm font-bold ${accentText} uppercase flex items-center gap-2`}><ListChecks size={18}/> ContrÃ´les & tests finaux</h4>
                    <h4 className={`text-sm font-bold ${accentText} uppercase flex items-center gap-2`}><ListChecks size={18}/> Contrôles & tests finaux</h4>
                    <div className="text-xs font-bold text-slate-400">Avancement : {progress}%</div>
                  </div>
                  
                  <div className="w-full bg-slate-100 rounded-full h-2 mb-6 overflow-hidden">
                     <div className="bg-green-500 h-2 rounded-full transition-all duration-500" style={{width: `${progress}%`}}></div>
                  </div>

                  <div className="grid grid-cols-1 gap-6">
                    
                    <div className={`${panelBg} border ${panelBorder} rounded-lg p-4`}>
                        <h5 className="font-bold text-xs uppercase text-slate-500 mb-3 border-b border-slate-100 pb-2">1. IdentitÃ© & conformitÃ©</h5>
                        <h5 className="font-bold text-xs uppercase text-slate-500 mb-3 border-b border-slate-100 pb-2">1. Identité & conformité</h5>
                        <div className="space-y-2">
                          {FINAL_CONTROL_ITEMS.identity.map(item => {
                            const checked = (data.finalControls?.identity || []).includes(item);
                            return (
                              <div key={item} onClick={() => toggleFinalControl('identity', item)} className={`flex items-center gap-3 p-2 rounded cursor-pointer hover:bg-slate-50 dark:hover:bg-slate-700 transition-colors`}>
                                <div className={`w-5 h-5 rounded border flex items-center justify-center shrink-0 ${checked ? 'bg-blue-600 border-blue-600 text-white' : 'border-gray-300'}`}>{checked && <Check size={12}/>}</div>
                                <span className={`text-sm ${checked ? 'text-slate-900 dark:text-white font-medium' : 'text-slate-500'}`}>{item}</span>
                              </div>
                            );
                          })}
                        </div>
                    </div>

                    <div className={`${panelBg} border ${panelBorder} rounded-lg p-4`}>
                        <h5 className="font-bold text-xs uppercase text-slate-500 mb-3 border-b border-slate-100 pb-2">2. EsthÃ©tique</h5>
                        <h5 className="font-bold text-xs uppercase text-slate-500 mb-3 border-b border-slate-100 pb-2">2. Esthétique</h5>
                        <div className="space-y-2">
                          {FINAL_CONTROL_ITEMS.aesthetic.map(item => {
                            const checked = (data.finalControls?.aesthetic || []).includes(item);
                            return (
                              <div key={item} onClick={() => toggleFinalControl('aesthetic', item)} className={`flex items-center gap-3 p-2 rounded cursor-pointer hover:bg-slate-50 dark:hover:bg-slate-700 transition-colors`}>
                                <div className={`w-5 h-5 rounded border flex items-center justify-center shrink-0 ${checked ? 'bg-amber-500 border-amber-500 text-white' : 'border-gray-300'}`}>{checked && <Check size={12}/>}</div>
                                <span className={`text-sm ${checked ? 'text-slate-900 dark:text-white font-medium' : 'text-slate-500'}`}>{item}</span>
                              </div>
                            );
                          })}
                        </div>
                    </div>

                    <div className={`${panelBg} border ${panelBorder} rounded-lg p-4`}>
                        <h5 className="font-bold text-xs uppercase text-slate-500 mb-3 border-b border-slate-100 pb-2">3. Technique & fonctionnel</h5>
                        <div className="grid grid-cols-1 md:grid-cols-2 gap-x-4 gap-y-2">
                          {FINAL_CONTROL_ITEMS.technical.map(item => {
                            const checked = (data.finalControls?.technical || []).includes(item);
                            return (
                              <div key={item} onClick={() => toggleFinalControl('technical', item)} className={`flex items-center gap-3 p-2 rounded cursor-pointer hover:bg-slate-50 dark:hover:bg-slate-700 transition-colors`}>
                                <div className={`w-5 h-5 rounded border flex items-center justify-center shrink-0 ${checked ? 'bg-green-600 border-green-600 text-white' : 'border-gray-300'}`}>{checked && <Check size={12}/>}</div>
                                <span className={`text-sm ${checked ? 'text-slate-900 dark:text-white font-medium' : 'text-slate-500'}`}>{item}</span>
                              </div>
                            );
                          })}
                        </div>
                    </div>
                  </div>
                </div>

                <div className="mb-6">
                    <div className="flex justify-between items-center mb-2">
                        <h4 className="font-bold text-xs uppercase text-slate-500 tracking-widest">Mesures finales (ChronomÃ©trie)</h4>
                        <h4 className="font-bold text-xs uppercase text-slate-500 tracking-widest">Mesures finales (Chronométrie)</h4>
                        <div className="flex items-center gap-2">
                            <label className={`text-xs font-bold ${textMain}`}>RÃ©serve de marche (h) :</label>
                            <label className={`text-xs font-bold ${textMain}`}>Réserve de marche (h) :</label>
                            <input 
                                type="number" 
                                value={data.powerReserve || ''}
                                onChange={(e) => updateData({ ...data, powerReserve: e.target.value })}
                                className={`w-20 p-1 text-center rounded border ${inputBorder} ${inputBg} outline-none focus:border-amber-500 font-mono text-sm`}
                                placeholder="ex: 48"
                            />
                        </div>
                    </div>
                    <MeasureTable 
                        title="" 
                        measures={data.finalMeasures} 
                        updateMeasure={updateFinalMeasure} 
                    />
                </div>

                <div><label className="text-[10px] font-bold uppercase text-slate-400 mb-2 block tracking-widest">Observations techniques de l'horloger</label><textarea rows={4} value={data.workshopNotes || ''} onChange={e => updateData({...data, workshopNotes: e.target.value})} className={`w-full p-4 rounded-lg border ${inputBorder} ${inputBg} text-sm focus:border-amber-500 outline-none shadow-inner`} placeholder="Saisir les notes..." /></div>
              </div>
              <div className={`fixed bottom-0 left-0 right-0 ${panelBg} border-t ${panelBorder} p-4 flex justify-between items-center z-30 md:pl-64 shadow-xl`}>
                 {/* SUPPRESSION BOUTON IMPRIMER */}
                 <button onClick={onValidateStep} className="bg-green-600 text-white px-6 py-3 rounded-lg font-bold flex items-center gap-2 shadow-lg"><CheckCircle size={18}/> Finir RÃ©paration & Suivant</button>
                 <button onClick={onValidateStep} className="bg-green-600 text-white px-6 py-3 rounded-lg font-bold flex items-center gap-2 shadow-lg"><CheckCircle size={18}/> Finir Réparation & Suivant</button>
              </div>
            </div>
          );
        };

        const DeliverySheet = ({ data, updateData, onValidateStep }) => {
          const { panelBg, panelBorder, accentText } = useTheme();
          
          const entryItems = [
            { key: 'hasEcrin', label: 'Ecrin' },
            { key: 'hasCertAuth', label: 'Certificat d\\'authenticitÃ©' },
            { key: 'hasInvoice', label: 'Facture d\\'achat' },
            { key: 'hasCertAuth', label: 'Certificat d\'authenticité' },
            { key: 'hasInvoice', label: 'Facture d\'achat' },
            { key: 'hasWarrantyCard', label: 'Carte de garantie' }
          ];

          const toggleReturnCheck = (key) => {
            updateData({ 
                ...data, 
                deliveryReturnChecks: { 
                    ...(data.deliveryReturnChecks || {}), 
                    [key]: !data.deliveryReturnChecks?.[key] 
                } 
            });
          };

          return (
            <div className="p-6 max-w-5xl mx-auto space-y-6 pb-24">
              <div className={`${panelBg} p-10 rounded-xl border ${panelBorder} shadow-lg`}>
                <h2 className={`text-2xl font-bold ${accentText} mb-8 flex items-center gap-3 uppercase tracking-tighter`}><Gift size={24}/> Livraison client</h2>
                
                {/* PHOTO MANAGER POUR LA MONTRE FINIE */}
                <PhotoManager title="Photos montre terminÃ©e (EsthÃ©tique finale)" category="final" photos={data.photos || []} updatePhotos={p => updateData({...data, photos: p})} />
                <PhotoManager title="Photos montre terminée (Esthétique finale)" category="final" photos={data.photos || []} updatePhotos={p => updateData({...data, photos: p})} />

                <div className="grid grid-cols-1 md:grid-cols-2 gap-10 mt-8">
                   <div className="space-y-4">
                      <h4 className="font-bold text-xs uppercase text-slate-400 border-b pb-2 tracking-widest">ContrÃ´le sortie</h4>
                      <div className="space-y-3">{['Nettoyage final effectuÃ©', 'Mise Ã  l\\'heure & calendrier', 'Documents de garantie signÃ©s'].map(i => (<div key={i} className=\"flex items-center gap-3 text-sm font-medium\"><CheckCircle size={18} className=\"text-green-500 shadow-sm\"/>{i}</div>))}</div>
                      <h4 className="font-bold text-xs uppercase text-slate-400 border-b pb-2 tracking-widest">Contrôle sortie</h4>
                      <div className="space-y-3">{['Nettoyage final effectué', 'Mise à l\'heure & calendrier', 'Documents de garantie signés'].map(i => (<div key={i} className="flex items-center gap-3 text-sm font-medium"><CheckCircle size={18} className="text-green-500 shadow-sm"/>{i}</div>))}</div>
                   </div>
                   
                   <div className=\"space-y-4\">
                      <h4 className=\"font-bold text-xs uppercase text-slate-400 border-b pb-2 tracking-widest\">Ã‰lÃ©ments Ã  restituer (VÃ©rification entrÃ©e)</h4>
                      <div className=\"space-y-2\">
                   <div className="space-y-4">
                      <h4 className="font-bold text-xs uppercase text-slate-400 border-b pb-2 tracking-widest">Éléments à restituer (Vérification entrée)</h4>
                      <div className="space-y-2">
                        {entryItems.map(item => {
                            const wasReceived = data.receivedItems?.[item.key];
                            if (!wasReceived) return null;
                            
                            const isChecked = data.deliveryReturnChecks?.[item.key];

                            return (
                                <label key={item.key} className={`flex items-center gap-3 p-3 rounded border cursor-pointer transition-all ${isChecked ? 'bg-green-50 border-green-200 text-green-800' : 'bg-white border-gray-200 text-gray-600'}`}>
                                    <input 
                                        type="checkbox" 
                                        checked={!!isChecked} 
                                        onChange={() => toggleReturnCheck(item.key)}
                                        className="w-5 h-5 accent-green-600" 
                                    />
                                    <span className="text-sm font-medium">{item.label}</span>
                                    <span className="text-[10px] uppercase bg-amber-100 text-amber-700 px-2 py-0.5 rounded ml-auto">ReÃ§u</span>
                                    <span className="text-[10px] uppercase bg-amber-100 text-amber-700 px-2 py-0.5 rounded ml-auto">Reçu</span>
                                </label>
                            );
                        })}
                        {!Object.values(data.receivedItems || {}).some(v => v === true) && <p className="text-xs text-slate-400 italic">Aucun Ã©lÃ©ment spÃ©cifique notÃ© Ã  l'entrÃ©e.</p>}
                        {!Object.values(data.receivedItems || {}).some(v => v === true) && <p className="text-xs text-slate-400 italic">Aucun élément spécifique noté à l'entrée.</p>}
                      </div>
                   </div>

                   <div className=\"space-y-4 md:col-span-2\">
                      <h4 className=\"font-bold text-xs uppercase text-slate-400 border-b pb-2 tracking-widest\">Signature rÃ©ceptionnaire</h4>
                      <div className=\"w-full h-32 border-2 border-dashed border-slate-200 rounded-2xl bg-slate-50 flex flex-col items-center justify-center text-slate-300 text-xs italic shadow-inner\"><PenTool size={40} className=\"mb-2 opacity-10\"/><p>Signature numÃ©rique</p></div>
                   <div className="space-y-4 md:col-span-2">
                      <h4 className="font-bold text-xs uppercase text-slate-400 border-b pb-2 tracking-widest">Signature réceptionnaire</h4>
                      <div className="w-full h-32 border-2 border-dashed border-slate-200 rounded-2xl bg-slate-50 flex flex-col items-center justify-center text-slate-300 text-xs italic shadow-inner"><PenTool size={40} className="mb-2 opacity-10"/><p>Signature numérique</p></div>
                   </div>
                </div>
              </div>
              <div className={`fixed bottom-0 left-0 right-0 ${panelBg} border-t ${panelBorder} p-4 flex justify-end z-30 md:pl-64 shadow-xl`}><button onClick={onValidateStep} className="bg-green-600 text-white px-6 py-3 rounded-lg font-bold flex items-center gap-2 shadow-lg"><CheckCircle size={18}/> Valider livraison & gÃ©nÃ©rer rapport</button></div>
              <div className={`fixed bottom-0 left-0 right-0 ${panelBg} border-t ${panelBorder} p-4 flex justify-end z-30 md:pl-64 shadow-xl`}><button onClick={onValidateStep} className="bg-green-600 text-white px-6 py-3 rounded-lg font-bold flex items-center gap-2 shadow-lg"><CheckCircle size={18}/> Valider livraison & générer rapport</button></div>
            </div>
          );
        };

        const QuoteBuilder = ({ data, updateData, onValidateStep }) => {
          const { panelBg, panelBorder, textMain, accentText, textSec } = useTheme();

          const mandatory = data.quote?.mandatory || [];
          const optional = data.quote?.optional || [];
          const totalMandatory = mandatory.reduce((sum, item) => sum + (item.priceHT || 0), 0);
          const totalOptional = optional.reduce((sum, item) => sum + (item.priceHT || 0), 0);

          const handleAccept = () => {
            updateData({ ...data, statusStep: 4, quoteAcceptedDate: new Date().toISOString() });
            onValidateStep();
          };

          return (
            <div className="p-6 max-w-5xl mx-auto space-y-6 pb-24">
              <div className={`${panelBg} p-8 rounded-xl border ${panelBorder} shadow-lg`} id="quote-print">
                <div className="flex justify-between items-start mb-8 border-b pb-6">
                   <div>
                      <h1 className="text-2xl font-bold uppercase tracking-widest mb-1 text-slate-900 dark:text-white">Devis de RÃ©paration</h1>
                      <p className="text-sm text-slate-500 font-mono">RÃ‰F: {data.id} / DATE: {new Date().toLocaleDateString()}</p>
                      <h1 className="text-2xl font-bold uppercase tracking-widest mb-1 text-slate-900 dark:text-white">Devis de Réparation</h1>
                      <p className="text-sm text-slate-500 font-mono">RÉF: {data.id} / DATE: {new Date().toLocaleDateString()}</p>
                   </div>
                   <div className="text-right">
                      <h2 className="font-bold text-lg">{data.client}</h2>
                      <p className="text-sm text-slate-500">{data.model} - {data.serial}</p>
                   </div>
                </div>

                <div className="space-y-8">
                   <div>
                      <h3 className="font-bold text-sm uppercase text-amber-600 mb-3 border-b border-amber-200 pb-1">Travaux Indispensables (Obligatoires)</h3>
                      <p className="text-xs text-slate-500 mb-3 italic">Ces interventions sont nÃ©cessaires pour garantir le bon fonctionnement de votre garde-temps.</p>
                      <p className="text-xs text-slate-500 mb-3 italic">Ces interventions sont nécessaires pour garantir le bon fonctionnement de votre garde-temps.</p>
                      <table className="w-full text-sm">
                         <tbody className="divide-y divide-gray-100">
                            {mandatory.length > 0 ? mandatory.map((item, idx) => (
                               <tr key={idx}>
                                  <td className="py-2">{item.name}</td>
                                  <td className="py-2 text-right font-mono">{item.priceHT === 0 ? 'Inclus/Gar.' : `${item.priceHT.toFixed(2)} CHF`}</td>
                               </tr>
                            )) : <tr><td colSpan="2" className="py-2 text-slate-400 italic">Aucun travaux obligatoire spÃ©cifique.</td></tr>}
                         </tbody>
                         <tfoot className="font-bold border-t border-gray-200">
                            <tr>
                               <td className="pt-3 text-right uppercase text-xs">Sous-total Obligatoire HT</td>
                               <td className="pt-3 text-right">{totalMandatory.toFixed(2)} CHF</td>
                            </tr>
                         </tfoot>
                      </table>
                   </div>

                   {optional.length > 0 && (
                     <div>
                        <h3 className="font-bold text-sm uppercase text-blue-600 mb-3 border-b border-blue-200 pb-1">Travaux EsthÃ©tiques (Optionnels)</h3>
                        <p className="text-xs text-slate-500 mb-3 italic">Ces interventions sont recommandÃ©es pour redonner l'Ã©clat d'origine mais ne sont pas techniques.</p>
                        <table className=\"w-full text-sm\">
                           <tbody className=\"divide-y divide-gray-100\">
                        <h3 className="font-bold text-sm uppercase text-blue-600 mb-3 border-b border-blue-200 pb-1">Travaux Esthétiques (Optionnels)</h3>
                        <p className="text-xs text-slate-500 mb-3 italic">Ces interventions sont recommandées pour redonner l'éclat d'origine mais ne sont pas techniques.</p>
                        <table className="w-full text-sm">
                           <tbody className="divide-y divide-gray-100">
                              {optional.map((item, idx) => (
                                 <tr key={idx}>
                                    <td className=\"py-2 flex items-center gap-2\">
                                       <input type=\"checkbox\" className=\"accent-blue-600\" defaultChecked />
                                    <td className="py-2 flex items-center gap-2">
                                       <input type="checkbox" className="accent-blue-600" defaultChecked />
                                       {item.name}
                                    </td>
                                    <td className=\"py-2 text-right font-mono\">{item.priceHT === 0 ? 'Offert' : `${item.priceHT.toFixed(2)} CHF`}</td>
                                    <td className="py-2 text-right font-mono">{item.priceHT === 0 ? 'Offert' : `${item.priceHT.toFixed(2)} CHF`}</td>
                                 </tr>
                              ))}
                           </tbody>
                        </table>
                     </div>
                   )}

                   <div className="bg-slate-50 dark:bg-slate-900 p-4 rounded-lg flex justify-between items-center mt-6">
                      <div className="text-xs text-slate-500 max-w-md">
                         * Les prix sont indiquÃ©s en CHF Hors Taxes. La TVA de 8.1% sera ajoutÃ©e Ã  la facturation finale. Garantie de 2 ans sur l'intervention.
                         * Les prix sont indiqués en CHF Hors Taxes. La TVA de 8.1% sera ajoutée à la facturation finale. Garantie de 2 ans sur l'intervention.
                      </div>
                      <div className=\"text-right\">
                         <div className=\"text-sm uppercase text-slate-500 font-bold\">Total EstimÃ© HT</div>
                         <div className=\"text-2xl font-bold text-amber-600\">{(totalMandatory + totalOptional).toFixed(2)} CHF</div>
                      <div className="text-right">
                         <div className="text-sm uppercase text-slate-500 font-bold">Total Estimé HT</div>
                         <div className="text-2xl font-bold text-amber-600">{(totalMandatory + totalOptional).toFixed(2)} CHF</div>
                      </div>
                   </div>
                </div>
              </div>

              <div className={`fixed bottom-0 left-0 right-0 ${panelBg} border-t ${panelBorder} p-4 flex justify-between z-30 md:pl-64 shadow-xl`}>
                 <button className="text-red-500 font-bold text-sm px-4 py-2 hover:bg-red-50 rounded">Refuser le devis</button>
                 <div className="flex gap-4">
                     {/* SUPPRESSION BOUTON IMPRIMER */}
                     <button onClick={handleAccept} className="bg-green-600 text-white px-6 py-2 rounded-lg font-bold flex items-center gap-2 shadow-lg hover:scale-105 transition-transform"><CheckCircle size={18}/> Accepter & Lancer rÃ©paration</button>
                     <button onClick={handleAccept} className="bg-green-600 text-white px-6 py-2 rounded-lg font-bold flex items-center gap-2 shadow-lg hover:scale-105 transition-transform"><CheckCircle size={18}/> Accepter & Lancer réparation</button>
                 </div>
              </div>
            </div>
          );
        };

        const FinalReportSheet = ({ data, onValidateStep }) => {
          const { panelBg, panelBorder, accentText } = useTheme();
          
          const receiptPhotos = (data.photos || []).filter(p => p.category === 'receipt');
          const partsPhotos = (data.photos || []).filter(p => p.category === 'parts');
          const finalPhotos = (data.photos || []).filter(p => p.category === 'final');

          const operationsPerformed = (data.operations || []).filter(op => op.status === 'TerminÃ©' || !op.status); 
          const operationsPerformed = (data.operations || []).filter(op => op.status === 'Terminé' || !op.status); 

          const calculateAverages = () => {
              if (!data.finalMeasures) return null;
              let totalRate = 0, totalAmp = 0, count = 0;
              let minRate = Infinity, maxRate = -Infinity;

              Object.values(data.finalMeasures).forEach(m => {
                  if (m.rate && m.rate !== '') {
                      const r = parseFloat(m.rate);
                      totalRate += r;
                      if (r < minRate) minRate = r;
                      if (r > maxRate) maxRate = r;
                      count++;
                  }
                  if (m.amp && m.amp !== '') totalAmp += parseFloat(m.amp);
              });

              if (count === 0) return null;
              return {
                  avgRate: (totalRate / count).toFixed(1),
                  avgAmp: (totalAmp / count).toFixed(0),
                  delta: (maxRate - minRate).toFixed(1)
              };
          };

          const averages = calculateAverages();

          return (
            <div className=\"p-6 max-w-5xl mx-auto space-y-8 pb-24 animate-in fade-in duration-700\">
              <div className=\"bg-white text-slate-900 shadow-2xl p-12 min-h-[1000px] flex flex-col font-serif rounded-sm border relative\" id=\"report-print\">
            <div className="p-6 max-w-5xl mx-auto space-y-8 pb-24 animate-in fade-in duration-700">
              <div className="bg-white text-slate-900 shadow-2xl p-12 min-h-[1000px] flex flex-col font-serif rounded-sm border relative" id="report-print">
                
                <div className=\"text-center border-b-4 border-double border-slate-900 pb-8 mb-12\">
                   <h1 className=\"text-4xl font-bold tracking-[0.2em] uppercase text-slate-900 mb-2\">Rapport de rÃ©paration</h1>
                   <p className=\"text-sm font-sans uppercase tracking-widest text-slate-500\">Watch Repair Plus - Atelier d'horlogerie</p>
                <div className="text-center border-b-4 border-double border-slate-900 pb-8 mb-12">
                   <h1 className="text-4xl font-bold tracking-[0.2em] uppercase text-slate-900 mb-2">Rapport de réparation</h1>
                   <p className="text-sm font-sans uppercase tracking-widest text-slate-500">Watch Repair Plus - Atelier d'horlogerie</p>
                </div>

                <div className=\"flex justify-between items-start mb-12 font-sans\">
                <div className="flex justify-between items-start mb-12 font-sans">
                   <div>
                      <p className=\"text-xs font-bold text-slate-400 uppercase tracking-widest mb-1\">Client</p>
                      <p className=\"font-bold text-lg\">{data.client}</p>
                      <p className=\"text-sm text-slate-600\">Dossier: {data.id}</p>
                      <p className="text-xs font-bold text-slate-400 uppercase tracking-widest mb-1">Client</p>
                      <p className="font-bold text-lg">{data.client}</p>
                      <p className="text-sm text-slate-600">Dossier: {data.id}</p>
                   </div>
                   <div className=\"text-right\">
                      <p className=\"text-xs font-bold text-slate-400 uppercase tracking-widest mb-1\">La montre</p>
                      <p className=\"font-bold text-lg\">{data.model}</p>
                      <p className=\"text-sm font-mono\">{data.serial}</p>
                   <div className="text-right">
                      <p className="text-xs font-bold text-slate-400 uppercase tracking-widest mb-1">La montre</p>
                      <p className="font-bold text-lg">{data.model}</p>
                      <p className="text-sm font-mono">{data.serial}</p>
                   </div>
                </div>

                {/* SECTION 1: Ã‰TAT INITIAL */}
                <div className=\"mb-10\">
                   <h3 className=\"font-sans font-bold text-sm uppercase tracking-widest border-b border-slate-200 pb-2 mb-4 text-amber-700\">1. Ã‰tat Ã  rÃ©ception & diagnostic</h3>
                {/* SECTION 1: ÉTAT INITIAL */}
                <div className="mb-10">
                   <h3 className="font-sans font-bold text-sm uppercase tracking-widest border-b border-slate-200 pb-2 mb-4 text-amber-700">1. État à réception & diagnostic</h3>
                   
                   <div className=\"mb-4\">
                        <h4 className=\"font-bold text-xs uppercase text-slate-500 mb-1\">Demande client</h4>
                        <p className=\"text-sm text-slate-700 italic\">\"{data.customerRequestText || 'Pas de demande spÃ©cifique notÃ©e'}\"</p>
                   <div className="mb-4">
                        <h4 className="font-bold text-xs uppercase text-slate-500 mb-1">Demande client</h4>
                        <p className="text-sm text-slate-700 italic">"{data.customerRequestText || 'Pas de demande spécifique notée'}"</p>
                   </div>
                   
                   <div className=\"mb-4\">
                        <h4 className=\"font-bold text-xs uppercase text-slate-500 mb-1\">ProblÃ¨me remontÃ©</h4>
                        <p className=\"text-sm text-slate-700\">\"{data.issue || 'Aucun problÃ¨me particulier signalÃ©'}\"</p>
                   <div className="mb-4">
                        <h4 className="font-bold text-xs uppercase text-slate-500 mb-1">Problème remonté</h4>
                        <p className="text-sm text-slate-700">"{data.issue || 'Aucun problème particulier signalé'}"</p>
                   </div>

                   {receiptPhotos.length > 0 ? (
                     <div className=\"grid grid-cols-4 gap-4\">
                     <div className="grid grid-cols-4 gap-4">
                        {receiptPhotos.map(p => (
                          <div key={p.id} className=\"aspect-square bg-slate-100 rounded overflow-hidden border\"><img src={p.url} className=\"w-full h-full object-cover\"/></div>
                          <div key={p.id} className="aspect-square bg-slate-100 rounded overflow-hidden border"><img src={p.url} className="w-full h-full object-cover"/></div>
                        ))}
                     </div>
                   ) : <p className=\"text-xs text-slate-400\">Aucune photo Ã  rÃ©ception.</p>}
                   ) : <p className="text-xs text-slate-400">Aucune photo à réception.</p>}
                </div>

                {/* SECTION 2: INTERVENTION */}
                <div className=\"mb-10\">
                   <h3 className=\"font-sans font-bold text-sm uppercase tracking-widest border-b border-slate-200 pb-2 mb-4 text-amber-700\">2. Intervention technique</h3>
                   <div className=\"grid grid-cols-2 gap-8\">
                <div className="mb-10">
                   <h3 className="font-sans font-bold text-sm uppercase tracking-widest border-b border-slate-200 pb-2 mb-4 text-amber-700">2. Intervention technique</h3>
                   <div className="grid grid-cols-2 gap-8">
                      <div>
                         <h4 className=\"font-bold text-xs uppercase mb-2\">OpÃ©rations rÃ©alisÃ©es</h4>
                         <ul className=\"list-disc list-inside text-sm text-slate-700 space-y-1\">
                         <h4 className="font-bold text-xs uppercase mb-2">Opérations réalisées</h4>
                         <ul className="list-disc list-inside text-sm text-slate-700 space-y-1">
                            {operationsPerformed.length > 0 ? operationsPerformed.map(op => (
                                <li key={op.id}>{op.description}</li>
                            )) : <li>Service complet standard</li>}
                         </ul>
                      </div>
                      <div>
                         <h4 className=\"font-bold text-xs uppercase mb-2\">Composants remplacÃ©s</h4>
                         <h4 className="font-bold text-xs uppercase mb-2">Composants remplacés</h4>
                         {partsPhotos.length > 0 ? (
                           <div className=\"grid grid-cols-3 gap-2 mb-2\">
                           <div className="grid grid-cols-3 gap-2 mb-2">
                              {partsPhotos.map(p => (
                                <div key={p.id} className=\"aspect-square bg-slate-100 rounded overflow-hidden border\"><img src={p.url} className=\"w-full h-full object-cover\"/></div>
                                <div key={p.id} className="aspect-square bg-slate-100 rounded overflow-hidden border"><img src={p.url} className="w-full h-full object-cover"/></div>
                              ))}
                           </div>
                         ) : <p className=\"text-xs text-slate-400 mb-2\">Aucune photo de composant.</p>}
                         <p className=\"text-xs text-slate-500 italic\">Toutes les piÃ¨ces remplacÃ©es sont d'origine certifiÃ©e.</p>
                         ) : <p className="text-xs text-slate-400 mb-2">Aucune photo de composant.</p>}
                         <p className="text-xs text-slate-500 italic">Toutes les pièces remplacées sont d'origine certifiée.</p>
                      </div>
                   </div>
                </div>

                {/* SECTION 3: RÃ‰SULTAT FINAL */}
                <div className=\"mb-10\">
                   <h3 className=\"font-sans font-bold text-sm uppercase tracking-widest border-b border-slate-200 pb-2 mb-4 text-amber-700\">3. RÃ©sultat final & ChronomÃ©trie</h3>
                   <div className=\"flex gap-4 items-center bg-slate-50 p-4 rounded mb-4\">
                      <div className=\"flex-1\">
                         <p className=\"text-sm font-bold text-green-700 flex items-center gap-2\"><CheckCircle size={16}/> ContrÃ´le qualitÃ© validÃ©</p>
                         <p className=\"text-xs text-slate-500 mt-1\">Ã‰tanchÃ©itÃ©, Marche, RÃ©serve de marche, EsthÃ©tique.</p>
                {/* SECTION 3: RÉSULTAT FINAL */}
                <div className="mb-10">
                   <h3 className="font-sans font-bold text-sm uppercase tracking-widest border-b border-slate-200 pb-2 mb-4 text-amber-700">3. Résultat final & Chronométrie</h3>
                   <div className="flex gap-4 items-center bg-slate-50 p-4 rounded mb-4">
                      <div className="flex-1">
                         <p className="text-sm font-bold text-green-700 flex items-center gap-2"><CheckCircle size={16}/> Contrôle qualité validé</p>
                         <p className="text-xs text-slate-500 mt-1">Étanchéité, Marche, Réserve de marche, Esthétique.</p>
                      </div>
                      <div className=\"text-right\">
                         <p className=\"text-xs font-bold uppercase text-slate-400\">Date de fin</p>
                         <p className=\"font-mono\">{new Date().toLocaleDateString()}</p>
                      <div className="text-right">
                         <p className="text-xs font-bold uppercase text-slate-400">Date de fin</p>
                         <p className="font-mono">{new Date().toLocaleDateString()}</p>
                      </div>
                   </div>
                   
                   <div className=\"grid grid-cols-2 gap-8 mb-6\">
                   <div className="grid grid-cols-2 gap-8 mb-6">
                        <div>
                            <h4 className=\"font-bold text-xs uppercase text-slate-500 mb-2\">SynthÃ¨se des Performances</h4>
                            <table className=\"w-full text-sm border-collapse border border-slate-200\">
                            <h4 className="font-bold text-xs uppercase text-slate-500 mb-2">Synthèse des Performances</h4>
                            <table className="w-full text-sm border-collapse border border-slate-200">
                                <tbody>
                                    <tr className=\"border-b border-slate-100\">
                                        <td className=\"p-2 font-medium bg-slate-50\">Marche Moyenne</td>
                                        <td className=\"p-2 text-right font-mono font-bold text-slate-700\">{averages ? `${averages.avgRate} s/j` : ''-'}</td>
                                    <tr className="border-b border-slate-100">
                                        <td className="p-2 font-medium bg-slate-50">Marche Moyenne</td>
                                        <td className="p-2 text-right font-mono font-bold text-slate-700">{averages ? `${averages.avgRate} s/j` : '-'}</td>
                                    </tr>
                                    <tr className=\"border-b border-slate-100\">
                                        <td className=\"p-2 font-medium bg-slate-50\">Amplitude Moyenne</td>
                                        <td className=\"p-2 text-right font-mono text-slate-700\">{averages ? `${averages.avgAmp}Â°` : ''-'}</td>
                                    <tr className="border-b border-slate-100">
                                        <td className="p-2 font-medium bg-slate-50">Amplitude Moyenne</td>
                                        <td className="p-2 text-right font-mono text-slate-700">{averages ? `${averages.avgAmp}°` : '-'}</td>
                                    </tr>
                                    <tr className=\"border-b border-slate-100\">
                                        <td className=\"p-2 font-medium bg-slate-50\">Delta (Max-Min)</td>
                                        <td className=\"p-2 text-right font-mono text-slate-700\">{averages ? `${averages.delta} s` : ''-'}</td>
                                    <tr className="border-b border-slate-100">
                                        <td className="p-2 font-medium bg-slate-50">Delta (Max-Min)</td>
                                        <td className="p-2 text-right font-mono text-slate-700">{averages ? `${averages.delta} s` : '-'}</td>
                                    </tr>
                                    <tr className=\"border-b border-slate-100\">
                                        <td className=\"p-2 font-bold bg-amber-50 text-amber-900\">RÃ©serve de Marche</td>
                                        <td className=\"p-2 text-right font-mono font-bold text-amber-700\">{data.powerReserve ? `${data.powerReserve} Heures` : ''-'}</td>
                                    <tr className="border-b border-slate-100">
                                        <td className="p-2 font-bold bg-amber-50 text-amber-900">Réserve de Marche</td>
                                        <td className="p-2 text-right font-mono font-bold text-amber-700">{data.powerReserve ? `${data.powerReserve} Heures` : '-'}</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                        <div>
                            <h4 className=\"font-bold text-xs uppercase text-slate-500 mb-2\">DÃ©tail par position</h4>
                            <div className=\"grid grid-cols-2 gap-2 text-[10px]\">
                            <h4 className="font-bold text-xs uppercase text-slate-500 mb-2">Détail par position</h4>
                            <div className="grid grid-cols-2 gap-2 text-[10px]">
                                {data.finalMeasures && Object.entries(data.finalMeasures).map(([key, val]) => (
                                    <div key={key} className=\"bg-slate-50 p-1 border rounded flex justify-between items-center\">
                                        <span className=\"font-bold uppercase text-slate-400\">{key}</span>
                                        <span className=\"font-mono\">{val.rate ? `${val.rate}s` : ''-'} / {val.amp ? `${val.amp}Â°` : ''-'}</span>
                                    <div key={key} className="bg-slate-50 p-1 border rounded flex justify-between items-center">
                                        <span className="font-bold uppercase text-slate-400">{key}</span>
                                        <span className="font-mono">{val.rate ? `${val.rate}s` : '-'} / {val.amp ? `${val.amp}°` : '-'}</span>
                                    </div>
                                ))}
                            </div>
                        </div>
                   </div>

                   {finalPhotos.length > 0 ? (
                     <div className=\"grid grid-cols-2 gap-4\">
                     <div className="grid grid-cols-2 gap-4">
                        {finalPhotos.map(p => (
                          <div key={p.id} className=\"aspect-video bg-slate-100 rounded overflow-hidden border shadow-sm\"><img src={p.url} className=\"w-full h-full object-cover\"/></div>
                          <div key={p.id} className="aspect-video bg-slate-100 rounded overflow-hidden border shadow-sm"><img src={p.url} className="w-full h-full object-cover"/></div>
                        ))}
                     </div>
                   ) : <p className=\"text-xs text-slate-400\">Aucune photo finale.</p>}
                   ) : <p className="text-xs text-slate-400">Aucune photo finale.</p>}
                </div>

                <div className=\"mt-auto pt-8 border-t border-slate-200 text-center\">
                   <div className=\"mt-8 flex justify-center gap-10 text-[10px] uppercase font-bold tracking-widest text-slate-500\">
                <div className="mt-auto pt-8 border-t border-slate-200 text-center">
                   <div className="mt-8 flex justify-center gap-10 text-[10px] uppercase font-bold tracking-widest text-slate-500">
                      <div>Signature de l'horloger</div>
                      <div>Cachet de l'atelier</div>
                   </div>
                </div>

              </div>
              <div className={`fixed bottom-0 left-0 right-0 ${panelBg} border-t ${panelBorder} p-4 flex justify-between z-30 md:pl-64 shadow-xl`}>
                 {/* SUPPRESSION BOUTON IMPRIMER */}
                 <button onClick={onValidateStep} className="bg-green-600 text-white px-6 py-3 rounded-lg font-bold flex items-center gap-2 shadow-lg"><CheckCircle size={18}/> Aller Ã  la facturation</button>
                 <button onClick={onValidateStep} className="bg-green-600 text-white px-6 py-3 rounded-lg font-bold flex items-center gap-2 shadow-lg"><CheckCircle size={18}/> Aller à la facturation</button>
              </div>
            </div>
          );
        };

        const InvoiceSheet = ({ data, updateData, onValidateStep }) => {
          const { panelBg, panelBorder, textMain, accentText } = useTheme();

          const mandatory = data.quote?.mandatory || [];
          const optional = data.quote?.optional || []; 
          const totalHT = [...mandatory, ...optional].reduce((sum, i) => sum + (i.priceHT || 0), 0);
          const tva = totalHT * VAT_RATE;
          const shipping = data.invoiceShipping || 0;
          const discount = data.invoiceDiscount || 0;
          const totalTTC = totalHT + tva + shipping - discount;

          return (
            <div className="p-6 max-w-5xl mx-auto space-y-6 pb-24 animate-in fade-in">
              <div className="bg-white text-slate-900 shadow-2xl p-10 min-h-[800px] flex flex-col font-sans rounded-sm border relative" id="invoice-print">
                 
                 <div className="flex justify-between items-start mb-12">
                    <div>
                       <h1 className="text-4xl font-bold tracking-tighter uppercase mb-2 text-slate-900">Facture</h1>
                       <p className="text-slate-500 font-medium text-sm">Watch Repair Plus SA</p>
                       <p className="text-slate-500 text-xs">Rue du RhÃ´ne 100, 1204 GenÃ¨ve</p>
                       <p className="text-slate-500 text-xs">Rue du Rhône 100, 1204 Genève</p>
                       <p className="text-slate-500 text-xs">TVA: CHE-123.456.789</p>
                    </div>
                    <div className="text-right">
                       <div className="mb-4">
                           <h2 className="font-bold text-xl">{data.client}</h2>
                           <p className="text-sm">{data.clientAddress}</p>
                           <p className="text-sm">{data.clientZip} {data.clientCity}</p>
                       </div>
                       <div className="text-sm text-slate-500">
                          <span className="font-bold uppercase mr-2">NÂ° Facture:</span> {data.id.replace('RO', 'FAC')}
                          <span className="font-bold uppercase mr-2">N° Facture:</span> {data.id.replace('RO', 'FAC')}
                       </div>
                       <div className=\"text-sm text-slate-500\">
                          <span className=\"font-bold uppercase mr-2\">Date:</span> {new Date().toLocaleDateString()}
                       <div className="text-sm text-slate-500">
                          <span className="font-bold uppercase mr-2">Date:</span> {new Date().toLocaleDateString()}
                       </div>
                    </div>
                 </div>

                 <table className=\"w-full text-sm mb-8\">
                    <thead className=\"border-b-2 border-slate-900 uppercase text-xs font-bold tracking-widest text-slate-500\">
                 <table className="w-full text-sm mb-8">
                    <thead className="border-b-2 border-slate-900 uppercase text-xs font-bold tracking-widest text-slate-500">
                       <tr>
                          <th className=\"py-3 text-left\">Description</th>
                          <th className=\"py-3 text-right\">Montant HT</th>
                          <th className="py-3 text-left">Description</th>
                          <th className="py-3 text-right">Montant HT</th>
                       </tr>
                    </thead>
                    <tbody className=\"divide-y divide-gray-100\">
                    <tbody className="divide-y divide-gray-100">
                       {[...mandatory, ...optional].map((item, i) => (
                          <tr key={i}>
                             <td className=\"py-3\">{item.name}</td>
                             <td className=\"py-3 text-right font-mono\">{item.priceHT === 0 ? '0.00' : item.priceHT.toFixed(2)}</td>
                             <td className="py-3">{item.name}</td>
                             <td className="py-3 text-right font-mono">{item.priceHT === 0 ? '0.00' : item.priceHT.toFixed(2)}</td>
                          </tr>
                       ))}
                       <tr>
                          <td className=\"py-3 text-slate-500 italic\">Frais de port et emballage sÃ©curisÃ©</td>
                          <td className=\"py-3 text-right font-mono\">{shipping.toFixed(2)}</td>
                          <td className="py-3 text-slate-500 italic">Frais de port et emballage sécurisé</td>
                          <td className="py-3 text-right font-mono">{shipping.toFixed(2)}</td>
                       </tr>
                       {discount > 0 && (
                           <tr>
                              <td className=\"py-3 text-green-600 italic\">Remise commerciale</td>
                              <td className=\"py-3 text-right font-mono text-green-600\">-{discount.toFixed(2)}</td>
                              <td className="py-3 text-green-600 italic">Remise commerciale</td>
                              <td className="py-3 text-right font-mono text-green-600">-{discount.toFixed(2)}</td>
                           </tr>
                       )}
                    </tbody>
                 </table>

                 <div className=\"flex justify-end mb-12\">
                    <div className=\"w-64\">
                       <div className=\"flex justify-between py-1 text-sm\">
                          <span className=\"text-slate-500\">Total HT</span>
                          <span className=\"font-mono\">{(totalHT + shipping - discount).toFixed(2)}</span>
                 <div className="flex justify-end mb-12">
                    <div className="w-64">
                       <div className="flex justify-between py-1 text-sm">
                          <span className="text-slate-500">Total HT</span>
                          <span className="font-mono">{(totalHT + shipping - discount).toFixed(2)}</span>
                       </div>
                       <div className=\"flex justify-between py-1 text-sm\">
                          <span className=\"text-slate-500\">TVA (8.1%)</span>
                          <span className=\"font-mono\">{tva.toFixed(2)}</span>
                       <div className="flex justify-between py-1 text-sm">
                          <span className="text-slate-500">TVA (8.1%)</span>
                          <span className="font-mono">{tva.toFixed(2)}</span>
                       </div>
                       <div className=\"flex justify-between py-3 border-t-2 border-slate-900 mt-2 text-lg font-bold\">
                       <div className="flex justify-between py-3 border-t-2 border-slate-900 mt-2 text-lg font-bold">
                          <span>Total TTC</span>
                          <span>{totalTTC.toFixed(2)} CHF</span>
                       </div>
                    </div>
                 </div>

                 <div className=\"mt-auto text-center text-xs text-slate-400\">
                    <p className=\"mb-2\">Garantie de 24 mois sur les travaux effectuÃ©s.</p>
                    <p>Merci de votre confiance. Paiement Ã  30 jours net.</p>
                    <p className=\"font-mono mt-4\">IBAN: CH50 0900 0000 1234 5678 9</p>
                 <div className="mt-auto text-center text-xs text-slate-400">
                    <p className="mb-2">Garantie de 24 mois sur les travaux effectués.</p>
                    <p>Merci de votre confiance. Paiement à 30 jours net.</p>
                    <p className="font-mono mt-4">IBAN: CH50 0900 0000 1234 5678 9</p>
                 </div>
              </div>
              
              <div className={`fixed bottom-0 left-0 right-0 ${panelBg} border-t ${panelBorder} p-4 flex justify-between z-30 md:pl-64 shadow-xl`}>
                 <button onClick={onValidateStep} className="bg-green-600 text-white px-6 py-3 rounded-lg font-bold flex items-center gap-2 shadow-lg"><CheckCircle size={18}/> ClÃ´turer le dossier</button>
                 <button onClick={onValidateStep} className="bg-green-600 text-white px-6 py-3 rounded-lg font-bold flex items-center gap-2 shadow-lg"><CheckCircle size={18}/> Clôturer le dossier</button>
              </div>
            </div>
          );
        };

        const InternalQuoteSheet = ({ data, updateData, onValidateStep }) => {
          const { panelBg, panelBorder, tableRowHover, textMain, inputBg, inputBorder, textSec, accentText } = useTheme();
          const [suggestedCoverage, setSuggestedCoverage] = useState(null);

          useEffect(() => {
            if (!data.depositDate) return;
            const deposit = new Date(data.depositDate);
            
            if (data.saleDate) {
              const sale = new Date(data.saleDate);
              const diffTime = deposit - sale;
              const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)); 
              if (diffDays >= 0 && diffDays <= 730) {
                setSuggestedCoverage({ type: 'warranty_sales', reason: `< 2 ans d'achat (${diffDays} jours)` });
                return;
              }
            }

            if (data.lastRepairDate) {
              const repair = new Date(data.lastRepairDate);
              const diffTime = deposit - repair;
              const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
              if (diffDays >= 0 && diffDays <= 365) {
                setSuggestedCoverage({ type: 'warranty_repair', reason: `< 1 an dernière réparation (${diffDays} jours)` });
                return;
              }
            }

            setSuggestedCoverage({ type: 'paid', reason: 'Hors délais de garantie' });
          }, [data.saleDate, data.lastRepairDate, data.depositDate]);

          const applySuggestion = () => {
            if (suggestedCoverage) {
              updateData({ ...data, coverageType: suggestedCoverage.type });
            }
          };

          const handlePriceChange = (rowId, newPrice) => {
            const matrix = data.internalQuoteMatrix || {};
            const row = matrix[rowId] || { oblig: false, opt: false, payant: true, gratuit: false, customPrice: '' };
            
            const updatedRow = { ...row, customPrice: newPrice };
            const newMatrix = { ...matrix, [rowId]: updatedRow };
            
            const def = PRICING_DB.find(p => p.id === rowId);
            if (def && (updatedRow.oblig || updatedRow.opt)) {
                const q = { ...data.quote } || { mandatory: [], optional: [] };
                
                q.mandatory = (q.mandatory || []).filter(i => i.id !== rowId);
                q.optional = (q.optional || []).filter(i => i.id !== rowId);
                
                const finalPrice = updatedRow.gratuit ? 0 : (newPrice !== '' ? parseFloat(newPrice) : def.priceHT);
                
                const item = { ...def, uuid: `matrix-${rowId}`, priceHT: finalPrice };
                
                if (updatedRow.oblig) q.mandatory.push(item);
                else q.optional.push(item);
                
                updateData({ ...data, internalQuoteMatrix: newMatrix, quote: q });
            } else {
                updateData({ ...data, internalQuoteMatrix: newMatrix });
            }
          };

          const handleToggle = (rowId, field, val) => {
            const matrix = data.internalQuoteMatrix || {};
            const row = matrix[rowId] || { oblig: false, opt: false, payant: true, gratuit: false, customPrice: '' };
            const updated = { ...row, [field]: val };
            
            if (field === 'oblig' && val) updated.opt = false;
            if (field === 'opt' && val) updated.oblig = false;
            if (field === 'payant' && val) updated.gratuit = false;
            if (field === 'gratuit' && val) updated.payant = false;

            const newMatrix = { ...matrix, [rowId]: updated };
            const def = PRICING_DB.find(p => p.id === rowId);
            
            if (def) {
              const q = { ...data.quote } || { mandatory: [], optional: [] };
              q.mandatory = (q.mandatory || []).filter(i => i.id !== rowId);
              q.optional = (q.optional || []).filter(i => i.id !== rowId);
              
              if (updated.oblig || updated.opt) {
                const priceToUse = (updated.customPrice !== '' && updated.customPrice !== undefined) ? parseFloat(updated.customPrice) : def.priceHT;
                const finalPrice = updated.gratuit ? 0 : priceToUse;
                
                const item = { ...def, uuid: `matrix-${rowId}`, priceHT: finalPrice };
                if (updated.oblig) q.mandatory.push(item);
                else q.optional.push(item);
              }
              updateData({ ...data, internalQuoteMatrix: newMatrix, quote: q });
            } else {
              updateData({ ...data, internalQuoteMatrix: newMatrix });
            }
          };

          const handleCoverageChange = (e) => {
            updateData({ ...data, coverageType: e.target.value });
          };

          useEffect(() => {
            if ((!data.internalQuoteMatrix || Object.keys(data.internalQuoteMatrix).length === 0) && data.quote?.mandatory?.length > 0) {
                const newMatrix = { ...data.internalQuoteMatrix };
                data.quote.mandatory.forEach(item => {
                    if (item.id) {
                        const isFree = data.coverageType !== 'paid' && !!data.coverageType;
                        newMatrix[item.id] = { 
                            oblig: true, 
                            opt: false, 
                            payant: !isFree, 
                            gratuit: isFree,
                            customPrice: item.priceHT
                        };
                    }
                });
                if (JSON.stringify(newMatrix) !== JSON.stringify(data.internalQuoteMatrix)) {
                     updateData({ ...data, internalQuoteMatrix: newMatrix });
                }
            }
          }, [data.id]); 

          const renderRow = (label, id) => {
            const row = data.internalQuoteMatrix?.[id] || {};
            const def = PRICING_DB.find(p => p.id === id);
            const displayPrice = row.customPrice !== undefined && row.customPrice !== '' ? row.customPrice : (def ? def.priceHT : 0);

            return (
              <tr key={id} className={`border-b ${panelBorder} ${tableRowHover}`}>
                <td className="p-3 text-sm font-medium">{label}</td>
                
                <td className="p-2 text-center">
                    <div className="flex items-center justify-center">
                        <input 
                            type="number" 
                            step="0.01" 
                            className={`w-20 text-right text-xs p-1 border rounded ${inputBorder} ${inputBg} ${textMain}`}
                            value={displayPrice}
                            onChange={(e) => handlePriceChange(id, e.target.value)}
                        />
                        <span className={`text-[10px] ml-1 ${textSec}`}>CHF</span>
                    </div>
                </td>

                <td className="p-2 text-center"><input type="checkbox" checked={!!row.oblig} onChange={e => handleToggle(id, 'oblig', e.target.checked)} className="w-4 h-4 accent-red-500" /></td>
                <td className="p-2 text-center"><input type="checkbox" checked={!!row.opt} onChange={e => handleToggle(id, 'opt', e.target.checked)} className="w-4 h-4 accent-blue-500" /></td>
                <td className="p-2 text-center"><input type="checkbox" checked={!!row.payant} onChange={e => handleToggle(id, 'payant', e.target.checked)} className="w-4 h-4 accent-green-500" /></td>
                <td className="p-2 text-center"><input type="checkbox" checked={!!row.gratuit} onChange={e => handleToggle(id, 'gratuit', e.target.checked)} className="w-4 h-4 accent-slate-500" /></td>
              </tr>
            );
          };

          return (
            <div className=\"p-6 max-w-5xl mx-auto space-y-6 pb-24\">
              {/* SECTION TYPE DE PRISE EN CHARGE */}
              <div className={`${panelBg} p-6 rounded-xl border ${panelBorder} mb-6 shadow-sm animate-in fade-in slide-in-from-top-4 duration-500`}>
                  <div className="flex justify-between items-center mb-4">
                    <h3 className={`text-lg font-bold ${accentText} flex items-center gap-2`}>
                        <ShieldCheck size={20} /> Type de prise en charge
                    </h3>
                    {suggestedCoverage && suggestedCoverage.type !== data.coverageType && (
                      <div className="flex items-center gap-2 bg-blue-50 dark:bg-blue-900/30 text-blue-600 dark:text-blue-300 px-3 py-1.5 rounded-lg border border-blue-100 dark:border-blue-800 text-xs animate-pulse">
                        <Lightbulb size={14} className="text-yellow-500"/>
                        <span className="font-bold">Suggestion : {COVERAGE_TYPES.find(c => c.id === suggestedCoverage.type)?.label}</span>
                        <span className="opacity-75 italic">({suggestedCoverage.reason})</span>
                        <button onClick={applySuggestion} className="ml-2 bg-blue-600 hover:bg-blue-700 text-white px-2 py-0.5 rounded text-[10px] font-bold uppercase transition-colors">Appliquer</button>
                      </div>
                    )}
                  </div>
                  
                  <div className="flex flex-col md:flex-row gap-4 items-start md:items-center">
                      <select 
                          value={data.coverageType || 'paid'} 
                          onChange={handleCoverageChange}
                          className={`flex-1 p-3 rounded-lg border ${inputBorder} ${inputBg} ${textMain} outline-none font-medium shadow-sm w-full md:w-auto`}
                      >
                          {COVERAGE_TYPES.map(type => (
                              <option key={type.id} value={type.id}>{type.label}</option>
                          ))}
                      </select>
                      <div className={`p-3 rounded-lg border ${inputBorder} ${inputBg} text-sm flex-1 w-full`}>
                           {data.coverageType === 'warranty_sales' && <span className="text-green-600 flex items-center gap-2 font-bold"><CheckCircle size={16}/> Les pièces et la main d'œuvre devraient être gratuits.</span>}
                           {data.coverageType === 'warranty_repair' && <span className="text-blue-600 flex items-center gap-2 font-bold"><CheckCircle size={16}/> Garantie SAV précédente appliquée.</span>}
                           {data.coverageType === 'goodwill' && <span className="text-amber-600 flex items-center gap-2 font-bold"><Star size={16}/> Geste commercial total ou partiel.</span>}
                           {(!data.coverageType || data.coverageType === 'paid') && <span className="text-slate-500 flex items-center gap-2"><DollarSign size={16}/> Facturation standard au client.</span>}
                      </div>
                  </div>
              </div>

              <div className={`${panelBg} border ${panelBorder} rounded-xl overflow-hidden shadow-lg animate-in slide-in-from-bottom-4 duration-500`}>
                <table className="w-full text-left border-collapse">
                  <thead className="bg-slate-100 dark:bg-slate-700 text-[10px] font-bold uppercase tracking-widest text-slate-500">
                      <tr>
                          <th className="p-4">Prestations & travaux</th>
                          <th className="p-2 text-center w-24">Prix unitaire</th>
                          <th className="p-2 text-center">Oblig.</th>
                          <th className="p-2 text-center">Opt.</th>
                          <th className="p-2 text-center">Payant</th>
                          <th className="p-2 text-center">Gratuit</th>
                      </tr>
                  </thead>
                  <tbody className={textMain}>
                    <tr className="bg-slate-50 dark:bg-slate-900/50 font-bold"><td colSpan="6" className="p-3 text-amber-600 text-[10px] uppercase tracking-widest">1. Services techniques principaux</td></tr>
                    {renderRow("Service complet", "srv_complet")}
                    {renderRow("Service partiel", "srv_partiel")}
                    {renderRow("RÃ©vision du mouvement", "srv_rev_mvt")}
                    {renderRow("ContrÃ´le", "srv_ctrl")}
                    {renderRow("RÃ©glage de la marche", "srv_reglage")}
                    {renderRow("DÃ©magnÃ©tisation", "srv_demag")}
                    {renderRow("Test dâ€™Ã©tanchÃ©itÃ©", "srv_etanche")}
                    {renderRow("Restauration horlogÃ¨re", "srv_restau")}
                    {renderRow("Révision du mouvement", "srv_rev_mvt")}
                    {renderRow("Contrôle", "srv_ctrl")}
                    {renderRow("Réglage de la marche", "srv_reglage")}
                    {renderRow("Démagnétisation", "srv_demag")}
                    {renderRow("Test d’étanchéité", "srv_etanche")}
                    {renderRow("Restauration horlogère", "srv_restau")}

                    {/* NOUVELLE SECTION SPECIALISEE */}
                    <tr className="bg-slate-50 dark:bg-slate-900/50 font-bold"><td colSpan="6" className="p-3 text-amber-600 text-[10px] uppercase tracking-widest mt-4">1bis. Services spÃ©cialisÃ©s / Restauration avancÃ©e</td></tr>
                    {renderRow("Restauration complÃ¨te (Patrimoine)", "srv_restau_compl")}
                    <tr className="bg-slate-50 dark:bg-slate-900/50 font-bold"><td colSpan="6" className="p-3 text-amber-600 text-[10px] uppercase tracking-widest mt-4">1bis. Services spécialisés / Restauration avancée</td></tr>
                    {renderRow("Restauration complète (Patrimoine)", "srv_restau_compl")}
                    {renderRow("Restauration Grande Complication", "srv_restau_master")}
                    {renderRow("Restauration Habillage & OrfÃ¨vrerie", "srv_restau_hab")}
                    {renderRow("Restauration Mouvement CompliquÃ©", "srv_restau_mvt")}
                    {renderRow("Restauration RÃ©pÃ©tition Minutes", "srv_restau_sonnerie")}
                    {renderRow("Restauration Habillage & Orfèvrerie", "srv_restau_hab")}
                    {renderRow("Restauration Mouvement Compliqué", "srv_restau_mvt")}
                    {renderRow("Restauration Répétition Minutes", "srv_restau_sonnerie")}
                    {renderRow("Redressage Gongs & Accordage", "srv_redressage")}
                    {renderRow("ContrÃ´le Ã©tanchÃ©itÃ©", "srv_etanche_na")}
                    {renderRow("Contrôle étanchéité", "srv_etanche_na")}

                    <tr className="bg-slate-50 dark:bg-slate-900/50 font-bold"><td colSpan="6" className="p-3 text-amber-600 text-[10px] uppercase tracking-widest mt-4">2. Services quartz</td></tr>
                    {renderRow("Remplacement de pile", "srv_pile")}
                    {renderRow("ContrÃ´le Ã©lectronique", "srv_ctrl_elec")}
                    {renderRow("Contrôle électronique", "srv_ctrl_elec")}

                    <tr className="bg-slate-50 dark:bg-slate-900/50 font-bold"><td colSpan="6" className="p-3 text-amber-600 text-[10px] uppercase tracking-widest mt-4">3. Services esthÃ©tiques</td></tr>
                    {renderRow("Polissage du boÃ®tier", "srv_pol_boite")}
                    <tr className="bg-slate-50 dark:bg-slate-900/50 font-bold"><td colSpan="6" className="p-3 text-amber-600 text-[10px] uppercase tracking-widest mt-4">3. Services esthétiques</td></tr>
                    {renderRow("Polissage du boîtier", "srv_pol_boite")}
                    {renderRow("Polissage du bracelet", "srv_pol_brac")}
                    {renderRow("Rhabillage esthÃ©tique", "srv_rhab_est")}
                    {renderRow("Nettoyage du boÃ®tier", "srv_net_boite")}
                    {renderRow("Rhabillage esthétique", "srv_rhab_est")}
                    {renderRow("Nettoyage du boîtier", "srv_net_boite")}

                    <tr className="bg-slate-50 dark:bg-slate-900/50 font-bold"><td colSpan="6" className="p-3 text-amber-600 text-[10px] uppercase tracking-widest mt-4">4. Services bracelet</td></tr>
                    {renderRow("Ajustement du bracelet", "srv_ajust_brac")}
                    {renderRow("RÃ©paration de bracelet", "srv_rep_brac")}
                    {renderRow("Réparation de bracelet", "srv_rep_brac")}
                    {renderRow("Remplacement de boucle / fermoir", "srv_remp_boucle")}
                    {renderRow("Nettoyage de bracelet", "srv_net_brac")}

                    <tr className="bg-slate-50 dark:bg-slate-900/50 font-bold"><td colSpan="6" className="p-3 text-blue-600 text-[10px] uppercase tracking-widest mt-4">PIÃˆCES MOUVEMENT</td></tr>
                    <tr className="bg-slate-50 dark:bg-slate-900/50 font-bold"><td colSpan="6" className="p-3 text-blue-600 text-[10px] uppercase tracking-widest mt-4">PIÈCES MOUVEMENT</td></tr>
                    {renderRow("Mouvement complet", "pm_mouvement")}
                    {renderRow("Masse", "pm_masse")}
                    {renderRow("Balancier", "pm_balancier")}
                    {renderRow("Pont", "pm_pont")}
                    {renderRow("Barillet", "pm_barillet")}
                    {renderRow("Platine", "pm_platine")}
                    {renderRow("Autre fourniture mouvement", "pm_autre1")}

                    <tr className="bg-slate-50 dark:bg-slate-900/50 font-bold"><td colSpan="6" className="p-3 text-blue-600 text-[10px] uppercase tracking-widest mt-4">PIÃˆCES HABILLEMENT</td></tr>
                    {renderRow("BoÃ®te complÃ¨te", "ph_boite_comp")}
                    <tr className="bg-slate-50 dark:bg-slate-900/50 font-bold"><td colSpan="6" className="p-3 text-blue-600 text-[10px] uppercase tracking-widest mt-4">PIÈCES HABILLEMENT</td></tr>
                    {renderRow("Boîte complète", "ph_boite_comp")}
                    {renderRow("Fond", "ph_fond")}
                    {renderRow("Lunette", "ph_lunette")}
                    {renderRow("Carrure", "ph_carrure")}
                    {renderRow("Cadran avec pieds", "ph_cadran_pieds")}
                    {renderRow("Cadran sans pied", "ph_cadran_sans")}
                    {renderRow("Cartouche", "ph_cadran_cart")}
                    {renderRow("Changement du bracelet", "ph_bracelet")}
                    {renderRow("Disque", "ph_disque")}
                    {renderRow("Aiguilles (jeu)", "ph_aiguille_jeu")}
                    {renderRow("Glace sus", "ph_glace_sus")}
                    {renderRow("Glace sous", "ph_glace_sous")}
                    {renderRow("Couronne", "ph_couronne")}
                    {renderRow("Tube de couronne", "ph_tube")}
                    {renderRow("Poussoir correcteur", "ph_poussoir_corr")}
                    {renderRow("Poussoir chrono", "ph_poussoir_chrono")}
                    {renderRow("Boucle ardillon", "ph_boucle_ard")}
                    {renderRow("Boucle dÃ©ployante", "ph_boucle_dep")}
                    {renderRow("Maillon", "ph_maillon")}
                    {renderRow("Fermoir de sÃ©curitÃ©", "ph_fermoir")}
                    {renderRow("Coiffe", "ph_coiffe")}
                    {renderRow("Vis maillons", "ph_vis")}
                    {renderRow("Barrette", "ph_barrette")}
                    {renderRow("Attache cuir", "ph_attache")}
                    {renderRow("Entre-cornes", "ph_entrecornes")}
                    {renderRow("Joints", "ph_joints")}
                    
                    {/* NOUVELLES PIECES SPECIALES */}
                    <tr className="bg-slate-50 dark:bg-slate-900/50 font-bold"><td colSpan="6" className="p-3 text-blue-600 text-[10px] uppercase tracking-widest mt-4">PIÃˆCES SPÃ‰CIALES (REFABRICATION)</td></tr>
                    <tr className="bg-slate-50 dark:bg-slate-900/50 font-bold"><td colSpan="6" className="p-3 text-blue-600 text-[10px] uppercase tracking-widest mt-4">PIÈCES SPÉCIALES (REFABRICATION)</td></tr>
                    {renderRow("Fabrication cadran neuf (identique)", "fab_cadran")}
                    {renderRow("Reconstruction BoÃ®tier Or Rose", "fab_boitier")}
                    {renderRow("Fabrication Cadran Ã‰mail", "fab_cadran_email")}
                    {renderRow("Fabrication Bracelet Or IntÃ©grÃ©", "fab_bracelet_or")}
                    {renderRow("Fabrication PiÃ¨ces (Came, Ressort)", "fab_pieces")}
                    {renderRow("Reconstruction Boîtier Or Rose", "fab_boitier")}
                    {renderRow("Fabrication Cadran Émail", "fab_cadran_email")}
                    {renderRow("Fabrication Bracelet Or Intégré", "fab_bracelet_or")}
                    {renderRow("Fabrication Pièces (Came, Ressort)", "fab_pieces")}
                  </tbody>
                </table>
              </div>
              <div className={`fixed bottom-0 left-0 right-0 ${panelBg} border-t ${panelBorder} p-4 flex justify-end z-30 md:pl-64 shadow-xl`}><button onClick={onValidateStep} className="bg-green-600 text-white px-6 py-3 rounded-lg font-bold flex items-center gap-2 shadow-lg"><CheckCircle size={18}/> Valider le diagnostic & suivant</button></div>
            </div>
          );
        };

        // --- CORE APP ---

        const App = () => {
          const [activeTab, setActiveTab] = useState('dashboard');
          const [isSidebarOpen, setSidebarOpen] = useState(false);
          const [isDark, setIsDark] = useState(false);
          const isOnline = true; // SimulÃ© pour compatibilitÃ©, plus de hook

          // Initial Repairs - Expanded List for Testing
          const initialRepairs = [
            // --- CAS 1 : VACHERON CONSTANTIN \"CORNES DE VACHE\" 1956 ---
            { 
                id: 'RO-VC-1956', 
                client: 'Famille du PropriÃ©taire (via Phillips)', 
                model: 'VC Chronographe Ref. 6087 Â« Cornes de Vache Â»', 
                client: 'Famille du Propriétaire (via Phillips)', 
                model: 'VC Chronographe Ref. 6087 « Cornes de Vache »', 
                serial: 'VC-489000', 
                statusStep: 8, // Dossier ClÃ´turÃ©
                statusStep: 8, // Dossier Clôturé
                depositDate: '2018-09-10', 
                saleDate: '1957-11-05', 
                productionDate: '1956-03-10',
                coverageType: 'paid',
                clientAddress: 'GenÃ¨ve, Suisse', 
                clientAddress: 'Genève, Suisse', 
                clientZip: '1204', 
                clientCity: 'GenÃ¨ve',
                customerRequestText: \"Restauration complÃ¨te en vue d'une vente aux enchÃ¨res. Remise en Ã©tat de marche impÃ©rative tout en prÃ©servant l'authenticitÃ© historique (ne pas polir, garder la patine).\",
                issue: \"Montre 'dans son jus', jamais restaurÃ©e. Poussoirs grippÃ©s. Mouvement complet mais huiles figÃ©es, encrassement gÃ©nÃ©ral. BoÃ®tier or jaune oxydÃ© mais sans chocs majeurs.\",
                workshopNotes: \"DÃ©montage intÃ©gral et nettoyage. Mouvement recalibrÃ©. Nettoyage ultrasons. Aucun rhabillage du boÃ®tier pour conserver les arÃªtes d'origine.\",
                clientCity: 'Genève',
                customerRequestText: "Restauration complète en vue d'une vente aux enchères. Remise en état de marche impérative tout en préservant l'authenticité historique (ne pas polir, garder la patine).",
                issue: "Montre 'dans son jus', jamais restaurée. Poussoirs grippés. Mouvement complet mais huiles figées, encrassement général. Boîtier or jaune oxydé mais sans chocs majeurs.",
                workshopNotes: "Démontage intégral et nettoyage. Mouvement recalibré. Nettoyage ultrasons. Aucun rhabillage du boîtier pour conserver les arêtes d'origine.",
                quote: { 
                    mandatory: [
                        { id: 'srv_restau_compl', name: 'Restauration complÃ¨te (Patrimoine)', priceHT: 15000.00, uuid: 'q1-1', type: 'labor' },
                        { id: 'srv_restau_compl', name: 'Restauration complète (Patrimoine)', priceHT: 15000.00, uuid: 'q1-1', type: 'labor' },
                        { id: 'fab_cadran', name: 'Fabrication cadran neuf (identique)', priceHT: 8500.00, uuid: 'q1-2', type: 'part' },
                        { id: 'srv_etanche_na', name: 'ContrÃ´le Ã©tanchÃ©itÃ©', priceHT: 0.00, uuid: 'q1-3', type: 'labor' }
                        { id: 'srv_etanche_na', name: 'Contrôle étanchéité', priceHT: 0.00, uuid: 'q1-3', type: 'labor' }
                    ], 
                    optional: [] 
                },
                internalQuoteMatrix: { srv_restau_compl: { oblig: true, customPrice: 15000.00 } },
                checklists: { visual: { 'Carrure': 3, 'Cadran': 2, 'Aiguilles': 2 }, functional: { 'Sonnerie': 0, 'RÃ©glage': 0 } },
                checklists: { visual: { 'Carrure': 3, 'Cadran': 2, 'Aiguilles': 2 }, functional: { 'Sonnerie': 0, 'Réglage': 0 } },
                receivedItems: { hasEcrin: false, hasCertAuth: true, docsVerified: true }, 
                finalControls: { identity: FINAL_CONTROL_ITEMS.identity, aesthetic: FINAL_CONTROL_ITEMS.aesthetic, technical: FINAL_CONTROL_ITEMS.technical },
                invoiceDiscount: 0, invoiceShipping: 500,
                powerReserve: 34,
                inspectionMeasures: {
                    ch: { rate: 12, amp: 230 },
                    cb: { rate: 9, amp: 225 },
                    '3h': { rate: 18, amp: 195 },
                    '9h': { rate: 10, amp: 185 },
                    '12h': { rate: 22, amp: 178 },
                    '6h': { rate: 14, amp: 190 }
                },
                finalMeasures: {
                    ch: { rate: 2, amp: 295 },
                    cb: { rate: 1, amp: 288 },
                    '3h': { rate: 0, amp: 255 },
                    '9h': { rate: 3, amp: 248 },
                    '12h': { rate: 4, amp: 242 },
                    '6h': { rate: 1, amp: 250 }
                },
                operations: [
                    { id: 'op1', opNumber: 10, department: 'Atelier Technique', description: 'DÃ©montage complet & dÃ©contamination Radium', stdTime: '4.00', status: 'TerminÃ©' },
                    { id: 'op2', opNumber: 20, department: 'Atelier Technique', description: 'Nettoyage & rhabillage mouvement', stdTime: '8.00', status: 'TerminÃ©' },
                    { id: 'op3', opNumber: 30, department: 'Atelier Habillage', description: 'Fabrication cadran copie conforme', stdTime: '12.00', status: 'TerminÃ©' },
                    { id: 'op4', opNumber: 40, department: 'Atelier Technique', description: 'RÃ©glage chronographe', stdTime: '6.00', status: 'TerminÃ©' }
                    { id: 'op1', opNumber: 10, department: 'Atelier Technique', description: 'Démontage complet & décontamination Radium', stdTime: '4.00', status: 'Terminé' },
                    { id: 'op2', opNumber: 20, department: 'Atelier Technique', description: 'Nettoyage & rhabillage mouvement', stdTime: '8.00', status: 'Terminé' },
                    { id: 'op3', opNumber: 30, department: 'Atelier Habillage', description: 'Fabrication cadran copie conforme', stdTime: '12.00', status: 'Terminé' },
                    { id: 'op4', opNumber: 40, department: 'Atelier Technique', description: 'Réglage chronographe', stdTime: '6.00', status: 'Terminé' }
                ]
            },

            // --- CAS 2 : AUDEMARS PIGUET QP 1957 ---
            { 
                id: 'RO-AP-1957', 
                client: 'Collection PrivÃ©e (M. Goldberger)', 
                model: 'AP Ref. 5516 QuantiÃ¨me PerpÃ©tuel', 
                client: 'Collection Privée (M. Goldberger)', 
                model: 'AP Ref. 5516 Quantième Perpétuel', 
                serial: 'AP-5516-009', 
                statusStep: 7, // Rapport gÃ©nÃ©rÃ©
                statusStep: 7, // Rapport généré
                depositDate: '2012-03-15', 
                saleDate: '1957-02-15', 
                productionDate: '1955-06-20',
                coverageType: 'paid', // Projet spÃ©cial
                coverageType: 'paid', // Projet spécial
                clientAddress: 'Via Montenapoleone 12', 
                clientZip: '20121', 
                clientCity: 'Milano',
                customerRequestText: \"Restauration complÃ¨te. Le mÃ©canisme de calendrier perpÃ©tuel bloque au passage de l'annÃ©e bissextile. Le boÃ®tier nÃ©cessite un rafraÃ®chissement respectueux.\",
                issue: \"BoÃ®tier avec oxydation. Cadran lÃ©gÃ¨rement piquÃ©. MÃ©canisme de sauts de quantiÃ¨me dur. Huiles figÃ©es.\",
                workshopNotes: \"Restauration complÃ¨te du calibre. Ajustement des cames de QP. Nettoyage boÃ®tier sans polissage agressif.\",
                customerRequestText: "Restauration complète. Le mécanisme de calendrier perpétuel bloque au passage de l'année bissextile. Le boîtier nécessite un rafraîchissement respectueux.",
                issue: "Boîtier avec oxydation. Cadran légèrement piqué. Mécanisme de sauts de quantième dur. Huiles figées.",
                workshopNotes: "Restauration complète du calibre. Ajustement des cames de QP. Nettoyage boîtier sans polissage agressif.",
                quote: { 
                    mandatory: [
                        { id: 'srv_restau_master', name: 'Restauration Grande Complication (26f)', priceHT: 45000.00, uuid: 'q2-1', type: 'labor' },
                        { id: 'fab_boitier', name: 'Fabrication BoÃ®tier Or Rose (Conforme)', priceHT: 25000.00, uuid: 'q2-2', type: 'part' },
                        { id: 'fab_cadran_email', name: 'Fabrication Cadran Ã‰mail Historique', priceHT: 5000.00, uuid: 'q2-3', type: 'part' },
                        { id: 'fab_boitier', name: 'Fabrication Boîtier Or Rose (Conforme)', priceHT: 25000.00, uuid: 'q2-2', type: 'part' },
                        { id: 'fab_cadran_email', name: 'Fabrication Cadran Émail Historique', priceHT: 5000.00, uuid: 'q2-3', type: 'part' },
                        { id: 'fab_pieces', name: 'Refabrication composants (Pivots, Ressorts)', priceHT: 4500.00, uuid: 'q2-4', type: 'part' }
                    ], 
                    optional: [] 
                },
                internalQuoteMatrix: { srv_restau_master: { oblig: true, customPrice: 45000.00 } },
                checklists: { visual: { 'Carrure': 5, 'Cadran': 5 }, functional: { 'Sonnerie': 1, 'RÃ©glage': 1 } }, 
                checklists: { visual: { 'Carrure': 5, 'Cadran': 5 }, functional: { 'Sonnerie': 1, 'Réglage': 1 } }, 
                receivedItems: { hasEcrin: false, docsVerified: true }, 
                finalControls: { 
                    identity: FINAL_CONTROL_ITEMS.identity, 
                    aesthetic: FINAL_CONTROL_ITEMS.aesthetic, 
                    technical: FINAL_CONTROL_ITEMS.technical 
                },
                powerReserve: 42,
                inspectionMeasures: {
                    ch: { rate: -145, amp: 160 },
                    cb: { rate: -158, amp: 155 },
                    '3h': { rate: -190, amp: 140 },
                    '9h': { rate: -185, amp: 142 },
                    '12h': { rate: -210, amp: 135 },
                    '6h': { rate: -175, amp: 145 }
                },
                finalMeasures: {
                    ch: { rate: 6, amp: 275 },
                    cb: { rate: 4, amp: 268 },
                    '3h': { rate: 1, amp: 235 },
                    '9h': { rate: 8, amp: 228 },
                    '12h': { rate: 10, amp: 220 },
                    '6h': { rate: 3, amp: 230 }
                },
                operations: [
                     { id: 'op21', opNumber: 10, department: 'Atelier Technique', description: 'Ã‰tude archives & plans 1899', stdTime: '20.00', status: 'TerminÃ©' },
                     { id: 'op22', opNumber: 20, department: 'Atelier Habillage', description: 'Usinage & dÃ©coration boÃ®tier Or Rose', stdTime: '50.00', status: 'TerminÃ©' },
                     { id: 'op23', opNumber: 30, department: 'Atelier Technique', description: 'Restauration Grande Sonnerie & Chrono', stdTime: '40.00', status: 'TerminÃ©' }
                     { id: 'op21', opNumber: 10, department: 'Atelier Technique', description: 'Étude archives & plans 1899', stdTime: '20.00', status: 'Terminé' },
                     { id: 'op22', opNumber: 20, department: 'Atelier Habillage', description: 'Usinage & décoration boîtier Or Rose', stdTime: '50.00', status: 'Terminé' },
                     { id: 'op23', opNumber: 30, department: 'Atelier Technique', description: 'Restauration Grande Sonnerie & Chrono', stdTime: '40.00', status: 'Terminé' }
                ]
            },

            // --- CAS 3 : PATEK PHILIPPE 2499/101J ---
            { 
                id: 'RO-PP-2499', 
                client: 'M. Tony Kavak', 
                model: 'Patek Philippe 2499/101J', 
                serial: 'PP-Unique-Integrated', 
                statusStep: 6, // En livraison
                depositDate: '2015-06-20', 
                saleDate: '1955-01-01', 
                productionDate: '1954-01-01',
                coverageType: 'paid',
                clientAddress: 'Bahnhofstrasse 30', 
                clientZip: '8001', 
                clientCity: 'ZÃ¼rich',
                customerRequestText: \"Restauration de la configuration d'origine. Le bracelet intÃ©grÃ© a Ã©tÃ© coupÃ© par un ancien propriÃ©taire et des cornes ont Ã©tÃ© soudÃ©es. Demande de suppression des cornes et recrÃ©ation du bracelet or 'grains de riz'.\",
                issue: \"Cornes ajoutÃ©es visibles (brasures). Carrure lÃ©gÃ¨rement polie. Mouvement CH 27-70 Q en bon Ã©tat mais huiles vieillissantes. Risque majeur sur poinÃ§ons lors de la dÃ©soudure.\",
                workshopNotes: \"Chauffe contrÃ´lÃ©e pour retrait cornes. Laser pour effacer traces brasure sans toucher les poinÃ§ons. Fabrication maillon par maillon du bracelet or intÃ©grÃ©. RÃ©vision mouvement standard.\",
                clientCity: 'Zürich',
                customerRequestText: "Restauration de la configuration d'origine. Le bracelet intégré a été coupé par un ancien propriétaire et des cornes ont été soudées. Demande de suppression des cornes et recréation du bracelet or 'grains de riz'.",
                issue: "Cornes ajoutées visibles (brasures). Carrure légèrement polie. Mouvement CH 27-70 Q en bon état mais huiles vieillissantes. Risque majeur sur poinçons lors de la désoudure.",
                workshopNotes: "Chauffe contrôlée pour retrait cornes. Laser pour effacer traces brasure sans toucher les poinçons. Fabrication maillon par maillon du bracelet or intégré. Révision mouvement standard.",
                quote: { 
                    mandatory: [
                        { id: 'fab_bracelet_or', name: 'Fabrication Bracelet Or IntÃ©grÃ© (Grains de riz)', priceHT: 18000.00, uuid: 'q3-1', type: 'part' },
                        { id: 'fab_bracelet_or', name: 'Fabrication Bracelet Or Intégré (Grains de riz)', priceHT: 18000.00, uuid: 'q3-1', type: 'part' },
                        { id: 'srv_restau_hab', name: 'Restauration Carrure (Suppression cornes)', priceHT: 12000.00, uuid: 'q3-2', type: 'labor' },
                        { id: 'srv_rev_mvt_compl', name: 'RÃ©vision Mouvement QP Chrono', priceHT: 3500.00, uuid: 'q3-3', type: 'labor' }
                        { id: 'srv_rev_mvt_compl', name: 'Révision Mouvement QP Chrono', priceHT: 3500.00, uuid: 'q3-3', type: 'labor' }
                    ], 
                    optional: [
                         { id: 'srv_pol_boite', name: 'LÃ©ger avivage final', priceHT: 180.00, uuid: 'q3-opt-1', type: 'labor' }
                         { id: 'srv_pol_boite', name: 'Léger avivage final', priceHT: 180.00, uuid: 'q3-opt-1', type: 'labor' }
                    ] 
                },
                internalQuoteMatrix: { fab_bracelet_or: { oblig: true, customPrice: 18000.00 } },
                checklists: { visual: { 'Carrure': 1, 'Bracelet': 0 }, functional: { 'RÃ©glage': 3, 'Ã‰tanchÃ©itÃ©': 2 } },
                checklists: { visual: { 'Carrure': 1, 'Bracelet': 0 }, functional: { 'Réglage': 3, 'Étanchéité': 2 } },
                receivedItems: { hasEcrin: true, hasCertAuth: true, docsVerified: true }, // MODIFIE: hasBox removed
                finalControls: { 
                    identity: FINAL_CONTROL_ITEMS.identity, 
                    aesthetic: FINAL_CONTROL_ITEMS.aesthetic, 
                    technical: FINAL_CONTROL_ITEMS.technical 
                },
                deliveryReturnChecks: { hasEcrin: true, hasCertAuth: true }, // MODIFIE: hasBox removed
                powerReserve: 58,
                inspectionMeasures: {
                    ch: { rate: 3, amp: 285 },
                    cb: { rate: 2, amp: 278 },
                    '3h': { rate: 6, amp: 235 },
                    '9h': { rate: 8, amp: 225 },
                    '12h': { rate: 10, amp: 220 },
                    '6h': { rate: 5, amp: 228 }
                },
                finalMeasures: {
                    ch: { rate: 1, amp: 300 },
                    cb: { rate: 2, amp: 292 },
                    '3h': { rate: -1, amp: 260 },
                    '9h': { rate: 3, amp: 252 },
                    '12h': { rate: 4, amp: 248 },
                    '6h': { rate: 0, amp: 255 }
                },
                operations: [
                     { id: 'op31', opNumber: 10, department: 'Atelier Polissage', description: 'DÃ©soudure cornes & reprise laser', stdTime: '15.00', status: 'TerminÃ©' },
                     { id: 'op32', opNumber: 20, department: 'Atelier Habillage', description: 'Fabrication & assemblage bracelet', stdTime: '30.00', status: 'TerminÃ©' },
                     { id: 'op33', opNumber: 30, department: 'Atelier Technique', description: 'Rhabillage mouvement QP', stdTime: '6.00', status: 'TerminÃ©' }
                     { id: 'op31', opNumber: 10, department: 'Atelier Polissage', description: 'Désoudure cornes & reprise laser', stdTime: '15.00', status: 'Terminé' },
                     { id: 'op32', opNumber: 20, department: 'Atelier Habillage', description: 'Fabrication & assemblage bracelet', stdTime: '30.00', status: 'Terminé' },
                     { id: 'op33', opNumber: 30, department: 'Atelier Technique', description: 'Rhabillage mouvement QP', stdTime: '6.00', status: 'Terminé' }
                ]
            }
          ];

          const [repairs, setRepairs] = useState(() => {
            try {
              // Changed key to force refresh
              const saved = localStorage.getItem('cscs_repairs_v27'); 
              return saved ? JSON.parse(saved) : initialRepairs;
            } catch (e) { return initialRepairs; }
          });

          const [currentRepair, setCurrentRepair] = useState(null);

          useEffect(() => { localStorage.setItem('cscs_repairs_v27', JSON.stringify(repairs)); }, [repairs]);

          // ON LOAD: Select first repair by default
          useEffect(() => {
             if (!currentRepair && repairs.length > 0) {
                 setCurrentRepair(repairs[0]);
             }
          }, []);

          const handleUpdateRepair = (upd) => {
            setCurrentRepair(upd);
            setRepairs(repairs.map(r => r.id === upd.id ? upd : r));
          };

          const createNewRepair = () => {
            const nr = { id: `RO-2026-${Math.floor(Math.random()*1000)}`, client: '', model: '', serial: '', statusStep: 0, depositDate: new Date().toISOString().split('T')[0], invoiceDiscount: undefined, invoiceShipping: 0, quote: { mandatory: [], optional: [] }, coverageType: 'paid', photos: [], receivedItems: {}, internalQuoteMatrix: {} }; 
            setRepairs([nr, ...repairs]);
            setCurrentRepair(nr);
            setActiveTab('client_request');
          };

          const navNext = (step, tab) => {
            if (currentRepair) handleUpdateRepair({ ...currentRepair, statusStep: step });
            setActiveTab(tab);
            window.scrollTo(0,0);
          };

          // Define these functions for use in the return statement
          const handleNextRepair = () => {
              const currentIndex = repairs.findIndex(r => r.id === currentRepair?.id);
              if (currentIndex !== -1 && currentIndex < repairs.length - 1) {
                  const nextRepair = repairs[currentIndex + 1];
                  setCurrentRepair(nextRepair);
              }
          };

          const handlePrevRepair = () => {
              const currentIndex = repairs.findIndex(r => r.id === currentRepair?.id);
              if (currentIndex !== -1 && currentIndex > 0) {
                  const prevRepair = repairs[currentIndex - 1];
                  setCurrentRepair(prevRepair);
              }
          };

          // Calculate prev/next repair existence for button states
          const currentIndex = repairs.findIndex(r => r.id === currentRepair?.id);
          const nextRepair = (currentIndex !== -1 && currentIndex < repairs.length - 1) ? repairs[currentIndex + 1] : null;
          const prevRepair = (currentIndex !== -1 && currentIndex > 0) ? repairs[currentIndex - 1] : null;

          const themeValues = getThemeClasses(isDark);

          const renderContent = () => {
            if (activeTab === 'dashboard') return <Dashboard repairs={repairs} selectRepair={r => { setCurrentRepair(r); setActiveTab('client_request'); }} createNewRepair={createNewRepair} />;
            if (!currentRepair) return <div className="p-20 text-center text-slate-400 font-bold uppercase tracking-widest opacity-40 select-none">SÃ©lectionner un dossier SAV</div>;

            switch (activeTab) {
              case 'client_request': return <ClientRequestForm data={currentRepair} updateData={handleUpdateRepair} onValidateStep={() => navNext(1, 'inspection')} />;
              case 'inspection': return <InspectionForm data={currentRepair} updateData={handleUpdateRepair} onValidateStep={() => navNext(2, 'internal_quote')} />;
              case 'internal_quote': return <InternalQuoteSheet data={currentRepair} updateData={handleUpdateRepair} onValidateStep={() => navNext(3, 'quote')} />;
              case 'quote': return <QuoteBuilder data={currentRepair} updateData={handleUpdateRepair} onValidateStep={() => navNext(5, 'workshop')} />;
              case 'workshop': return <WorkshopSheet data={currentRepair} updateData={handleUpdateRepair} onValidateStep={() => navNext(6, 'delivery')} />;
              case 'delivery': return <DeliverySheet data={currentRepair} updateData={handleUpdateRepair} onValidateStep={() => navNext(7, 'report')} />;
              case 'report': return <FinalReportSheet data={currentRepair} onValidateStep={() => navNext(8, 'invoice')} />;
              case 'invoice': return <InvoiceSheet data={currentRepair} updateData={handleUpdateRepair} onValidateStep={() => { setCurrentRepair(null); setActiveTab('dashboard'); }} />;
              default: return <Dashboard repairs={repairs} />;
            }
          };

          return (
            <ThemeContext.Provider value={themeValues}>
              <div className={`flex h-screen ${themeValues.appBg} ${themeValues.textMain} overflow-hidden font-sans antialiased`}>
                <Sidebar activeTab={activeTab} setActiveTab={setActiveTab} isOpen={isSidebarOpen} toggleSidebar={() => setSidebarOpen(!isSidebarOpen)} currentRepair={currentRepair} />
                <main className="flex-1 flex flex-col min-w-0 overflow-hidden relative">
                  <header className={`${themeValues.headerBg} border-b ${themeValues.headerBorder} p-4 flex justify-between items-center shadow-sm z-10`}>
                    <div className="flex items-center gap-4">
                      <button onClick={() => setSidebarOpen(true)} className="md:hidden text-slate-500 hover:bg-slate-100 p-2 rounded-lg transition-colors"><Menu size={20}/></button>
                    </div>
                    
                    {currentRepair && activeTab !== 'dashboard' && (
                        <div className="flex items-center gap-4">
                            <div className="flex items-center gap-2">
                                <button 
                                    onClick={handlePrevRepair} 
                                    disabled={!prevRepair}
                                    className={`p-2 rounded-full transition-colors ${prevRepair ? 'hover:bg-slate-100 text-slate-600' : 'text-slate-300 cursor-not-allowed'}`}
                                >
                                    <ArrowLeftCircle size={20} />
                                </button>
                                
                                <span className="text-sm font-bold font-mono bg-slate-100 px-3 py-1 rounded border border-slate-200 flex items-center gap-2">
                                    <span>{currentRepair.id}</span>
                                </span>

                                <button 
                                    onClick={handleNextRepair} 
                                    disabled={!nextRepair}
                                    className={`p-2 rounded-full transition-colors ${nextRepair ? 'hover:bg-slate-100 text-slate-600' : 'text-slate-300 cursor-not-allowed'}`}
                                >
                                    <ArrowRightCircle size={20} />
                                </button>
                            </div>

                            <div className={`hidden md:flex items-center gap-2 px-3 py-1.5 rounded-full text-[10px] font-bold uppercase tracking-wider ${currentRepair.statusStep >= 8 ? 'bg-green-100 text-green-700' : 'bg-blue-100 text-blue-700'}`}>
                                <div className={`w-2 h-2 rounded-full ${currentRepair.statusStep >= 8 ? 'bg-green-500' : 'bg-blue-500'}`}></div>
                                {STATUS_STEPS[currentRepair.statusStep]}
                            </div>
                        </div>
                    )}

                    <div className="flex items-center gap-3">
                       <button onClick={() => setIsDark(!isDark)} className={`p-2 rounded-lg transition-colors ${isDark ? 'bg-slate-800 text-amber-400' : 'bg-slate-100 text-slate-500'}`}>{isDark ? <Sun size={18}/> : <Moon size={18}/>}</button>
                       {currentRepair && activeTab !== 'dashboard' && <button onClick={() => { setCurrentRepair(null); setActiveTab('dashboard'); }} className="text-[10px] font-bold text-slate-400 hover:text-slate-600 uppercase border-l pl-4 border-slate-300 ml-2 tracking-widest">Fermer Dossier</button>}
                    </div>
                  </header>
                  <div className="flex-1 overflow-y-auto">{renderContent()}</div>
                </main>
              </div>
            </ThemeContext.Provider>
          );
        };

        const root = ReactDOM.createRoot(document.getElementById("root"));
        root.render(<App />);
      };

      startApp();
    </script>
  </body> 
</html>
